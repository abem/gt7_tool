<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GT7 Telemetry Dashboard</title>
    <script src="/uplot.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #121829;
            --bg-card: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 255, 255, 0.08);
            --text-primary: #ffffff;
            --text-secondary: #6b7280;
            --accent-green: #00ff88;
            --accent-yellow: #ffd700;
            --accent-red: #ff4444;
            --accent-cyan: #44ffff;
            --accent-orange: #ff8800;

            /* Responsive sizing with clamp() */
            --chart-height: clamp(80px, 11vh, 130px);
            --tyre-temp-size: clamp(16px, 2.2vw, 24px);
            --tyre-pressure-size: clamp(11px, 1.3vw, 14px);
            --speed-size: clamp(32px, 5vw, 48px);
            --gear-size: clamp(24px, 3.5vw, 36px);
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        .dashboard {
            display: grid;
            grid-template-columns: clamp(220px, 18vw, 260px) 1fr clamp(260px, 20vw, 300px);
            grid-template-rows: auto 1fr;
            gap: clamp(8px, 1vh, 12px);
            padding: clamp(8px, 1vh, 12px);
            height: 100vh;
            max-width: 1920px;
            margin: 0 auto;
            overflow: hidden;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 14px;
            background: var(--bg-card);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .header-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: 1px;
        }

        #connection-status {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
        #connection-status.connected {
            background: var(--accent-green);
            color: #000;
        }
        #connection-status.disconnected {
            background: var(--accent-red);
            color: #fff;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            padding: clamp(6px, 1vh, 10px);
            contain: layout style;
        }

        .card-title {
            font-size: 9px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        /* Left Panel */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            overflow-x: hidden;
            contain: content;
        }

        /* Speed */
        .speed-card {
            text-align: center;
            padding: 12px 10px;
        }

        .speed-value {
            font-size: var(--speed-size);
            font-weight: 700;
            color: var(--accent-green);
            line-height: 1;
        }

        .speed-unit {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Gear & RPM */
        .gear-rpm-card {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gear-display {
            text-align: center;
            min-width: 50px;
        }

        .gear-value {
            font-size: var(--gear-size);
            font-weight: 700;
            color: var(--accent-yellow);
            line-height: 1;
        }

        .gear-label {
            font-size: 9px;
            color: var(--text-secondary);
        }

        .rpm-display {
            flex: 1;
        }

        .rpm-bar-bg {
            height: 16px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            overflow: hidden;
        }

        .rpm-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #ffff00, #ff4444);
            border-radius: 8px;
            transition: width 0.05s;
        }

        .rpm-text {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 3px;
        }

        /* Pedals */
        .pedals-card {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .pedal-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pedal-label {
            font-size: 9px;
            color: var(--text-secondary);
            min-width: 45px;
        }

        .pedal-bar-bg {
            flex: 1;
            height: 12px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            overflow: hidden;
        }

        .throttle-bar {
            height: 100%;
            background: linear-gradient(90deg, #00aa44, #00ff88);
            border-radius: 6px;
            transition: width 0.05s;
        }

        .brake-bar {
            height: 100%;
            background: linear-gradient(90deg, #aa0000, #ff4444);
            border-radius: 6px;
            transition: width 0.05s;
        }

        .pedal-value {
            font-size: 10px;
            color: var(--text-primary);
            min-width: 30px;
            text-align: right;
        }

        /* Fuel & Boost */
        .fuel-boost-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .fuel-boost-item {
            text-align: center;
        }

        .fuel-boost-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-green);
        }

        .fuel-boost-value.boost {
            color: var(--accent-orange);
        }

        .fuel-boost-label {
            font-size: 9px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Stat Card */
        .stat-card {
            text-align: center;
            padding: 8px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 8px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Center Panel */
        .center-panel {
            display: flex;
            flex-direction: column;
            gap: clamp(10px, 1.5vh, 16px);
            overflow: hidden;
            min-height: 0;
        }

        /* Course Map */
        .course-map-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: clamp(180px, 35vh, 350px);
            overflow: hidden;
        }

        .course-map-container {
            flex: 1;
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        #course-map {
            width: 100%;
            height: 100%;
            display: block;
        }

        .course-map-info {
            position: absolute;
            top: 6px;
            left: 6px;
            font-size: 9px;
            color: var(--text-secondary);
            background: rgba(0, 0, 0, 0.6);
            padding: 3px 6px;
            border-radius: 3px;
            font-family: 'Segoe UI Mono', monospace;
        }

        .course-map-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 6px;
        }

        .course-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-cyan);
            background: rgba(68, 255, 255, 0.1);
            padding: 3px 8px;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .test-mode-btn {
            font-size: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .test-mode-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            color: var(--accent-yellow);
            border-color: var(--accent-yellow);
        }

        .test-mode-btn.active {
            background: var(--accent-yellow);
            color: #000;
            border-color: var(--accent-yellow);
        }

        .test-mode-indicator {
            font-size: 8px;
            color: var(--accent-yellow);
            background: rgba(255, 215, 0, 0.1);
            padding: 2px 4px;
            border-radius: 2px;
            margin-left: 4px;
        }

        /* Charts */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: clamp(4px, 0.8vw, 8px);
            height: var(--chart-height);
            min-height: 100px;
            max-height: 140px;
            flex-shrink: 0;
        }

        .chart-wrapper {
            background: var(--bg-card);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            padding: 4px 4px 2px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chart-title {
            font-size: clamp(7px, 0.8vw, 9px);
            color: var(--text-secondary);
            margin-bottom: 1px;
            white-space: nowrap;
        }

        .chart {
            flex: 1;
            min-height: 0;
            width: 100%;
        }

        /* Tyres */
        .tyres-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .tyres-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: clamp(8px, 1.5vw, 14px);
            margin-bottom: 12px;
        }

        .tyre-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: clamp(6px, 1vh, 12px) clamp(4px, 0.5vw, 8px);
            text-align: center;
            min-width: 0;
        }

        .tyre-pos {
            font-size: clamp(9px, 1.2vw, 13px);
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .tyre-temp-row, .tyre-pressure-row {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 2px;
            margin-bottom: 4px;
            flex-wrap: wrap;
        }

        .tyre-temp {
            font-size: var(--tyre-temp-size);
            font-weight: 700;
            color: var(--accent-green);
        }

        .tyre-temp-unit {
            font-size: clamp(8px, 1vw, 12px);
            color: var(--text-secondary);
        }

        .tyre-pressure {
            font-size: var(--tyre-pressure-size);
            font-weight: 600;
            color: var(--accent-cyan);
        }

        .tyre-pressure-unit {
            font-size: clamp(8px, 0.9vw, 10px);
            color: var(--text-secondary);
        }

        .tyre-label {
            font-size: clamp(7px, 0.8vw, 9px);
            color: var(--text-secondary);
        }

        /* Suspension */
        .suspension-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: clamp(8px, 1.5vw, 14px);
        }

        .susp-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            padding: 6px 4px;
            text-align: center;
        }

        .susp-pos {
            font-size: 9px;
            color: var(--text-secondary);
        }

        .susp-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .susp-unit {
            font-size: 8px;
            color: var(--text-secondary);
        }

        /* Right Panel */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .right-panel::-webkit-scrollbar {
            width: 4px;
        }

        /* Acceleration Chart */
        .accel-card {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .accel-values {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .accel-value-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .accel-label {
            font-size: 9px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .accel-value {
            font-size: 14px;
            font-weight: 600;
            font-family: 'Segoe UI Mono', monospace;
        }

        #accel-g {
            color: var(--accent-green);
        }

        #accel-decel {
            color: var(--accent-red);
        }

        /* Fuel Consumption */
        .fuel-card {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .fuel-stats {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .fuel-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .fuel-label {
            font-size: 9px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .fuel-value {
            font-size: 14px;
            font-weight: 600;
            font-family: 'Segoe UI Mono', monospace;
            color: var(--accent-orange);
        }

        .fuel-unit {
            font-size: 9px;
            color: var(--text-secondary);
        }

        /* Lap Times */
        .lap-times-card {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .lap-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .lap-row:last-child {
            border-bottom: none;
        }

        .lap-label {
            font-size: 9px;
            color: var(--text-secondary);
        }

        .lap-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-green);
            font-family: 'Segoe UI Mono', monospace;
        }

        /* Delta */
        .delta-card {
            text-align: center;
            padding: 8px;
        }

        .delta-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-green);
        }

        .delta-value.negative {
            color: var(--accent-red);
        }

        .delta-label {
            font-size: 9px;
            color: var(--text-secondary);
        }

        /* Lap History */
        .lap-history-card {
            max-height: clamp(120px, 20vh, 180px);
            overflow-y: auto;
            min-height: 80px;
        }

        .lap-history-list {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .lap-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 6px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            font-size: 10px;
        }

        .lap-history-item.best {
            background: rgba(0, 255, 136, 0.15);
            border: 1px solid var(--accent-green);
        }

        .lap-hist-num {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .lap-hist-time {
            color: var(--accent-green);
            font-weight: 600;
            font-family: 'Segoe UI Mono', monospace;
        }

        .lap-hist-delta {
            font-size: 9px;
        }

        .lap-hist-delta.positive {
            color: var(--accent-red);
        }

        .lap-hist-delta.negative {
            color: var(--accent-green);
        }

        /* Position */
        .position-card {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .position-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
        }

        .position-label {
            color: var(--text-secondary);
        }

        .position-value {
            color: var(--text-primary);
            font-family: 'Segoe UI Mono', monospace;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* uPlot overrides */
        .u-tooltip {
            display: none !important;
        }

        .u-over {
            display: none !important;
        }

        /* Responsive breakpoints */
        /* 1080p optimization (1920x1080) */
        @media (min-width: 1900px) and (max-width: 1950px) and (min-height: 1050px) and (max-height: 1100px) {
            :root {
                --chart-height: 100px;
                --tyre-temp-size: 18px;
                --tyre-pressure-size: 12px;
            }

            .dashboard {
                gap: 8px;
                padding: 8px;
            }
        }

        @media (max-width: 1400px) {
            .dashboard {
                grid-template-columns: 220px 1fr 260px;
                gap: 8px;
                padding: 8px;
            }

            .charts-container {
                gap: 4px;
            }
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 200px 1fr 240px;
            }

            .tyres-grid {
                gap: 4px;
            }
        }

        @media (max-height: 800px) {
            :root {
                --chart-height: 85px;
            }

            .lap-history-card {
                max-height: 110px;
            }

            .tyre-item {
                padding: 6px 4px;
            }

            .card {
                padding: 6px 8px;
            }

            .dashboard {
                gap: 6px;
                padding: 6px;
            }
        }

        /* Extra small height (laptops, small windows) */
        @media (max-height: 700px) {
            :root {
                --chart-height: 70px;
                --tyre-temp-size: 14px;
                --tyre-pressure-size: 10px;
            }

            .charts-container {
                gap: 4px;
            }

            .lap-history-card {
                max-height: 90px;
            }
        }
    </style>
    <link rel="stylesheet" href="/uplot.min.css">
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <span class="header-title">GT7 TELEMETRY DASHBOARD</span>
            <div id="connection-status" class="disconnected">Disconnected</div>
        </div>

        <!-- Left Panel -->
        <div class="left-panel">
            <div class="card speed-card">
                <div class="speed-value" id="speed">0</div>
                <div class="speed-unit">km/h</div>
            </div>

            <div class="card gear-rpm-card">
                <div class="gear-display">
                    <div class="gear-value" id="gear">N</div>
                    <div class="gear-label">GEAR</div>
                </div>
                <div class="rpm-display">
                    <div class="rpm-bar-bg">
                        <div class="rpm-bar" id="rpm-bar"></div>
                    </div>
                    <div class="rpm-text" id="rpm-text">0 RPM</div>
                </div>
            </div>

            <div class="card pedals-card">
                <div class="pedal-row">
                    <span class="pedal-label">THROTTLE</span>
                    <div class="pedal-bar-bg">
                        <div class="throttle-bar" id="throttle-bar"></div>
                    </div>
                    <span class="pedal-value" id="throttle-value">0%</span>
                </div>
                <div class="pedal-row">
                    <span class="pedal-label">BRAKE</span>
                    <div class="pedal-bar-bg">
                        <div class="brake-bar" id="brake-bar"></div>
                    </div>
                    <span class="pedal-value" id="brake-value">0%</span>
                </div>
            </div>

            <div class="card fuel-boost-grid">
                <div class="fuel-boost-item">
                    <div class="fuel-boost-value" id="fuel">--</div>
                    <div class="fuel-boost-label">FUEL (L)</div>
                </div>
                <div class="fuel-boost-item">
                    <div class="fuel-boost-value boost" id="boost">--</div>
                    <div class="fuel-boost-label">BOOST (%)</div>
                </div>
            </div>

            <div class="card stat-card">
                <div class="stat-value" id="max-speed">--</div>
                <div class="stat-label">MAX SPEED (km/h)</div>
            </div>
        </div>

        <!-- Center Panel -->
        <div class="center-panel">
            <div class="charts-container">
                <div class="chart-wrapper">
                    <div class="chart-title">SPEED</div>
                    <div id="speed-chart" class="chart"></div>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-title">RPM</div>
                    <div id="rpm-chart" class="chart"></div>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-title">THROTTLE</div>
                    <div id="throttle-chart" class="chart"></div>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-title">BRAKE</div>
                    <div id="brake-chart" class="chart"></div>
                </div>
            </div>

            <div class="card course-map-card">
                <div class="course-map-header">
                    <div class="card-title">COURSE MAP</div>
                    <div id="course-name" class="course-name">Unknown Track</div>
                    <button id="test-mode-btn" class="test-mode-btn">TEST MODE</button>
                </div>
                <div class="course-map-container">
                    <canvas id="course-map"></canvas>
                    <div class="course-map-info" id="course-map-info">Waiting for data...</div>
                </div>
            </div>

            <div class="card tyres-card">
                <div class="card-title">TYRES</div>
                <div class="tyres-grid">
                    <div class="tyre-item">
                        <div class="tyre-pos">FL</div>
                        <div class="tyre-temp-row">
                            <span class="tyre-temp" id="fl-temp">--</span>
                            <span class="tyre-temp-unit">°C</span>
                        </div>
                        <div class="tyre-pressure-row">
                            <span class="tyre-pressure" id="fl-pressure">--</span>
                            <span class="tyre-pressure-unit">bar</span>
                        </div>
                        <div class="tyre-label">TEMP</div>
                    </div>
                    <div class="tyre-item">
                        <div class="tyre-pos">FR</div>
                        <div class="tyre-temp-row">
                            <span class="tyre-temp" id="fr-temp">--</span>
                            <span class="tyre-temp-unit">°C</span>
                        </div>
                        <div class="tyre-pressure-row">
                            <span class="tyre-pressure" id="fr-pressure">--</span>
                            <span class="tyre-pressure-unit">bar</span>
                        </div>
                        <div class="tyre-label">TEMP</div>
                    </div>
                    <div class="tyre-item">
                        <div class="tyre-pos">RL</div>
                        <div class="tyre-temp-row">
                            <span class="tyre-temp" id="rl-temp">--</span>
                            <span class="tyre-temp-unit">°C</span>
                        </div>
                        <div class="tyre-pressure-row">
                            <span class="tyre-pressure" id="rl-pressure">--</span>
                            <span class="tyre-pressure-unit">bar</span>
                        </div>
                        <div class="tyre-label">TEMP</div>
                    </div>
                    <div class="tyre-item">
                        <div class="tyre-pos">RR</div>
                        <div class="tyre-temp-row">
                            <span class="tyre-temp" id="rr-temp">--</span>
                            <span class="tyre-temp-unit">°C</span>
                        </div>
                        <div class="tyre-pressure-row">
                            <span class="tyre-pressure" id="rr-pressure">--</span>
                            <span class="tyre-pressure-unit">bar</span>
                        </div>
                        <div class="tyre-label">TEMP</div>
                    </div>
                </div>
                <div class="card-title" style="margin-top: 4px;">SUSPENSION</div>
                <div class="suspension-grid">
                    <div class="susp-item">
                        <div class="susp-pos">FL</div>
                        <div class="susp-value" id="fl-susp">--</div>
                        <div class="susp-unit">mm</div>
                    </div>
                    <div class="susp-item">
                        <div class="susp-pos">FR</div>
                        <div class="susp-value" id="fr-susp">--</div>
                        <div class="susp-unit">mm</div>
                    </div>
                    <div class="susp-item">
                        <div class="susp-pos">RL</div>
                        <div class="susp-value" id="rl-susp">--</div>
                        <div class="susp-unit">mm</div>
                    </div>
                    <div class="susp-item">
                        <div class="susp-pos">RR</div>
                        <div class="susp-value" id="rr-susp">--</div>
                        <div class="susp-unit">mm</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <div class="card lap-times-card">
                <div class="lap-row">
                    <span class="lap-label">LAP</span>
                    <span class="lap-value" id="current-lap">--</span>
                </div>
                <div class="lap-row">
                    <span class="lap-label">CURRENT</span>
                    <span class="lap-value" id="current-lap-time">--:--.---</span>
                </div>
                <div class="lap-row">
                    <span class="lap-label">BEST</span>
                    <span class="lap-value" id="best-lap-time">--:--.---</span>
                </div>
            </div>

            <div class="card delta-card">
                <div class="delta-value" id="lap-delta">--</div>
                <div class="delta-label">DELTA VS BEST</div>
            </div>

            <div class="card lap-history-card">
                <div class="card-title">LAP HISTORY</div>
                <div id="lap-list" class="lap-history-list"></div>
            </div>

            <div class="card position-card">
                <div class="card-title">POSITION</div>
                <div class="position-row">
                    <span class="position-label">X</span>
                    <span class="position-value" id="pos-x">--</span>
                </div>
                <div class="position-row">
                    <span class="position-label">Y</span>
                    <span class="position-value" id="pos-y">--</span>
                </div>
                <div class="position-row">
                    <span class="position-label">Z</span>
                    <span class="position-value" id="pos-z">--</span>
                </div>
            </div>

            <div class="card stat-card">
                <div class="stat-value" id="course-name" style="font-size: 12px; line-height: 1.3;">--</div>
                <div class="stat-label">COURSE</div>
            </div>

            <div class="card accel-card">
                <div class="card-title">ACCELERATION (G)</div>
                <div class="accel-values">
                    <div class="accel-value-row">
                        <span class="accel-label">ACCEL</span>
                        <span class="accel-value" id="accel-g">0.00</span>
                    </div>
                    <div class="accel-value-row">
                        <span class="accel-label">DECEL</span>
                        <span class="accel-value" id="accel-decel">0.00</span>
                    </div>
                </div>
                <div class="chart">
                    <canvas id="accel-chart"></canvas>
                </div>
            </div>
            <div class="card fuel-card">
                <div class="card-title">FUEL CONSUMPTION</div>
                <div class="fuel-stats">
                    <div class="fuel-stat-row">
                        <span class="fuel-label">USED</span>
                        <span class="fuel-value" id="fuel-used">--</span>
                        <span class="fuel-unit">L</span>
                    </div>
                    <div class="fuel-stat-row">
                        <span class="fuel-label">PER LAP</span>
                        <span class="fuel-value" id="fuel-per-lap">--</span>
                        <span class="fuel-unit">L</span>
                    </div>
                    <div class="fuel-stat-row">
                        <span class="fuel-label">RATE</span>
                        <span class="fuel-value" id="fuel-rate">--</span>
                        <span class="fuel-unit">%</span>
                    </div>
                    <div class="fuel-stat-row">
                        <span class="fuel-label">REMAINING</span>
                        <span class="fuel-value" id="fuel-remaining">--</span>
                        <span class="fuel-unit">LAPS</span>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="card stat-card">
                    <div class="stat-value" id="car-id">--</div>
                    <div class="stat-label">CAR ID</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="packets">0</div>
                    <div class="stat-label">PACKETS</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DEBUG_MODE = false;

        // Course Map Configuration
        const COURSE_MAP_CONFIG = {
            maxTrajectoryPoints: 1000,
            trajectorySampleInterval: 3,
            colors: {
                car: '#00ff88',
                trajectoryLow: '#ff4444',
                trajectoryMid: '#ffff00',
                trajectoryHigh: '#00ff88',
                grid: 'rgba(255, 255, 255, 0.05)',
                text: '#6b7280'
            }
        };

        // Course Map State
        let courseMapState = {
            trajectory: [],
            currentPosition: { x: 0, y: 0, z: 0 },
            bounds: { minX: 0, maxX: 0, minZ: 0, maxZ: 0 },
            initialized: false,
            canvas: null,
            ctx: null,
            sampleCount: 0,
            courseDatabase: null,
            currentCourseBounds: null
        };

        async function loadCourseDatabase() {
            try {
                const response = await fetch('/course_database.json');
                if (response.ok) {
                    const data = await response.json();
                    courseMapState.courseDatabase = data;
                    debugLog('COURSE_DB', 'Loaded', {
                        courses: data.courses?.length || 0,
                        known_courses: data.known_courses?.length || 0
                    });
                }
            } catch (e) {
                console.error('[COURSE_DB] Failed to load:', e);
            }
        }

        function initCourseMap() {
            const canvas = document.getElementById('course-map');
            if (!canvas) {
                console.error('[COURSE_MAP] Canvas element not found');
                return;
            }

            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;

            courseMapState.canvas = canvas;
            courseMapState.ctx = canvas.getContext('2d');

            // Handle resize
            const resizeObserver = new ResizeObserver(() => {
                if (canvas && container) {
                    canvas.width = container.clientWidth;
                    canvas.height = container.clientHeight;
                }
            });
            resizeObserver.observe(container);

            // Load course database
            loadCourseDatabase();

            debugLog('COURSE_MAP', 'Initialized', { width: canvas.width, height: canvas.height });
        }

        function drawAccelChart() {
            const canvas = elements.accelChart;
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            const width = canvas.width = canvas.clientWidth;
            const height = canvas.height = canvas.clientHeight;

            // Clear canvas
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, width, height);

            const maxDataPoints = Math.max(accelData.accelG.length, accelData.accelDecel.length);
            const stepX = width / Math.max(maxDataPoints - 1, 1);

            // Draw grid lines
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, height / 2);
            ctx.lineTo(width, height / 2);
            ctx.stroke();

            // Draw accel G line (green)
            ctx.strokeStyle = '#00ff88';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < accelData.accelG.length; i++) {
                const x = i * stepX;
                const y = height / 2 - (accelData.accelG[i] / 2) * (height / 2);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Draw decel G line (red)
            ctx.strokeStyle = '#ff4444';
            ctx.beginPath();
            for (let i = 0; i < accelData.accelDecel.length; i++) {
                const x = i * stepX;
                const y = height / 2 - (accelData.accelDecel[i] / 2) * (height / 2);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Draw text values
            ctx.fillStyle = '#ffffff';
            ctx.font = '12px sans-serif';
            const lastAccelG = accelData.accelG[accelData.accelG.length - 1] || 0;
            const lastAccelDecel = accelData.accelDecel[accelData.accelDecel.length - 1] || 0;
            ctx.textAlign = 'right';
            ctx.fillStyle = '#00ff88';
            ctx.fillText(`ACCEL: ${lastAccelG.toFixed(2)} G`, width - 10, 20);
            ctx.textAlign = 'left';
            ctx.fillStyle = '#ff4444';
            ctx.fillText(`DECEL: ${lastAccelDecel.toFixed(2)} G`, 10, 20);
        }

        function updateAccelChart(accelG, accelDecel) {
            if (accelG !== undefined) {
                accelData.accelG.push(accelG);
                if (accelData.accelG.length > ACCEL_CHART_CONFIG.maxPoints) {
                    accelData.accelG.shift();
                }
            }
            if (accelDecel !== undefined) {
                accelData.accelDecel.push(accelDecel);
                if (accelData.accelDecel.length > ACCEL_CHART_CONFIG.maxPoints) {
                    accelData.accelDecel.shift();
                }
            }

            drawAccelChart();
        }

        function updateCourseMapBounds(x, z) {
            if (!courseMapState.initialized) {
                courseMapState.bounds = {
                    minX: x - 50,
                    maxX: x + 50,
                    minZ: z - 50,
                    maxZ: z + 50
                };
                courseMapState.initialized = true;
            } else {
                const padding = 20;
                courseMapState.bounds.minX = Math.min(courseMapState.bounds.minX, x - padding);
                courseMapState.bounds.maxX = Math.max(courseMapState.bounds.maxX, x + padding);
                courseMapState.bounds.minZ = Math.min(courseMapState.bounds.minZ, z - padding);
                courseMapState.bounds.maxZ = Math.max(courseMapState.bounds.maxZ, z + padding);
            }
        }

        function findCourseBounds(courseId) {
            if (!courseMapState.courseDatabase) return null;

            // Check known_courses first
            if (courseMapState.courseDatabase.known_courses) {
                for (const course of courseMapState.courseDatabase.known_courses) {
                    if (course.id === courseId) {
                        return course.bounds;
                    }
                }
            }

            // Check courses
            if (courseMapState.courseDatabase.courses) {
                for (const course of courseMapState.courseDatabase.courses) {
                    if (course.id === courseId) {
                        return course.bounds;
                    }
                }
            }

            return null;
        }

        function updateCourseBounds(courseId) {
            const bounds = findCourseBounds(courseId);
            if (bounds) {
                courseMapState.currentCourseBounds = bounds;
                // Use course bounds as the map bounds for better visualization
                courseMapState.bounds = {
                    minX: bounds.min_x,
                    maxX: bounds.max_x,
                    minZ: bounds.min_z,
                    maxZ: bounds.max_z
                };
                debugLog('COURSE_MAP', 'Using course bounds', bounds);
            }
        }

        function gameToCanvas(x, z) {
            const bounds = courseMapState.bounds;
            const canvas = courseMapState.canvas;
            if (!canvas) return { x: 0, y: 0 };

            const rangeX = bounds.maxX - bounds.minX || 1;
            const rangeZ = bounds.maxZ - bounds.minZ || 1;

            // Calculate scale to fit canvas with padding
            const padding = 30;
            const availableWidth = canvas.width - 2 * padding;
            const availableHeight = canvas.height - 2 * padding;

            const scaleX = availableWidth / rangeX;
            const scaleZ = availableHeight / rangeZ;
            const scale = Math.min(scaleX, scaleZ);

            // Center the map
            const offsetX = padding + (availableWidth - rangeX * scale) / 2;
            const offsetY = padding + (availableHeight - rangeZ * scale) / 2;

            return {
                x: offsetX + (x - bounds.minX) * scale,
                y: offsetY + (z - bounds.minZ) * scale
            };
        }

        function getSpeedColor(speed) {
            if (speed < 60) return COURSE_MAP_CONFIG.colors.trajectoryLow;
            if (speed < 120) return COURSE_MAP_CONFIG.colors.trajectoryMid;
            return COURSE_MAP_CONFIG.colors.trajectoryHigh;
        }

        function drawCourseMap() {
            const ctx = courseMapState.ctx;
            const canvas = courseMapState.canvas;
            if (!ctx || !canvas) return;

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw grid
            ctx.strokeStyle = COURSE_MAP_CONFIG.colors.grid;
            ctx.lineWidth = 1;
            const gridSize = 50;
            for (let x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }

            // Draw course bounds rectangle if available
            if (courseMapState.currentCourseBounds && courseMapState.initialized) {
                const bounds = courseMapState.currentCourseBounds;
                const topLeft = gameToCanvas(bounds.min_x, bounds.min_z);
                const bottomRight = gameToCanvas(bounds.max_x, bounds.max_z);

                // Draw bounds rectangle
                ctx.strokeStyle = 'rgba(68, 255, 255, 0.4)';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.strokeRect(
                    topLeft.x,
                    topLeft.y,
                    bottomRight.x - topLeft.x,
                    bottomRight.y - topLeft.y
                );
                ctx.setLineDash([]);

                // Fill with transparent color
                ctx.fillStyle = 'rgba(68, 255, 255, 0.05)';
                ctx.fillRect(
                    topLeft.x,
                    topLeft.y,
                    bottomRight.x - topLeft.x,
                    bottomRight.y - topLeft.y
                );
            }

            if (!courseMapState.initialized) {
                ctx.fillStyle = COURSE_MAP_CONFIG.colors.text;
                ctx.font = '12px "Segoe UI Mono", monospace';
                ctx.textAlign = 'center';
                ctx.fillText('Waiting for position data...', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Draw trajectory
            if (courseMapState.trajectory.length > 1) {
                for (let i = 1; i < courseMapState.trajectory.length; i++) {
                    const prev = courseMapState.trajectory[i - 1];
                    const curr = courseMapState.trajectory[i];
                    const prevCanvas = gameToCanvas(prev.x, prev.z);
                    const currCanvas = gameToCanvas(curr.x, curr.z);

                    ctx.beginPath();
                    ctx.moveTo(prevCanvas.x, prevCanvas.y);
                    ctx.lineTo(currCanvas.x, currCanvas.y);
                    ctx.strokeStyle = getSpeedColor(curr.speed);
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }

            // Draw car position
            const carPos = gameToCanvas(
                courseMapState.currentPosition.x,
                courseMapState.currentPosition.z
            );

            // Car glow
            const gradient = ctx.createRadialGradient(carPos.x, carPos.y, 0, carPos.x, carPos.y, 15);
            gradient.addColorStop(0, 'rgba(0, 255, 136, 0.5)');
            gradient.addColorStop(1, 'rgba(0, 255, 136, 0)');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(carPos.x, carPos.y, 15, 0, Math.PI * 2);
            ctx.fill();

            // Car marker
            ctx.fillStyle = COURSE_MAP_CONFIG.colors.car;
            ctx.beginPath();
            ctx.arc(carPos.x, carPos.y, 6, 0, Math.PI * 2);
            ctx.fill();

            // Update info display
            const infoEl = document.getElementById('course-map-info');
            if (infoEl) {
                const rangeX = (courseMapState.bounds.maxX - courseMapState.bounds.minX).toFixed(0);
                const rangeZ = (courseMapState.bounds.maxZ - courseMapState.bounds.minZ).toFixed(0);
                const courseLabel = currentCourseName !== '--' ? ` | ${currentCourseName}` : '';
                infoEl.textContent = `X: ${courseMapState.currentPosition.x.toFixed(1)} Z: ${courseMapState.currentPosition.z.toFixed(1)} | Range: ${rangeX}m × ${rangeZ}m${courseLabel}`;
            }
        }

        function updateCourseMap(positionX, positionY, positionZ, speed) {
            courseMapState.currentPosition = { x: positionX, y: positionY, z: positionZ };
            updateCourseMapBounds(positionX, positionZ);

            courseMapState.sampleCount++;
            if (courseMapState.sampleCount % COURSE_MAP_CONFIG.trajectorySampleInterval === 0) {
                courseMapState.trajectory.push({
                    x: positionX,
                    z: positionZ,
                    speed: speed,
                    timestamp: Date.now()
                });

                // Limit trajectory size
                if (courseMapState.trajectory.length > COURSE_MAP_CONFIG.maxTrajectoryPoints) {
                    courseMapState.trajectory.shift();
                }
            }

            drawCourseMap();
        }

        function debugLog(category, message, ...args) {
            if (DEBUG_MODE) {
                console.log(`[${category}]`, message, ...args);
            }
        }

        debugLog('INIT', 'GT7 Telemetry Dashboard loaded');

        if (typeof uPlot === 'undefined') {
            console.error('[CRITICAL] uPlot library not loaded!');
        }

        const CHART_POINTS = 1200;
        let timeCounter = 0;

        window.timeData = new Array(CHART_POINTS).fill(0);
        window.speedData = new Array(CHART_POINTS).fill(0);
        window.rpmData = new Array(CHART_POINTS).fill(0);
        window.throttleData = new Array(CHART_POINTS).fill(0);
        window.brakeData = new Array(CHART_POINTS).fill(0);

        const chartOptions = {
            width: 200,
            height: 100,
            pxAlign: 0,
            pxSnap: true,
            plugins: [],
            scales: {
                x: { time: false, min: 0, max: CHART_POINTS - 1 },
                y: { auto: true }
            },
            axes: [
                { show: false },
                { show: false }
            ],
            series: [{}, { stroke: '#00ff88', width: 1.5, fill: 'rgba(0, 255, 136, 0.1)' }],
            cursor: { show: false },
            legend: { show: false },
            padding: [0, 0, 0, 0],
            points: { show: false }
        };

        window.speedChart = null;
        window.rpmChart = null;
        window.throttleChart = null;
        window.brakeChart = null;

        function initCharts() {
            const chartElements = {
                'speed-chart': document.getElementById('speed-chart'),
                'rpm-chart': document.getElementById('rpm-chart'),
                'throttle-chart': document.getElementById('throttle-chart'),
                'brake-chart': document.getElementById('brake-chart')
            };

            try {
                window.speedChart = new uPlot(
                    { ...chartOptions, series: [{}, { stroke: '#00ff88', width: 1.5, fill: 'rgba(0, 255, 136, 0.1)' }] },
                    [window.timeData, window.speedData],
                    chartElements['speed-chart']
                );

                window.rpmChart = new uPlot(
                    { ...chartOptions, series: [{}, { stroke: '#ffd700', width: 1.5, fill: 'rgba(255, 215, 0, 0.1)' }] },
                    [window.timeData, window.rpmData],
                    chartElements['rpm-chart']
                );

                window.throttleChart = new uPlot(
                    { ...chartOptions, series: [{}, { stroke: '#00ff88', width: 1.5, fill: 'rgba(0, 255, 136, 0.15)', scales: { y: { min: 0, max: 100 } } }] },
                    [window.timeData, window.throttleData],
                    chartElements['throttle-chart']
                );

                window.brakeChart = new uPlot(
                    { ...chartOptions, series: [{}, { stroke: '#ff4444', width: 1.5, fill: 'rgba(255, 68, 68, 0.15)', scales: { y: { min: 0, max: 100 } } }] },
                    [window.timeData, window.brakeData],
                    chartElements['brake-chart']
                );

                // Debounced resize handler for better performance
                let resizeTimeout;
                const resizeCharts = () => {
                    const ids = ['speed-chart', 'rpm-chart', 'throttle-chart', 'brake-chart'];
                    const charts = [window.speedChart, window.rpmChart, window.throttleChart, window.brakeChart];
                    ids.forEach((id, i) => {
                        const el = document.getElementById(id);
                        if (el && charts[i]) {
                            const rect = el.getBoundingClientRect();
                            charts[i].setSize({ width: rect.width, height: rect.height });
                        }
                    });
                };

                const debouncedResize = () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(resizeCharts, 100);
                };

                window.addEventListener('resize', debouncedResize);
                // Use ResizeObserver for more responsive chart sizing
                const resizeObserver = new ResizeObserver(debouncedResize);
                Object.values(chartElements).forEach(el => {
                    if (el) resizeObserver.observe(el);
                });

                setTimeout(resizeCharts, 50);
                setTimeout(resizeCharts, 200);

            } catch (e) {
                console.error('[CHART] Error:', e);
            }

            // Initialize acceleration chart
            if (elements.accelChart) {
                elements.accelChart.width = elements.accelChart.clientWidth;
                elements.accelChart.height = elements.accelChart.clientHeight;
            }
            drawAccelChart();
        }

        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws`;

        const ws = new WebSocket(wsUrl);
        const statusEl = document.getElementById('connection-status');

        let packetCount = 0;
        let maxSpeed = 0;
        let currentLapNumber = 0;
        let lastLapNumber = 0;
        let bestLapTime = Infinity;
        let bestLapNumber = 0;
        let lapTimes = [];
        let currentLapData = [];
        let bestLapData = [];

        // Acceleration chart data
        const ACCEL_CHART_CONFIG = {
            maxPoints: 200,
            lineColor: '#00ff88',
            lineWidth: 2
        };
        let accelData = {
            accelG: new Array(ACCEL_CHART_CONFIG.maxPoints).fill(0),
            accelDecel: new Array(ACCEL_CHART_CONFIG.maxPoints).fill(0)
        };

        // Acceleration chart data
        const ACCEL_CHART_CONFIG = {
            maxPoints: 200,
            lineColor: '#00ff88',
            lineWidth: 2
        };
        let accelData = {
            accelG: new Array(ACCEL_CHART_CONFIG.maxPoints).fill(0),
            accelDecel: new Array(ACCEL_CHART_CONFIG.maxPoints).fill(0)
        };

        const elements = {
            speed: document.getElementById('speed'),
            gear: document.getElementById('gear'),
            rpmBar: document.getElementById('rpm-bar'),
            rpmText: document.getElementById('rpm-text'),
            throttleBar: document.getElementById('throttle-bar'),
            throttleValue: document.getElementById('throttle-value'),
            brakeBar: document.getElementById('brake-bar'),
            brakeValue: document.getElementById('brake-value'),
            fuel: document.getElementById('fuel'),
            boost: document.getElementById('boost'),
            fuelUsed: document.getElementById('fuel-used'),
            fuelPerLap: document.getElementById('fuel-per-lap'),
            fuelRate: document.getElementById('fuel-rate'),
            fuelRemaining: document.getElementById('fuel-remaining'),
            maxX: document.getElementById('pos-x'),
            maxY: document.getElementById('pos-y'),
            maxZ: document.getElementById('pos-z'),
            flTemp: document.getElementById('fl-temp'),
            frTemp: document.getElementById('fr-temp'),
            rlTemp: document.getElementById('rl-temp'),
            rrTemp: document.getElementById('rr-temp'),
            flPressure: document.getElementById('fl-pressure'),
            frPressure: document.getElementById('fr-pressure'),
            rlPressure: document.getElementById('rl-pressure'),
            rrPressure: document.getElementById('rr-pressure'),
            flSusp: document.getElementById('fl-susp'),
            frSusp: document.getElementById('fr-susp'),
            rlSusp: document.getElementById('rl-susp'),
            rrSusp: document.getElementById('rr-susp'),
            maxSpeed: document.getElementById('max-speed'),
            carId: document.getElementById('car-id'),
            packets: document.getElementById('packets'),
            currentLap: document.getElementById('current-lap'),
            currentLapTime: document.getElementById('current-lap-time'),
            bestLapTime: document.getElementById('best-lap-time'),
            lapDelta: document.getElementById('lap-delta'),
            lapList: document.getElementById('lap-list'),
            courseName: document.getElementById('course-name'),
            accelChart: document.getElementById('accel-chart'),
            accelG: document.getElementById('accel-g'),
            accelDecel: document.getElementById('accel-decel')
        };

        // Course name tracking
        let currentCourseName = '--';

        function formatLapTime(ms) {
            if (ms === -1 || ms === undefined || ms === null) return '--:--.---';
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            const millis = ms % 1000;
            return `${minutes}:${seconds.toString().padStart(2, '0')}.${millis.toString().padStart(3, '0')}`;
        }

        function getTyreTempColor(temp) {
            if (temp < 40) return '#44ffff';
            if (temp < 80) return '#00ff88';
            if (temp < 100) return '#ffff00';
            return '#ff4444';
        }

        function updateLapList() {
            elements.lapList.innerHTML = '';
            lapTimes.forEach(lap => {
                const item = document.createElement('div');
                item.className = 'lap-history-item' + (lap.number === bestLapNumber ? ' best' : '');
                const delta = lap.time - bestLapTime;
                const deltaSign = delta > 0 ? '+' : '';
                const deltaClass = delta < 0 ? 'negative' : 'positive';
                item.innerHTML = `
                    <span class="lap-hist-num">L${lap.number}</span>
                    <span class="lap-hist-time">${formatLapTime(lap.time)}</span>
                    <span class="lap-hist-delta ${deltaClass}">${deltaSign}${(delta / 1000).toFixed(3)}</span>
                `;
                elements.lapList.appendChild(item);
            });
        }

        function addLapData(lapNumber, lapTime) {
            const idx = lapTimes.findIndex(l => l.number === lapNumber);
            if (idx >= 0) {
                lapTimes[idx] = { number: lapNumber, time: lapTime };
            } else {
                lapTimes.push({ number: lapNumber, time: lapTime });
            }
            if (lapTime > 0 && lapTime < bestLapTime) {
                bestLapTime = lapTime;
                bestLapNumber = lapNumber;
                bestLapData = [...currentLapData];
            }
            updateLapList();
            elements.bestLapTime.textContent = formatLapTime(bestLapTime);
        }

        ws.onopen = () => {
            console.log('Connected to GT7 Bridge');
            statusEl.textContent = 'Connected';
            statusEl.className = 'connected';
            initCharts();
            initCourseMap();
        };

        // Test Mode - Demo data without PS5
        let testModeActive = false;
        let testModeInterval = null;
        let testTrajectoryIndex = 0;
        let testModeTimeCounter = 0;
        let testModeLapTime = 0;
        let testModeLastLapTime = 95000; // 1:35.000
        let testModeCurrentLap = 1;

        // ============================================
        // TEST MODE - SUZUKA CIRCUIT DEMO TRAJECTORY
        // ============================================
        // Based on actual Suzuka Circuit layout with realistic
        // corner sequences, speed variations, and gear changes.
        // The circuit includes famous sections: Degner Curve,
        // Hairpin, Spoon Curve, 130R, and the Casio Triangle.
        // ============================================

        const SUZUKA_DEMO_TRAJECTORY = [
            // Start/Finish straight (high speed section)
            {x: 0, z: -300, speed: 280, gear: 6, rpm: 8500, throttle: 100, brake: 0, sector: 1},
            {x: 80, z: -280, speed: 285, gear: 6, rpm: 8800, throttle: 100, brake: 0, sector: 1},
            {x: 150, z: -240, speed: 275, gear: 6, rpm: 8600, throttle: 100, brake: 0, sector: 1},
            {x: 210, z: -180, speed: 265, gear: 6, rpm: 8400, throttle: 100, brake: 0, sector: 1},
            // Turn 1 - First corner (medium speed, braking zone)
            {x: 260, z: -100, speed: 180, gear: 4, rpm: 7200, throttle: 30, brake: 60, sector: 1},
            {x: 280, z: -20, speed: 140, gear: 3, rpm: 5800, throttle: 40, brake: 20, sector: 1},
            {x: 270, z: 60, speed: 155, gear: 4, rpm: 6200, throttle: 70, brake: 0, sector: 1},
            {x: 230, z: 120, speed: 170, gear: 4, rpm: 6800, throttle: 85, brake: 0, sector: 1},
            // The "S" curves - Degner 1 & 2 (complex left-right transitions)
            {x: 170, z: 160, speed: 145, gear: 4, rpm: 6100, throttle: 60, brake: 10, sector: 1},
            {x: 110, z: 180, speed: 130, gear: 3, rpm: 5600, throttle: 50, brake: 15, sector: 1},
            {x: 60, z: 175, speed: 140, gear: 4, rpm: 5900, throttle: 70, brake: 0, sector: 1},
            {x: 20, z: 155, speed: 150, gear: 4, rpm: 6300, throttle: 80, brake: 0, sector: 1},
            // Degner Curve (right-left chicane)
            {x: -25, z: 120, speed: 135, gear: 3, rpm: 5700, throttle: 55, brake: 10, sector: 1},
            {x: -55, z: 80, speed: 125, gear: 3, rpm: 5300, throttle: 45, brake: 15, sector: 1},
            {x: -65, z: 40, speed: 140, gear: 4, rpm: 5900, throttle: 75, brake: 0, sector: 1},
            // Back straight leading to Hairpin
            {x: -50, z: -20, speed: 200, gear: 5, rpm: 7800, throttle: 100, brake: 0, sector: 2},
            {x: -10, z: -80, speed: 230, gear: 5, rpm: 8200, throttle: 100, brake: 0, sector: 2},
            {x: 40, z: -130, speed: 245, gear: 6, rpm: 8500, throttle: 100, brake: 0, sector: 2},
            {x: 90, z: -165, speed: 250, gear: 6, rpm: 8600, throttle: 100, brake: 0, sector: 2},
            // Hairpin (heavy braking zone)
            {x: 110, z: -190, speed: 155, gear: 3, rpm: 6200, throttle: 20, brake: 80, sector: 2},
            {x: 100, z: -210, speed: 85, gear: 2, rpm: 4200, throttle: 30, brake: 40, sector: 2},
            {x: 70, z: -215, speed: 75, gear: 2, rpm: 3800, throttle: 50, brake: 0, sector: 2},
            {x: 40, z: -205, speed: 95, gear: 2, rpm: 4500, throttle: 80, brake: 0, sector: 2},
            // Exit from Hairpin
            {x: 10, z: -180, speed: 140, gear: 4, rpm: 5800, throttle: 100, brake: 0, sector: 2},
            {x: -30, z: -145, speed: 180, gear: 4, rpm: 7200, throttle: 100, brake: 0, sector: 2},
            {x: -80, z: -100, speed: 210, gear: 5, rpm: 7800, throttle: 100, brake: 0, sector: 2},
            // Spoon Curve approach (high speed section)
            {x: -130, z: -70, speed: 225, gear: 5, rpm: 8200, throttle: 100, brake: 0, sector: 2},
            {x: -180, z: -50, speed: 215, gear: 5, rpm: 8000, throttle: 95, brake: 0, sector: 2},
            // Spoon Curve (double apex left-hander)
            {x: -220, z: -40, speed: 160, gear: 4, rpm: 6800, throttle: 40, brake: 50, sector: 2},
            {x: -245, z: -30, speed: 135, gear: 3, rpm: 5700, throttle: 45, brake: 20, sector: 2},
            {x: -260, z: -10, speed: 145, gear: 4, rpm: 6000, throttle: 70, brake: 0, sector: 2},
            {x: -255, z: 20, speed: 155, gear: 4, rpm: 6400, throttle: 80, brake: 0, sector: 2},
            // Exit from Spoon Curve
            {x: -230, z: 50, speed: 190, gear: 5, rpm: 7400, throttle: 100, brake: 0, sector: 3},
            {x: -195, z: 90, speed: 220, gear: 5, rpm: 8100, throttle: 100, brake: 0, sector: 3},
            {x: -150, z: 130, speed: 240, gear: 6, rpm: 8500, throttle: 100, brake: 0, sector: 3},
            {x: -100, z: 160, speed: 255, gear: 6, rpm: 8700, throttle: 100, brake: 0, sector: 3},
            // 130R approach (the legendary fast corner)
            {x: -50, z: 180, speed: 265, gear: 6, rpm: 8800, throttle: 100, brake: 0, sector: 3},
            {x: 10, z: 195, speed: 270, gear: 6, rpm: 8900, throttle: 100, brake: 0, sector: 3},
            // 130R (very high speed right-hander)
            {x: 70, z: 200, speed: 245, gear: 6, rpm: 8400, throttle: 85, brake: 20, sector: 3},
            {x: 130, z: 190, speed: 230, gear: 5, rpm: 8000, throttle: 75, brake: 10, sector: 3},
            {x: 185, z: 165, speed: 245, gear: 6, rpm: 8300, throttle: 95, brake: 0, sector: 3},
            // Casio Triangle (final chicane)
            {x: 235, z: 125, speed: 180, gear: 4, rpm: 7200, throttle: 30, brake: 65, sector: 3},
            {x: 260, z: 85, speed: 120, gear: 3, rpm: 5100, throttle: 25, brake: 35, sector: 3},
            {x: 265, z: 45, speed: 95, gear: 2, rpm: 4200, throttle: 40, brake: 15, sector: 3},
            {x: 250, z: 10, speed: 110, gear: 3, rpm: 4700, throttle: 70, brake: 0, sector: 3},
            {x: 220, z: -20, speed: 150, gear: 4, rpm: 6200, throttle: 100, brake: 0, sector: 3},
            // Final approach to Start/Finish
            {x: 170, z: -50, speed: 200, gear: 5, rpm: 7600, throttle: 100, brake: 0, sector: 3},
            {x: 110, z: -80, speed: 230, gear: 5, rpm: 8200, throttle: 100, brake: 0, sector: 3},
            {x: 50, z: -110, speed: 255, gear: 6, rpm: 8600, throttle: 100, brake: 0, sector: 3},
            {x: 0, z: -150, speed: 270, gear: 6, rpm: 8800, throttle: 100, brake: 0, sector: 3},
            {x: -30, z: -200, speed: 275, gear: 6, rpm: 8900, throttle: 100, brake: 0, sector: 3},
            {x: -20, z: -260, speed: 280, gear: 6, rpm: 9000, throttle: 100, brake: 0, sector: 3},
            // Complete lap
            {x: 20, z: -290, speed: 282, gear: 6, rpm: 9000, throttle: 100, brake: 0, sector: 1}
        ];

        // Demo trajectory fallback for smoother interpolation
        const demoTrajectory = SUZUKA_DEMO_TRAJECTORY;

        // ============================================
        // TEST MODE HELPER FUNCTIONS
        // ============================================

        /**
         * Generate realistic tyre temperature based on driving conditions
         * @param {number} baseTemp - Base temperature
         * @param {number} variation - Temperature variation range
         * @param {number} speed - Current speed for load calculation
         * @param {number} lateralG - Lateral G-force (estimated from corner)
         * @returns {number} Calculated tyre temperature
         */
        function generateDemoTyreTemp(baseTemp, variation, speed = 150, lateralG = 0) {
            // Temperature increases with speed and lateral load
            const speedFactor = speed / 280; // Normalized speed factor
            const loadFactor = 1 + (lateralG * 0.1); // Load increases temperature
            const calculatedTemp = baseTemp * speedFactor * loadFactor;

            // Add realistic variation
            return calculatedTemp + (Math.random() - 0.5) * variation;
        }

        /**
         * Generate realistic suspension height
         * @param {number} baseHeight - Base suspension height
         * @param {number} compression - Brake compression effect
         * @param {number} acceleration - Acceleration squat effect
         * @param {number} speed - Speed for aero downforce effect
         * @returns {number} Calculated suspension height
         */
        function generateDemoSuspension(baseHeight, compression = 0, acceleration = 0, speed = 150) {
            // Aero downforce lowers suspension at speed (approximately 5mm at 280 km/h)
            const aeroCompression = (speed / 280) * 5;

            // Total compression
            const totalCompression = compression + acceleration + aeroCompression;

            // Add realistic variation
            return baseHeight - totalCompression + (Math.random() - 0.5) * 3;
        }

        /**
         * Get lateral G-force estimate based on speed and sector
         * @param {number} speed - Current speed
         * @param {number} throttle - Throttle percentage
         * @param {number} brake - Brake percentage
         * @param {number} sector - Current sector (affects corner severity)
         * @returns {number} Estimated lateral G-force
         */
        function estimateLateralG(speed, throttle, brake, sector) {
            // High lateral G when braking into corners
            if (brake > 30) {
                return 0.5 + (brake / 100) * 1.5;
            }
            // Medium lateral G when accelerating out of corners
            if (throttle > 80 && speed < 180) {
                return 0.3 + (throttle / 100) * 0.5;
            }
            // Base lateral G for normal cornering
            return 0.3;
        }

        /**
         * Update chart data with validation and error handling
         * @param {Object} demoData - Current demo telemetry data
         */
        function updateTestModeCharts(demoData) {
            // Validate chart data arrays
            if (!window.timeData || !window.speedData || !window.rpmData ||
                !window.throttleData || !window.brakeData) {
                console.error('[TEST_MODE_CHARTS] Data arrays not initialized');
                return;
            }

            // Ensure arrays have correct length
            if (window.timeData.length !== CHART_POINTS ||
                window.speedData.length !== CHART_POINTS ||
                window.rpmData.length !== CHART_POINTS ||
                window.throttleData.length !== CHART_POINTS ||
                window.brakeData.length !== CHART_POINTS) {
                console.error('[TEST_MODE_CHARTS] Data arrays have incorrect length, reinitializing...');
                window.timeData = new Array(CHART_POINTS).fill(0);
                window.speedData = new Array(CHART_POINTS).fill(0);
                window.rpmData = new Array(CHART_POINTS).fill(0);
                window.throttleData = new Array(CHART_POINTS).fill(0);
                window.brakeData = new Array(CHART_POINTS).fill(0);
            }

            // Update chart data arrays with validation
            window.timeData.shift();
            window.timeData.push(testModeTimeCounter++);

            const speed = Math.round(Math.max(0, Math.min(350, demoData.speed_kmh)));
            window.speedData.shift();
            window.speedData.push(speed);

            const rpm = Math.round(Math.max(0, Math.min(10000, demoData.rpm)));
            window.rpmData.shift();
            window.rpmData.push(rpm);

            const throttle = Math.round(Math.max(0, Math.min(100, demoData.throttle_pct)));
            window.throttleData.shift();
            window.throttleData.push(throttle);

            const brake = Math.round(Math.max(0, Math.min(100, demoData.brake_pct)));
            window.brakeData.shift();
            window.brakeData.push(brake);

            // Update charts with existence check
            try {
                if (window.speedChart && typeof window.speedChart.setData === 'function') {
                    window.speedChart.setData([window.timeData, window.speedData]);
                }
                if (window.rpmChart && typeof window.rpmChart.setData === 'function') {
                    window.rpmChart.setData([window.timeData, window.rpmData]);
                }
                if (window.throttleChart && typeof window.throttleChart.setData === 'function') {
                    window.throttleChart.setData([window.timeData, window.throttleData]);
                }
                if (window.brakeChart && typeof window.brakeChart.setData === 'function') {
                    window.brakeChart.setData([window.timeData, window.brakeData]);
                }
            } catch (e) {
                console.error('[TEST_MODE_CHARTS] Chart update error:', e);
            }
        }

        /**
         * Update lap time with realistic progression
         * Simulates sector-by-sector timing and lap completion
         */
        function updateTestModeLapTime() {
            // Time increment based on update frequency (100ms = 0.1s)
            testModeLapTime += 100;

            const minutes = Math.floor(testModeLapTime / 60000);
            const seconds = Math.floor((testModeLapTime % 60000) / 1000);
            const millis = testModeLapTime % 1000;

            if (elements.currentLapTime) {
                elements.currentLapTime.textContent =
                    `${minutes}:${seconds.toString().padStart(2, '0')}.${millis.toString().padStart(3, '0')}`;
            }

            // Simulate lap completion when reaching target time
            if (testModeLapTime >= testModeLastLapTime) {
                // Save the completed lap
                const completedLapTime = testModeLastLapTime;
                const completedLapNumber = testModeCurrentLap;

                // Reset for new lap
                testModeLapTime = 0;
                testModeCurrentLap++;

                // Loop back to lap 1 after completing 3 laps
                if (testModeCurrentLap > 3) {
                    testModeCurrentLap = 1;
                }

                // Update lap display
                if (elements.currentLap) {
                    elements.currentLap.textContent = `${testModeCurrentLap}/3`;
                }

                // Add completed lap to history
                addLapData(completedLapNumber, completedLapTime);

                // Generate realistic lap time variation for next lap
                // Realistic Suzuka GT lap times: 1:34.000 - 1:37.000 (94-97 seconds)
                // Add slight random variation (±1.5 seconds)
                const baseLapTime = 95000; // 1:35.000 baseline
                const lapVariation = Math.floor((Math.random() - 0.5) * 3000); // ±1.5 seconds
                testModeLastLapTime = baseLapTime + lapVariation;

                // Ensure lap time stays within realistic bounds
                testModeLastLapTime = Math.max(90000, Math.min(100000, testModeLastLapTime));

                debugLog('TEST_MODE', 'Lap completed', {
                    lap: completedLapNumber,
                    time: formatLapTime(completedLapTime),
                    next_target: formatLapTime(testModeLastLapTime)
                });
            }
        }

        /**
         * Update tyre temperatures and pressures with realistic simulation
         * @param {Object} demoData - Current demo telemetry data
         */
        function updateTestModeTyres(demoData) {
            // Calculate lateral G-force for tyre load simulation
            const lateralG = estimateLateralG(
                demoData.speed_kmh,
                demoData.throttle_pct,
                demoData.brake_pct,
                demoData.sector
            );

            // Base temperature increases with speed and lap count (tyres warm up)
            const lapWarmupFactor = 1 + (testModeCurrentLap - 1) * 0.05; // 5% warmer each lap
            const speedTempFactor = (demoData.speed_kmh / 280) * 35; // Speed contribution (up to 35°C)

            // Front tyres run hotter due to braking and engine heat
            const frontBaseTemp = 70 + speedTempFactor + (demoData.brake_pct * 0.1);
            const frontTempVariation = 6;

            // Rear tyres run cooler but heat up under acceleration
            const rearBaseTemp = 65 + speedTempFactor + (demoData.throttle_pct * 0.08);
            const rearTempVariation = 6;

            // Generate individual tyre temperatures with realistic variation
            const flTemp = generateDemoTyreTemp(frontBaseTemp, frontTempVariation, demoData.speed_kmh, lateralG) * lapWarmupFactor;
            const frTemp = generateDemoTyreTemp(frontBaseTemp, frontTempVariation, demoData.speed_kmh, lateralG * 0.9) * lapWarmupFactor;
            const rlTemp = generateDemoTyreTemp(rearBaseTemp, rearTempVariation, demoData.speed_kmh, lateralG * 0.8) * lapWarmupFactor;
            const rrTemp = generateDemoTyreTemp(rearBaseTemp, rearTempVariation, demoData.speed_kmh, lateralG * 0.85) * lapWarmupFactor;

            // Update UI with null checks
            if (elements.flTemp) {
                elements.flTemp.textContent = Math.round(flTemp);
                elements.flTemp.style.color = getTyreTempColor(flTemp);
            }
            if (elements.frTemp) {
                elements.frTemp.textContent = Math.round(frTemp);
                elements.frTemp.style.color = getTyreTempColor(frTemp);
            }
            if (elements.rlTemp) {
                elements.rlTemp.textContent = Math.round(rlTemp);
                elements.rlTemp.style.color = getTyreTempColor(rlTemp);
            }
            if (elements.rrTemp) {
                elements.rrTemp.textContent = Math.round(rrTemp);
                elements.rrTemp.style.color = getTyreTempColor(rrTemp);
            }

            // Tyre pressures increase with temperature (ideal gas law: P ∝ T)
            const basePressure = 2.0; // 2.0 bar at 20°C
            const tempCorrection = 0.005; // 0.5% pressure increase per °C above 20°C
            const avgTemp = (flTemp + frTemp + rlTemp + rrTemp) / 4;
            const pressureIncrease = (avgTemp - 20) * tempCorrection;
            const basePressureCorrected = basePressure + pressureIncrease;

            // Add realistic pressure variation (±0.08 bar)
            const pressureVariation = 0.08;

            if (elements.flPressure) elements.flPressure.textContent = (basePressureCorrected + (Math.random() - 0.5) * pressureVariation).toFixed(1);
            if (elements.frPressure) elements.frPressure.textContent = (basePressureCorrected + (Math.random() - 0.5) * pressureVariation).toFixed(1);
            if (elements.rlPressure) elements.rlPressure.textContent = (basePressureCorrected + (Math.random() - 0.5) * pressureVariation).toFixed(1);
            if (elements.rrPressure) elements.rrPressure.textContent = (basePressureCorrected + (Math.random() - 0.5) * pressureVariation).toFixed(1);
        }

        /**
         * Update suspension heights with realistic physics simulation
         * @param {Object} demoData - Current demo telemetry data
         */
        function updateTestModeSuspension(demoData) {
            // Base suspension height (in mm from ride height sensor)
            const baseHeight = 85; // Typical GT car ride height

            // Brake compression (front dives under braking)
            // Maximum 20mm compression at 100% brake
            const brakeCompression = (demoData.brake_pct / 100) * 20;

            // Acceleration squat (rear squats under acceleration)
            // Maximum 12mm squat at 100% throttle
            const accelSquat = (demoData.throttle_pct / 100) * 12;

            // Aero downforce compresses suspension at speed
            // Approximate 8mm compression at 280 km/h
            const aeroCompression = (demoData.speed_kmh / 280) * 8;

            // Calculate suspension heights with null checks
            const flHeight = generateDemoSuspension(
                baseHeight,
                brakeCompression * 0.5, // Front left brake effect
                -accelSquat * 0.2,     // Minimal accel effect on front
                demoData.speed_kmh
            );

            const frHeight = generateDemoSuspension(
                baseHeight,
                brakeCompression * 0.5, // Front right brake effect
                -accelSquat * 0.2,     // Minimal accel effect on front
                demoData.speed_kmh
            );

            const rlHeight = generateDemoSuspension(
                baseHeight,
                -brakeCompression * 0.3, // Front lifts rear under braking
                accelSquat,              // Rear squats under acceleration
                demoData.speed_kmh
            );

            const rrHeight = generateDemoSuspension(
                baseHeight,
                -brakeCompression * 0.3, // Front lifts rear under braking
                accelSquat,              // Rear squats under acceleration
                demoData.speed_kmh
            );

            // Update UI with null checks
            if (elements.flSusp) elements.flSusp.textContent = Math.round(flHeight);
            if (elements.frSusp) elements.frSusp.textContent = Math.round(frHeight);
            if (elements.rlSusp) elements.rlSusp.textContent = Math.round(rlHeight);
            if (elements.rrSusp) elements.rrSusp.textContent = Math.round(rrHeight);
        }

        // ============================================
        // TEST MODE ERROR HANDLING & VALIDATION
        // ============================================

        const TEST_MODE_ERRORS = {
            INVALID_STATE: 'Invalid test mode state',
            TRAJECTORY_EMPTY: 'Demo trajectory is empty or invalid',
            CANVAS_NOT_FOUND: 'Course map canvas not found',
            CHART_NOT_INITIALIZED: 'Chart not properly initialized',
            ELEMENT_NOT_FOUND: 'Required DOM element not found'
        };

        /**
         * Validate test mode prerequisites
         * @throws {Error} If prerequisites are not met
         */
        function validateTestModePrerequisites() {
            if (!demoTrajectory || !Array.isArray(demoTrajectory) || demoTrajectory.length === 0) {
                throw new Error(TEST_MODE_ERRORS.TRAJECTORY_EMPTY);
            }

            if (!courseMapState.canvas) {
                throw new Error(TEST_MODE_ERRORS.CANVAS_NOT_FOUND);
            }

            // Validate critical DOM elements
            const criticalElements = [
                'speed', 'gear', 'rpm-bar', 'throttle-bar', 'brake-bar',
                'current-lap', 'best-lap-time', 'course-name'
            ];

            for (const id of criticalElements) {
                if (!document.getElementById(id)) {
                    console.error(`[TEST_MODE] Critical element not found: ${id}`);
                }
            }
        }

        /**
         * Safely execute test mode operations with error handling
         * @param {Function} operation - The operation to execute
         * @param {string} operationName - Name for logging purposes
         */
        function safeExecuteTestModeOperation(operation, operationName) {
            try {
                return operation();
            } catch (error) {
                console.error(`[TEST_MODE_ERROR] ${operationName}:`, error.message);
                debugLog('TEST_MODE_ERROR', operationName, error);
                // Don't disable test mode on minor errors, log them instead
                return null;
            }
        }

        const testModeBtn = document.getElementById('test-mode-btn');
        if (testModeBtn) {
            testModeBtn.addEventListener('click', () => {
                try {
                    // Validate prerequisites before starting test mode
                    if (!testModeActive) {
                        validateTestModePrerequisites();
                    }

                    testModeActive = !testModeActive;
                    testModeBtn.classList.toggle('active', testModeActive);
                    testModeBtn.textContent = testModeActive ? 'STOP TEST' : 'TEST MODE';

                    if (testModeActive) {
                        debugLog('TEST', 'Test mode enabled - Validation passed');
                    // Reset test mode state
                    testTrajectoryIndex = 0;
                    testModeTimeCounter = 0;
                    testModeLapTime = 0;
                    testModeCurrentLap = 1;

                    statusEl.textContent = 'TEST MODE';
                    statusEl.style.background = 'var(--accent-yellow)';
                    statusEl.style.color = '#000';
                    elements.courseName.textContent = 'スズカ サーキット (Demo)';
                    elements.carId.textContent = '0';

                    // Initialize lap display
                    elements.currentLap.textContent = '1/3';
                    elements.bestLapTime.textContent = formatLapTime(testModeLastLapTime);

                    // Reset course map for test mode
                    courseMapState.trajectory = [];
                    courseMapState.currentPosition = { x: 0, y: 0, z: 0 };
                    courseMapState.initialized = false;

                    // Clear and initialize chart data
                    window.timeData = new Array(CHART_POINTS).fill(0);
                    window.speedData = new Array(CHART_POINTS).fill(0);
                    window.rpmData = new Array(CHART_POINTS).fill(0);
                    window.throttleData = new Array(CHART_POINTS).fill(0);
                    window.brakeData = new Array(CHART_POINTS).fill(0);

                    testModeInterval = setInterval(() => {
                        if (!testModeActive) {
                            clearInterval(testModeInterval);
                            return;
                        }

                        safeExecuteTestModeOperation(() => {
                            const point = demoTrajectory[testTrajectoryIndex % demoTrajectory.length];
                            testTrajectoryIndex++;

                            // Validate trajectory point
                            if (!point || typeof point.x !== 'number' || typeof point.z !== 'number') {
                                console.error('[TEST_MODE] Invalid trajectory point:', point);
                                return;
                            }

                            // Simulate telemetry data with realistic variations
                            const speedVariation = (Math.random() - 0.5) * 8; // ±4 km/h variation
                            const rpmVariation = (Math.random() - 0.5) * 400; // ±200 RPM variation
                            const pedalVariation = Math.max(-5, Math.min(5, (Math.random() - 0.5) * 8)); // ±4% variation

                            const demoData = {
                                position_x: point.x,
                                position_y: 0,
                                position_z: point.z,
                                speed_kmh: Math.max(50, point.speed + speedVariation), // Minimum 50 km/h
                                speed_ms: Math.max(50, point.speed + speedVariation) / 3.6,
                                rpm: Math.max(2000, Math.min(9500, point.rpm + rpmVariation)), // Clamp to realistic range
                                gear: Math.max(1, Math.min(6, point.gear)), // Clamp gear to valid range
                                throttle_pct: Math.max(0, Math.min(100, point.throttle + pedalVariation)),
                                brake_pct: Math.max(0, Math.min(100, point.brake + pedalVariation * 0.5)),
                                current_fuel: Math.max(5, 50 - (testModeCurrentLap * 12)), // Minimum 5L
                                boost: 0,
                                max_rpm: 9000,
                                course: { name: 'スズカ サーキット (Demo)', id: 'suzuka', confidence: 1.0 },
                                lap_count: testModeCurrentLap,
                                total_laps: 3,
                                sector: point.sector || 1
                            };

                            // Update UI elements with null checks
                            const speed = Math.round(demoData.speed_kmh);
                            if (elements.speed) elements.speed.textContent = speed;
                            if (speed > maxSpeed) {
                                maxSpeed = speed;
                                if (elements.maxSpeed) elements.maxSpeed.textContent = maxSpeed;
                            }

                            if (elements.gear) elements.gear.textContent = demoData.gear;

                            const rpm = Math.round(demoData.rpm);
                            const rpmPct = Math.min((rpm / demoData.max_rpm) * 100, 100);
                            if (elements.rpmBar) elements.rpmBar.style.width = rpmPct + '%';
                            if (elements.rpmText) elements.rpmText.textContent = rpm + ' RPM';

                            const throttle = Math.max(0, Math.min(100, Math.round(demoData.throttle_pct)));
                            const brake = Math.max(0, Math.min(100, Math.round(demoData.brake_pct)));
                            if (elements.throttleBar) elements.throttleBar.style.width = throttle + '%';
                            if (elements.throttleValue) elements.throttleValue.textContent = throttle + '%';
                            if (elements.brakeBar) elements.brakeBar.style.width = brake + '%';
                            if (elements.brakeValue) elements.brakeValue.textContent = brake + '%';

                            if (elements.fuel) elements.fuel.textContent = demoData.current_fuel.toFixed(1);
                            if (elements.boost) elements.boost.textContent = '0';

                            if (elements.maxX) elements.maxX.textContent = point.x.toFixed(1);
                            if (elements.maxY) elements.maxY.textContent = '0.0';
                            if (elements.maxZ) elements.maxZ.textContent = point.z.toFixed(1);

                            // Update charts with error handling
                            try {
                                updateTestModeCharts(demoData);
                            } catch (e) {
                                console.error('[TEST_MODE] Chart update error:', e);
                            }

                            // Update tyres with error handling
                            try {
                                updateTestModeTyres(demoData);
                            } catch (e) {
                                console.error('[TEST_MODE] Tyre update error:', e);
                            }

                            // Update suspension with error handling
                            try {
                                updateTestModeSuspension(demoData);
                            } catch (e) {
                                console.error('[TEST_MODE] Suspension update error:', e);
                            }

                            // Update lap time with error handling
                            try {
                                updateTestModeLapTime();
                            } catch (e) {
                                console.error('[TEST_MODE] Lap time update error:', e);
                            }

                            // Update course map with error handling
                            try {
                                updateCourseMap(point.x, 0, point.z, demoData.speed_kmh);
                            } catch (e) {
                                console.error('[TEST_MODE] Course map update error:', e);
                            }

                            // Update course bounds visualization
                            if (testTrajectoryIndex === 1) {
                                try {
                                    updateCourseBounds('suzuka');
                                } catch (e) {
                                    console.error('[TEST_MODE] Course bounds update error:', e);
                                }
                            }

                            packetCount++;
                            if (elements.packets) elements.packets.textContent = packetCount;

                        }, 'test_mode_update');

                    }, 200); // 5Hz demo update (as per specification)

                } else {
                    debugLog('TEST', 'Test mode disabled - Cleaning up');

                    // Clear interval with error handling
                    if (testModeInterval) {
                        clearInterval(testModeInterval);
                        testModeInterval = null;
                    }

                    // Reset status display
                    statusEl.textContent = 'Connected';
                    statusEl.style.background = '';
                    statusEl.style.color = '';

                    // Reset test mode state variables
                    testTrajectoryIndex = 0;
                    testModeTimeCounter = 0;
                    testModeLapTime = 0;
                    testModeCurrentLap = 1;

                    // Clear trajectory when stopping test mode
                    safeExecuteTestModeOperation(() => {
                        if (typeof courseMapState !== 'undefined') {
                            courseMapState.trajectory = [];
                            courseMapState.currentPosition = { x: 0, y: 0, z: 0 };
                            courseMapState.initialized = false;
                            drawCourseMap();
                        }
                    }, 'cleanup_course_map');

                    // Reset charts to zeros with error handling
                    safeExecuteTestModeOperation(() => {
                        window.speedData.fill(0);
                        window.rpmData.fill(0);
                        window.throttleData.fill(0);
                        window.brakeData.fill(0);

                        if (window.speedChart) window.speedChart.setData([window.timeData, window.speedData]);
                        if (window.rpmChart) window.rpmChart.setData([window.timeData, window.rpmData]);
                        if (window.throttleChart) window.throttleChart.setData([window.timeData, window.throttleData]);
                        if (window.brakeChart) window.brakeChart.setData([window.timeData, window.brakeData]);
                    }, 'cleanup_charts');

                    debugLog('TEST', 'Test mode cleanup completed');
                }
                } catch (e) {
                    console.error('[TEST_MODE] Error:', e);
                    testModeActive = false;
                    testModeBtn.classList.remove('active');
                    testModeBtn.textContent = 'TEST MODE';
                }
            });
        } else {
            console.error('[TEST_MODE] Test mode button not found in DOM');
        }

        ws.onerror = (error) => {
            console.error('WebSocket Error:', error);
        };

        ws.onclose = () => {
            console.log('Disconnected');
            statusEl.textContent = 'Disconnected';
            statusEl.className = 'disconnected';
        };

        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                packetCount++;

                currentLapNumber = data.lap_count || 1;
                elements.currentLap.textContent = `${currentLapNumber}/${data.total_laps || '--'}`;

                if (currentLapNumber > lastLapNumber && lastLapNumber > 0) {
                    const lastTime = data.last_laptime;
                    if (lastTime > 0) {
                        addLapData(lastLapNumber, lastTime);
                        elements.currentLapTime.textContent = formatLapTime(lastTime);
                    }
                    currentLapData = [];
                }
                lastLapNumber = currentLapNumber;

                currentLapData.push({
                    time: timeCounter,
                    speed: data.speed_kmh || 0,
                    rpm: data.rpm || 0,
                    throttle: data.throttle_pct || 0,
                    brake: data.brake_pct || 0
                });

                if (bestLapData.length > 0 && currentLapData.length > 0) {
                    const idx = Math.min(currentLapData.length - 1, bestLapData.length - 1);
                    const delta = currentLapData[idx].speed - bestLapData[idx].speed;
                    elements.lapDelta.textContent = (delta >= 0 ? '+' : '') + delta.toFixed(1) + ' km/h';
                    elements.lapDelta.className = 'delta-value' + (delta < 0 ? ' negative' : '');
                }

                window.timeData.shift();
                window.timeData.push(timeCounter++);

                const speed = Math.round(data.speed_kmh || 0);
                window.speedData.shift();
                window.speedData.push(speed);
                elements.speed.textContent = speed;
                if (speed > maxSpeed) {
                    maxSpeed = speed;
                    elements.maxSpeed.textContent = maxSpeed;
                }

                const gear = data.gear || 0;
                elements.gear.textContent = gear === 0 ? 'R' : gear;

                const rpm = Math.round(data.rpm || 0);
                const maxRpm = data.max_rpm || 9000;
                const rpmPct = Math.min((rpm / maxRpm) * 100, 100);
                window.rpmData.shift();
                window.rpmData.push(rpm);
                elements.rpmBar.style.width = rpmPct + '%';
                elements.rpmText.textContent = rpm + ' RPM';

                const throttle = Math.round(data.throttle_pct || 0);
                const brake = Math.round(data.brake_pct || 0);
                window.throttleData.shift();
                window.throttleData.push(throttle);
                window.brakeData.shift();
                window.brakeData.push(brake);
                elements.throttleBar.style.width = throttle + '%';
                elements.throttleValue.textContent = throttle + '%';
                elements.brakeBar.style.width = brake + '%';
                elements.brakeValue.textContent = brake + '%';

                elements.fuel.textContent = (data.current_fuel || 0).toFixed(1);
                elements.boost.textContent = ((data.boost || 0) * 100).toFixed(0);

                // Update fuel consumption
                if (elements.fuelUsed) elements.fuelUsed.textContent = (data.fuel_consumed || 0).toFixed(2);
                if (elements.fuelPerLap) elements.fuelPerLap.textContent = (data.fuel_per_lap || 0).toFixed(2);
                if (elements.fuelRate) elements.fuelRate.textContent = (data.fuel_consumption_rate || 0).toFixed(1);
                if (elements.fuelRemaining) elements.fuelRemaining.textContent = (data.fuel_laps_remaining || 0).toFixed(0);

                elements.maxX.textContent = (data.position_x || 0).toFixed(1);
                elements.maxY.textContent = (data.position_y || 0).toFixed(1);
                elements.maxZ.textContent = (data.position_z || 0).toFixed(1);

                // Update course name
                if (data.course) {
                    const courseName = data.course.name || 'Unknown Track';
                    const courseId = data.course.id || 'unknown';
                    if (courseName !== currentCourseName) {
                        currentCourseName = courseName;
                        elements.courseName.textContent = courseName;
                        elements.courseName.title = courseName;
                        debugLog('COURSE', 'Course changed to:', courseName);
                        // Update course bounds visualization
                        if (courseId !== 'unknown') {
                            updateCourseBounds(courseId);
                        }
                    }
                }

                // Update course map
                if (data.position_x !== undefined && data.position_z !== undefined) {
                    updateCourseMap(
                        data.position_x,
                        data.position_y || 0,
                        data.position_z,
                        data.speed_kmh || 0
                    );
                }

                if (data.susp_height) {
                    elements.flSusp.textContent = (data.susp_height[0] * 1000).toFixed(0);
                    elements.frSusp.textContent = (data.susp_height[1] * 1000).toFixed(0);
                    elements.rlSusp.textContent = (data.susp_height[2] * 1000).toFixed(0);
                    elements.rrSusp.textContent = (data.susp_height[3] * 1000).toFixed(0);
                }

                if (data.tyre_temp) {
                    const temps = data.tyre_temp;
                    elements.flTemp.textContent = Math.round(temps[0]);
                    elements.frTemp.textContent = Math.round(temps[1]);
                    elements.rlTemp.textContent = Math.round(temps[2]);
                    elements.rrTemp.textContent = Math.round(temps[3]);

                    elements.flTemp.style.color = getTyreTempColor(temps[0]);
                    elements.frTemp.style.color = getTyreTempColor(temps[1]);
                    elements.rlTemp.style.color = getTyreTempColor(temps[2]);
                    elements.rrTemp.style.color = getTyreTempColor(temps[3]);
                }

                if (data.tyre_pressure) {
                    const pressures = data.tyre_pressure;
                    elements.flPressure.textContent = (pressures[0] || 0).toFixed(1);
                    elements.frPressure.textContent = (pressures[1] || 0).toFixed(1);
                    elements.rlPressure.textContent = (pressures[2] || 0).toFixed(1);
                    elements.rrPressure.textContent = (pressures[3] || 0).toFixed(1);
                }

                if (data.car_id) {
                    elements.carId.textContent = data.car_id;
                }

                // Update course name
                if (data.course && data.course.name) {
                    const courseName = data.course.name;
                    const courseId = data.course.id || 'unknown';
                    if (courseName !== currentCourseName) {
                        currentCourseName = courseName;
                        elements.courseName.textContent = courseName;
                        debugLog('COURSE', 'Course detected:', courseName);
                        // Update course bounds visualization
                        if (courseId !== 'unknown') {
                            updateCourseBounds(courseId);
                        }
                    }
                }

                elements.packets.textContent = packetCount;

                if (window.speedChart) window.speedChart.setData([window.timeData, window.speedData]);
                if (window.rpmChart) window.rpmChart.setData([window.timeData, window.rpmData]);
                if (window.throttleChart) window.throttleChart.setData([window.timeData, window.throttleData]);
                if (window.brakeChart) window.brakeChart.setData([window.timeData, window.brakeData]);

                // Update acceleration values
                updateAccelChart(data.accel_g || 0, data.accel_decel || 0);
                if (elements.accelG) elements.accelG.textContent = (data.accel_g || 0).toFixed(2);
                if (elements.accelDecel) elements.accelDecel.textContent = (data.accel_decel || 0).toFixed(2);

            } catch (e) {
                console.error('WebSocket message error:', e);
            }
        };
    </script>
</body>
</html>

# GT7 Telemetry Dashboard 障害報告・改善履歴

## 発生日: 2026-02-12
## 報告者: Claude Opus 4.6 による調査・修正
## 対象リポジトリ: gt7_tool (branch: improve-ui)

---

## 障害概要

GT7テレメトリダッシュボードにおいて、ブラウザ画面上の数値（速度、RPM、ギア、スロットル等）が一切更新されなくなった。前日(2026-02-11)までは正常に動作していた。

---

## 根本原因（2件同時発生）

### 原因1: docker-compose.yml のネットワーク設定変更

#### 壊れた設定（コミット外の未コミット変更）
```yaml
services:
  gt7_tool:
    network_mode: "bridge"
    ports:
      - "18080:8080"
    environment:
      - PYTHONUNBUFFERED=1
      # PS5_IP が削除されていた
```

#### 正しい設定（修正後）
```yaml
services:
  gt7_tool:
    network_mode: "host"
    environment:
      - PS5_IP=192.168.1.10
      - PYTHONUNBUFFERED=1
```

#### 影響範囲
- `network_mode: "bridge"` ではコンテナが独立ネットワークに隔離される
- UDP 33740（PS5→コンテナ テレメトリ受信）が未マッピングのため受信不能
- UDP 33739（コンテナ→PS5 ハートビート送信）が未マッピングのため送信不能
- `PS5_IP` 環境変数が削除されていたため、PS5のIPアドレスを認識できない
- 結果：PS5との全テレメトリ通信が遮断され、サーバーにデータが一切届かない

#### なぜ host モードが必要か
- GT7テレメトリはUDPプロトコルで通信する
- PS5はハートビートパケットの送信元IPに対してテレメトリを返送する
- bridge モードではコンテナのIPがホストと異なるため、PS5からの応答がコンテナに届かない
- host モードではコンテナがホストのネットワークスタックを直接使用するため、UDP通信が正常に機能する

---

### 原因2: index.html の JavaScript 構文エラー

#### 発生コミット
- `7ac822b` feat: TEST MODE complete rewrite - proper demo data and charts (2026-02-12)
- `19c89f4` fix: TEST MODE not working - add demo data and chart updates (2026-02-12)

#### 問題箇所（修正前）
```javascript
// line 1969-2175 付近
testModeBtn.addEventListener('click', () => {
    try {                          // ← try ブロック開始
        if (!testModeActive) {
            validateTestModePrerequisites();
        }
        testModeActive = !testModeActive;
        // ... 約200行のテストモード処理 ...
        if (testModeActive) {
            // テストモード開始処理
            testModeInterval = setInterval(() => {
                // デモデータ生成・UI更新
            }, 200);
        } else {
            // テストモード停止・クリーンアップ
        }
    });                            // ← catch/finally が無い！構文エラー！
```

#### 修正後
```javascript
testModeBtn.addEventListener('click', () => {
    try {
        // ... テストモード処理 ...
    } catch (e) {                  // ← catch ブロック追加
        console.error('[TEST_MODE] Error:', e);
        testModeActive = false;
        testModeBtn.classList.remove('active');
        testModeBtn.textContent = 'TEST MODE';
    }
});
```

#### 影響範囲
- JavaScript仕様では `try {}` には必ず `catch` または `finally` が必要（ECMAScript仕様）
- `try` without `catch/finally` は **構文エラー (SyntaxError)**
- 構文エラーはスクリプトのパース段階で発生するため、**`<script>`ブロック内の全コードが実行不能**になる
- 結果：
  - WebSocket接続が確立されない
  - `ws.onmessage` ハンドラが登録されない
  - UI更新処理が一切実行されない
  - 画面上の全数値が初期値（0, --, N）のまま固定される

---

## 修正対応の時系列

| 時刻 | 対応内容 | 結果 |
|------|----------|------|
| 13:25頃 | docker-compose.yml を修正（bridge→host, PS5_IP復元） | コンテナ再起動後もブラウザ画面は更新されず |
| 13:28頃 | ws_capture.html（WebSocketキャプチャツール）を作成 | curlテストでWebSocket経由のデータ受信を確認→データは正常に流れていた |
| 13:33頃 | curlでWebSocket接続テスト | PS5テレメトリデータ（速度85km/h, RPM 5825, ニュルブルクリンク走行中）を確認 |
| 13:35頃 | index.html の try/catch 構文エラーを発見・修正 | ブラウザ画面まだ更新されず（ブラウザキャッシュの可能性） |
| 13:40頃 | 昨日(fe5dea6)のindex.htmlに復元 | - |
| 13:42頃 | docker compose 再起動 | **数値更新を確認 → 復旧完了** |

---

## 両方同時に壊れていた影響

2つの障害が同時に発生していたため、片方だけの修正では症状が変わらなかった：

1. docker-compose.yml だけ修正 → サーバーにデータは届くが、ブラウザのJSが構文エラーで動かないため画面更新されない
2. index.html だけ修正 → ブラウザのJSは動くが、サーバーにPS5からデータが届かないため更新するデータがない

両方を修正して初めて復旧した。

---

## 再発防止のための注意事項

### docker-compose.yml について
- **`network_mode: "host"` を変更しないこと** — UDP通信に必須
- `PS5_IP` 環境変数を削除しないこと
- bridge モードに変更する場合は、最低限以下のポートマッピングが必要：
  ```yaml
  ports:
    - "8080:8080/tcp"     # HTTP/WebSocket
    - "33740:33740/udp"   # PS5テレメトリ受信
    - "33739:33739/udp"   # PS5ハートビート送信
  ```
  ただし bridge モードではPS5からの応答がコンテナに届かない可能性があるため、host モードを推奨

### index.html (JavaScript) について
- `try` ブロックには必ず `catch` または `finally` を対にすること
- テストモード等の大規模な機能追加後は、ブラウザのDevTools Console (F12)で構文エラーが出ていないか確認すること
- 構文チェックコマンド：
  ```bash
  node -e "
  const fs = require('fs');
  const html = fs.readFileSync('index.html', 'utf8');
  const m = html.match(/<script>([\s\S]*?)<\/script>/g);
  m.forEach((s,i) => {
    try { new Function(s.replace(/<\/?script>/g,'')); console.log('Block '+i+': OK'); }
    catch(e) { console.log('Block '+i+': ERROR - '+e.message); }
  });
  "
  ```

### 一般的な注意
- 動作確認済みのコードを変更する際は、変更前の状態をgitコミットしておくこと
- 複数ファイルを同時に変更する場合、問題発生時の切り分けが困難になるため、1ファイルずつ変更・テストすることを推奨
- WebSocketデータの確認には `ws_capture.html` を活用可能（サーバー側→ブラウザ側の切り分けに有効）

---

## ファイル一覧

| ファイル | 変更内容 |
|----------|----------|
| docker-compose.yml | network_mode を host に復元、PS5_IP 復元 |
| index.html | 昨日(fe5dea6)のバージョンに復元 |
| index.html.broken | 壊れていたバージョンのバックアップ |
| ws_capture.html | 新規作成 - WebSocketデータキャプチャツール |

---

## 関連コミット履歴

```
7ac822b 2026-02-12 feat: TEST MODE complete rewrite ← 構文エラー混入
19c89f4 2026-02-12 fix: TEST MODE not working
d2b360f 2026-02-12 fix: update course database structure
c645f1b 2026-02-12 fix: update course database structure
4529e08 2026-02-12 fix: update course database structure
fe5dea6 2026-02-11 docs: update based on real device testing ← 最後の正常動作版
de06fb6 2026-02-11 feat: enhance dashboard UI and telemetry processing
bb25553 2026-02-11 Add course information estimation and test mode
```

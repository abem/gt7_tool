# GT7 Tool ユーザーガイド

## 目次

1. [はじめに](#はじめに)
2. [インストール](#インストール)
3. [初期設定](#初期設定)
4. [ダッシュボードの使い方](#ダッシュボードの使い方)
5. [コース推定機能](#コース推定機能)
6. [テストモード](#テストモード)
7. [トラブルシューティング](#トラブルシューティング)
8. [FAQ](#faq)

## はじめに

GT7 Toolは、グランツーリスモ7 (GT7) のテレメトリデータをリアルタイムで表示・分析するためのツールです。PS5/PS4から送信されるデータを受信し、ウェブブラウザ上で美しいダッシュボードとして表示します。

### 主な機能

- **リアルタイムテレメトリ表示**: 速度、回転数、ギア、ペダル入力
- **タイヤ詳細情報**: 4輪の温度、サスペンション、タイヤ半径
- **コースマップ**: 走行軌跡をリアルタイムで可視化
- **コース自動推定**: 位置座標から走行中のコースを自動判定
- **ラップタイム記録**: ラップタイムとベストタイムの管理
- **テストモード**: PS5なしで動作確認が可能

---

## インストール

### 必要な環境

- **PS5またはPS4** (GT7がインストールされていること)
- **PCまたはサーバー** (Docker実行環境)
- **同一ネットワーク**: PS5とPCが同じLAN/Wi-Fiに接続されていること
- **Docker** (version 20.10以上)
- **Docker Compose** (version 2.0以上)

### インストール手順

#### 1. リポジトリのクローン

```bash
git clone <リポジトリURL>
cd gt7_tool
```

または、ZIPファイルをダウンロードして展開します。

#### 2. Dockerイメージのビルド

```bash
docker compose build
```

---

## 初期設定

### 1. PS5のIPアドレスを確認

1. PS5のホーム画面から「設定」(歯車アイコン)を開く
2. 「ネットワーク」→「接続状態」を選択
3. IPアドレスをメモする (例: `192.168.1.10`)

### 2. 設定ファイルの編集

`config.json` をテキストエディタで開き、PS5のIPアドレスを設定します。

```json
{
    "ps5_ip": "192.168.1.10",
    "send_port": 33739,
    "receive_port": 33740,
    "http_port": 8080,
    "heartbeat_interval": 10
}
```

**設定項目の説明:**

| 項目 | 説明 | デフォルト値 |
|------|------|-------------|
| `ps5_ip` | PS5のIPアドレス | 必須設定 |
| `send_port` | ハートビート送信ポート | 33739 |
| `receive_port` | テレメトリ受信ポート | 33740 |
| `http_port` | Webサーバーポート | 8080 |
| `heartbeat_interval` | ハートビート間隔(秒) | 10 |

### 3. GT7でテレメトリを有効化

1. GT7を起動
2. オプションメニューから「設定」を開く
3. 「コントローラー設定」→「通信設定」
4. 「テレメトリデータ送信」を **ON** に設定

### 4. アプリケーションの起動

```bash
docker compose up --build
```

以下のメッセージが表示されれば成功です：

```
Starting GT7 Dashboard Server on port 8080...
HTTP: http://0.0.0.0:8080
WebSocket: ws://0.0.0.0:8080/ws
[Heartbeat] Sending to 192.168.1.10:33739 - waiting for data...
[RX] Started receiving 296 bytes from ('192.168.1.10', 33740)
```

---

## ダッシュボードの使い方

### アクセス方法

ブラウザで以下のURLを開きます：

```
http://localhost:8080
```

または、LAN内の別端末からアクセスする場合：

```
http://<PCのIPアドレス>:8080
```

### ダッシュボードレイアウト

ダッシュボードは3つのパネルで構成されています：

#### 左パネル - 基本情報

| 表示項目 | 説明 |
|---------|------|
| **速度** | 現在の車速 (km/h) |
| **ギア** | 現在のギア位置 (R, N, 1-6) |
| **RPMバー** | エンジン回転数の視覚表示 |
| **スロットル** | アクセルペダルの開度 (%) |
| **ブレーキ** | ブレーキペダルの開度 (%) |
| **燃料** | 現在の燃料残量 (L) |
| **ブースト** | ブースト圧 (%) |
| **最高速** | セッション中の最高速度 |

#### 中央パネル - 詳細情報

**リアルタイムチャート (4つ)**

- SPEED: 速度の推移
- RPM: エンジン回転数の推移
- THROTTLE: スロットルの推移
- BRAKE: ブレーキの推移

**コースマップ**

- 車両の現在位置を緑色の点で表示
- 走行軌跡を速度に応じて色分け表示
  - 赤: 低速 (< 60 km/h)
  - 黄: 中速 (60-120 km/h)
  - 緑: 高速 (> 120 km/h)

**タイヤ情報**

- 各タイヤの温度 (色で視覚化)
  - シアン: 低温 (< 40C)
  - 緑: 適正 (40-80C)
  - 黄: 高温 (80-100C)
  - 赤: 過熱 (> 100C)
- サスペンション高さ (mm)

#### 右パネル - ラップ・ステータス

| 表示項目 | 説明 |
|---------|------|
| **現在のラップ** | 「現在のラップ/総ラップ数」 |
| **カレントタイム** | 前回のラップタイム |
| **ベストタイム** | セッション中のベストラップタイム |
| **デルタ** | ベストラップとの速度差 |
| **ラップ履歴** | ラップタイムの一覧 |
| **ポジション** | X/Y/Z座標 |
| **加速度 G** | 加速G / 減速G の数値とチャート |

---

## コース推定機能

### 仕組み

GT7のテレメトリパケットにはコースIDが含まれていないため、車両の位置座標 (X, Z) からコースを推定します。

### コースデータベース

コースデータベース (`course_database.json`) には、各コースの座標範囲が登録されています。

```json
{
    "courses": [
        {
            "id": "suzuka",
            "name": "スズカ サーキット",
            "bounds": {
                "min_x": -500.0,
                "max_x": 500.0,
                "min_z": -500.0,
                "max_z": 500.0
            }
        }
    ]
}
```

### 新しいコースを学習させる

1. GT7で学習させたいコースを走行
2. ツールが自動的にテレメトリデータを `gt7data/` ディレクトリに保存
3. 以下のコマンドを実行してコースデータベースを更新：

```bash
docker compose exec app python test_course_detection.py --data-dir gt7data
```

または、Dockerを使用しない場合：

```bash
python3 test_course_detection.py --data-dir gt7data
```

### 手動でコースを追加する

`course_database.json` を直接編集して、新しいコースを追加できます。

```json
{
    "id": "my_track",
    "name": "マイ・トラック",
    "bounds": {
        "min_x": -1000.0,
        "max_x": 1000.0,
        "min_z": -1000.0,
        "max_z": 1000.0
    }
}
```

---

## テストモード

### 概要

テストモードは、PS5がなくてもダッシュボードの動作を確認できる機能です。デモデータが生成され、コースマップと各種表示がシミュレートされます。

### 使用方法

1. ブラウザでダッシュボードを開く
2. 「TEST MODE」ボタンをクリック
3. デモデータの表示が開始されます
4. 「STOP TEST」ボタンで停止

### デモコース

テストモードでは「スズカ サーキット (Demo)」が表示されます。

---

## トラブルシューティング

### 接続できない

#### 「Client connected」が表示されない

**原因:** PS5との通信が確立されていません

**解決方法:**

1. PS5とPCが同じネットワークに接続されているか確認
2. `config.json` の `ps5_ip` が正しいか確認
3. GT7で「テレメトリデータ送信」がONになっているか確認
4. ファイアウォールでUDPポート 33740 がブロックされていないか確認

#### データが表示されない

**原因:** GT7が起動していない、またはレース画面が表示されていません

**解決方法:**

1. GT7を起動
2. 「タイムアタック」または「レース」画面で走行を開始

### ダッシュボードの表示がおかしい

#### チャートが表示されない

**解決方法:**

1. ブラウザをリロード (F5)
2. ブラウザのコンソール (F12) でエラーを確認

#### コースマップが空白

**解決方法:**

1. GT7で走行を開始 (位置データの受信待ち)
2. 「TEST MODE」で動作確認

### パフォーマンス問題

#### 表示が遅い/カクつく

**解決方法:**

1. ブラウザタブを閉じてリソースを解放
2. PCのスペックを確認
3. WebSocket接続を1つにする (複数タブで開かない)

---

## FAQ

### Q: スマートフォンやタブレットで見られますか？

A: はい。PCと同じWi-Fiネットワークに接続していれば、ブラウザから `http://<PCのIPアドレス>:8080` でアクセスできます。

### Q: 同時に複数人で見られますか？

A: はい。複数のブラウザから同時にアクセスできます。

### Q: データは保存されますか？

A: はい。`gt7data/` ディレクトリにJSON形式で保存されます。ファイル名はタイムスタンプと車種ID、ラップ番号を含みます。

### Q: 古いデータはどうなりますか？

A: 自動的には削除されません。必要に応じて手動で `gt7data/` ディレクトリを整理してください。

### Q: 他のシムレーシングゲームでも使えますか？

A: いいえ。GT7専用の暗号化とパケット構造に対応しています。

### Q: オフラインで使えますか？

A: テストモードであれば、インターネット接続なしで動作します。ただし、PS5からのテレメトリ受信にはLAN接続が必要です。

### Q: ラップタイムの履歴はどこまで保存されますか？

A: 現在のセッション中のみ保存されます。リロードするとリセットされます。

### Q: コース推定の精度を上げるには？

A: 実際のテレメトリデータを収集して、`test_course_detection.py` でコースデータベースを更新してください。

---

## キーボードショートカット

| ショートカット | 動作 |
|---------------|------|
| F5 | ページのリロード |
| F12 | 開発者ツール (デバッグ用) |

---

## 用語集

| 用語 | 説明 |
|------|------|
| テレメトリ | リアルタイムで送信される車両データ |
| Salsa20 | GT7で使用されている暗号化方式 |
| ハートビート | PS5に「データを送って」とリクエストするパケット |
| WebSocket | サーバーとブラウザ間の双方向通信プロトコル |
| デルタ | ベストタイムとの差 (または現在との速度差) |

---

## サポート

問題が発生した場合、以下の手順で情報を収集してください：

1. `docker compose logs` の出力
2. ブラウザのコンソールログ (F12)
3. 使用している環境 (OS, Dockerバージョン, ブラウザ)

---

## 実機テスト結果 (2026-02-11)

以下の項目について実機テストを実施し、正常動作を確認しました：

| テスト項目 | 結果 | 確認内容 |
|-----------|------|---------|
| ページ読み込み | PASS | HTTP 200で正しくロード |
| DOM要素表示 | PASS | 38/38要素が正しく表示 |
| チャート表示 | PASS | 4つのグラフが正しく描画 |
| WebSocket接続 | PASS | サーバーとの接続が正常 |
| データ更新 | PASS | 481パケット受信、データ正しく表示 |
| タイヤ表示 | PASS | 4輪の温度が正しく表示 |
| サスペンション表示 | PASS | 4輪のサスペンション高さが正しく表示 |
| レスポンシブレイアウト | PASS | デスクトップ/ラップトップ/タブレットで正しく表示 |

**確認済み動作環境:**
- Docker (Python 3.x)
- ブラウザ: Chrome, Firefox, Safari
- 画面サイズ: 1920x1080, 1366x768, 768x1024

---

## ライセンス

MIT License

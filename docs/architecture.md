# システムアーキテクチャ

## 概要

GT7 Telemetry Dashboardは、クライアント-サーバーアーキテクチャを採用しています。PS5/PS4から送信されるテレメトリデータをPythonバックエンドで受信・処理し、WebSocket経由でウェブフロントエンドに配信します。

## コンポーネント図

```
┌─────────────────────────────────────────────────────────────────┐
│                           PS5/PS4                                │
│                    (Gran Turismo 7)                             │
└────────────────────────────┬────────────────────────────────────┘
                             │ UDP Port 33739/33740
                             │ (暗号化パケット)
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Python Backend                              │
│                          main.py                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  telemetry.py - UDP通信管理                               │   │
│  │    • ハートビート送信 (Port 33739)                        │   │
│  │    • テレメトリ受信 (Port 33740)                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              │                                    │
│                              ▼                                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  decoder.py - データ復号・解析                            │   │
│  │    • Salsa20復号                                          │   │
│  │    • パケット解析                                         │   │
│  │    • コース推定                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              │                                    │
│                              ▼                                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  WebSocket Server                                         │   │
│  │    • クライアント接続管理                                  │   │
│  │    • データ配信                                           │   │
│  │    • HTTPサーバー (ダッシュボード配信)                    │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────────┬────────────────────────────────────┘
                             │ WebSocket (ws://)
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Web Browser                                │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  index.html (HTML構造) + styles.css (スタイル)            │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  ui_components.js - 定数・ユーティリティ・DOM要素キャッシュ│   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  charts.js - uPlotチャート (SPEED, RPM, THROTTLE, BRAKE) │   │
│  │            + 加速度チャート (Canvas)                       │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  course-map.js - コースマップ (走行軌跡・速度別色分け)     │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  websocket.js - WebSocket通信・テレメトリデータ処理       │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  test-mode.js - テストモード (デモデータ生成)             │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  app.js - エントリーポイント (初期化)                      │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## ファイル構成

### バックエンド (Python)

| ファイル名 | 説明 | 主要なクラス/関数 |
|-----------|------|-----------------|
| `main.py` | エントリーポイント | `FuelTracker`, `websocket_handler`, `telemetry_background_task` |
| `telemetry.py` | UDP通信管理 | `GT7TelemetryClient` |
| `decoder.py` | パケット復号・解析 | `GT7Decoder`, `CourseEstimator` |

### フロントエンド (HTML/JS/CSS)

| ファイル名 | 説明 | 主要な機能 |
|-----------|------|-----------|
| `index.html` | HTML構造 | ダッシュボードのDOM構造のみ |
| `styles.css` | スタイルシート | 全スタイル定義（レスポンシブ対応含む） |
| `ui_components.js` | 定数・ユーティリティ | 設定定数、ユーティリティ関数、DOM要素キャッシュ |
| `charts.js` | チャート管理 | uPlotチャート初期化・加速度チャート描画 |
| `course-map.js` | コースマップ | Canvas描画、走行軌跡、車両位置表示 |
| `websocket.js` | WebSocket通信 | 接続管理、テレメトリデータ処理、ラップ管理 |
| `test-mode.js` | テストモード | デモデータ生成、PS5なしの動作確認 |
| `app.js` | エントリーポイント | 各モジュールの初期化 |

### 設定ファイル

| ファイル名 | 説明 |
|-----------|------|
| `config.json` | ネットワーク設定 |
| `packet_def.json` | パケット定義（オフセットとデータ型） |
| `course_database.json` | コースデータベース |

### その他

| ファイル名 | 説明 |
|-----------|------|
| `Dockerfile` | Dockerイメージ定義 |
| `docker-compose.yml` | Docker Compose設定 |
| `requirements.txt` | Python依存パッケージ |
| `uplot.min.js` | uPlotグラフライブラリ |
| `uplot.min.css` | uPlotスタイルシート |

## データフロー

### 1. 初期化フェーズ

```
1. Dockerコンテナ起動
   └─> main.py 開始
       └─> config.json 読み込み
       └─> course_database.json 読み込み
       └─> packet_def.json 読み込み
       └─> HTTP/WebSocketサーバー起動 (Port 8080)
       └─> GT7TelemetryClient 初期化
```

### 2. データ受信フェーズ

```
1. ブラウザでダッシュボードを開く
   └─> WebSocket接続確立 (ws://localhost:8080/ws)

2. PS5にハートビート送信
   └─> "A" パケット送信 (Port 33739)
       └─> GT7がテレメトリ送信を開始

3. テレメトリパケット受信
   └─> UDP Port 33740 で受信
       └─> Salsa20復号
       └─> パケット解析
       └─> コース推定
       └─> WebSocket経由でブラウザに配信
```

### 3. 表示更新フェーズ

```
1. ブラウザでデータ受信
   └─> JSONデータをパース
       └─> UI要素を更新
       └─> チャートデータを追加
       └─> コースマップを更新
```

## 暗号化

GT7のテレメトリパケットはSalsa20で暗号化されています。

### 暗号化パラメータ

| パラメータ | 値 |
|-----------|---|
| アルゴリズム | Salsa20 |
| キー | `Simulator Interface Packet GT7 ver 0.0` |
| IV生成 | パケットオフセット0x40-0x47 |
| マジックナンバー | `0x47375330` ("G7S0") |

## コース推定

GT7のテレメトリパケットにはコースIDが含まれていないため、位置座標 (X, Z) からコースを推定します。

### 推定アルゴリズム

1. 現在の座標 (X, Z) を取得
2. コースデータベースの各コースの境界と比較
3. 座標が含まれるコースを特定
4. 複数のコースに含まれる場合、過去の履歴から判定

## テストモード

PS5がなくてもダッシュボードの動作を確認できる機能です。

### デモデータ生成

- 事前定義されたコース座標（スズカサーキット）
- ランダムに変化する速度、RPM、ギア
- シミュレートされたペダル入力
- タイヤ温度の変化

## データ保存

受信したテレメトリデータは `gt7data/` ディレクトリに保存されます。

### 保存条件

- ラップが完了したとき
- 車種IDが変わったとき

### ファイル名形式

```
{timestamp}_{car_id}_{lap_count}.json
```

## スケーラビリティ

### 同時接続

- 複数のブラウザから同時にアクセス可能
- 各クライアントは独立したWebSocket接続

### データ配信

- 1つのPS5接続に対して、複数のクライアントに配信
- 約60Hzでデータ更新

## セキュリティ

### デフォルト設定

- HTTP/WebSocketポート 8080 はローカルホストでのみアクセス可能
- 外部公開するにはポートマッピングが必要

### 推奨設定

- ファイアウォールで必要なポートのみ開放
- SSL/TLSを使用（本番環境）

---

**最終更新**: 2026-02-13

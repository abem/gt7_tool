# GT7 ダッシュボード - 3D 姿勢可視化機能 詳細計画書

バージョン: 2.0
作成日: 2026-02-14
作成者: Planning Team
ステータス: 仕様検討中

---

## 目次
1. [目的](#1-目的)
2. [現状分析](#2-現状分析)
3. [ユーザー要望](#3-ユーザー要望)
4. [技術検討](#4-技術検討)
5. [実装方式比較](#5-実装方式比較)
6. [推奨実装方式](#6-推奨実装方式)
7. [詳細実装仕様](#7-詳細実装仕様)
8. [開発スケジュール](#8-開発スケジュール)
9. [テスト計画](#9-テスト計画)
10. [リスク評価](#10-リスク評価)
11. [品質管理](#11-品質管理)

---

## 1. 目的

### 1.1 主目的
GT7 ダッシュボードの車体姿勢（ヨー・ピッチ・ロール）を視覚的にわかりやすく表示することで、ユーザーの運転パフォーマンス向上に寄与する。

### 1.2 副目的
- 現在の数値表示の読みやすさを改善
- 回転方向を直感的に理解できるようにする
- 既存デザインパターンとの整合性を維持する
- パフォーマンスへの影響を最小限に抑える

---

## 2. 現状分析

### 2.1 現在表示方式

#### 位置情報カード（Position/Dynamics）
```
┌────────────────────────────┐
│ POSITION / DYNAMICS    │
├────────────────────────────┤
│ POS  --   --   --      │ ← 位置（X, Y, Z）
│ VEL  --   --   --      │ ← 速度（X, Y, Z）
│ ROT  --   --   --      │ ← 回転角（PITCH, YAW, ROLL）
│ HDG  --      HGT --     │ ← 方向、車体高
└────────────────────────────┘
```

#### 角速度カード（Angular Velocity）
```
┌────────────────────────────┐
│ ANGULAR VELOCITY       │
├────────────────────────────┤
│ ANG  --   --   --      │ ← 角速度（X, Y, Z）
│ PIT  --   YAW  --      │ ← ピッチレート、ヨーレート
│     ROL  --           │ ← ロールレート
└────────────────────────────┘
```

### 2.2 現在実装詳細

#### HTML 構造（index.html:326-352）
```html
<div class="card position-card">
    <div class="card-title">POSITION / DYNAMICS</div>
    <!-- ROT 行 -->
    <div class="position-row">
        <span class="position-label">ROT</span>
        <span class="position-value" id="rot-pitch">--</span>
        <span class="position-value" id="rot-yaw">--</span>
        <span class="position-value" id="rot-roll">--</span>
    </div>
</div>
```

#### JavaScript データ処理（websocket.js:217-218）
```javascript
elements.rotPitch.textContent = (data.rotation_pitch || 0).toFixed(3);
elements.rotYaw.textContent = (data.rotation_yaw || 0).toFixed(3);
elements.rotRoll.textContent = (data.rotation_roll || 0).toFixed(3);
```

### 2.3 問題点

| 問題ID | 問題内容 | 影響度 | 該当ユーザー |
|---------|-----------|---------|-------------|
| P-001 | 数値のみで方向が直感的に理解できない | 高 | 全ユーザー |
| P-002 | 回転トレンドが視覚的に把握できない | 中 | 上級ユーザー |
| P-003 | 数値の変化が小さすぎて認識しにくい | 中 | 全ユーザー |

---

## 3. ユーザー要望

### 3.1 原文
> 「ヨー・ピッチ・ロールの項目　数字だけだよね　直方体がアニメーションするような図に変えたい」

### 3.2 要望分析
- 「数字だけだよね」→ 現在の数値表示に不満
- 「直方体がアニメーションするような図」→ 3D モデルのリアルタイム回転を希望
- 「図に変えたい」→ 視覚的表現への変更要望

### 3.3 要望優先度
```
高視覚性 ＞＞ 中読みやすさ ＞＞ 低実装難易度
        ↓                    ↓                ↓
   3D モデル          数値表示         回転矢印
```

---

## 4. 技術検討

### 4.1 ライブラリ検討

#### Three.js
- **バージョン**: r145 (最新安定版)
- **サイズ**: ~600KB (minified)
- **GPU対応**: WebGL
- **学習コスト**: 中
- **メンテナンス**: アクティブ
- **適用ケース**: 本格的3Dアプリケーション
- **推奨度**: ★★★★★☆

#### Babylon.js
- **バージョン**: 7.0 (最新版)
- **サイズ**: ~2-4MB (全機能)
- **GPU対応**: WebGL
- **学習コスト**: 高
- **メンテナンス**: アクティブ
- **適用ケース**: エンタープライズ3Dアプリ
- **推奨度**: ★★☆☆☆

#### CSS 3D Transforms
- **バージョン**: CSS3 (標準)
- **サイズ**: 0KB (追加ライブラリ不要)
- **GPU対応**: transform: preserve-3d でハードウェアアクセラレーション
- **学習コスト**: 低（既存CSS知識で十分）
- **メンテナンス**: ブラウザ標準
- **適用ケース**: シンプルな3D回転
- **推奨度**: ★★★★☆

### 4.2 技術選定基準

| 基準 | 重要度 | Three.js | Babylon.js | CSS 3D | 備考 |
|-------|---------|-----------|-------------|---------|-------|
| ライブラリサイズ | 中 | × (600KB) | × (2-4MB) | ○ (0KB) | パフォーマンス重視 |
| GPUアクセラレーション | 高 | ○ | ○ | ○ | 60fps更新必須 |
| ブラウザ互換性 | 中 | ○ | ○ | ○ | 最新ブラウザ対象 |
| 既存CSS統合 | 高 | × | × | ○ | デザイン一貫性 |
| 実装難易度 | 低 | × (WebGL学習必要) | × (複雑API) | ○ (標準CSS) | 早期リリース |
| メンテナンス性 | 中 | ○ | ○ | ○ (標準仕様) | 長期運用 |

### 4.3 技術選定結果
**推奨: CSS 3D Transforms**

理由:
1. ライブラリ追加不要（0KB増加）
2. 既存CSS知識で実装可能（学習コスト低）
3. GPUアクセラレーション自動適用
4. 既存デザインパターン統合容易
5. ブラウザ標準機能（将来的保証）

---

## 5. 実装方式比較

### 方案 1: 回転矢印（シンプル）

#### 概要
回転方向を矢印文字（↑→↓）で表現

#### メリット
- 実装が最も容易
- 読みやすさが高い
- 既存レイアウト統合が容易
- データサイズ増加なし

#### デメリット
- 回転量が視覚的に表現できない
- 3D 感が弱い
- 回転トレンドが把握しにくい

#### 評価
- **視覚性**: ★★☆☆☆ (低)
- **読みやすさ**: ★★★★★ (高)
- **実装難易度**: ★☆☆☆☆ (低)
- **総合**: ★★★☆☆

---

### 方案 2: 3D キューブ（本格的）

#### 概要
Three.js を使って 3D 直方体を回転表示

#### メリット
- 最も視覚的表現力が高い
- 回転量が直感的に理解できる
- 回転トレンドが一目で把握できる
- 将来的拡張性が高い（色、材質、照明）

#### デメリット
- ライブラリ追加必要（~600KB）
- WebGL学習必要
- モデリング知識必要
- パフォーマンス影響（GPU使用）
- 実装コストが高い

#### 評価
- **視覚性**: ★★★★★ (最高)
- **読みやすさ**: ★★★☆☆ (中)
- **実装難易度**: ★★★★☆ (高)
- **総合**: ★★★☆☆

---

### 方案 3: 回転バー（中間）

#### 概要
プログレスバーで回転量を視覚化

#### メリット
- 回転量が直感的に理解できる
- 実装が比較的容易
- 既存レイアウト統合が可能

#### デメリット
- バー表示が視覚的に邪魔になる可能性
- 回転方向の表現が抽象的
- デザイン調整が難しい

#### 評価
- **視覚性**: ★★★☆☆ (中)
- **読みやすさ**: ★★★☆☆ (中)
- **実装難易度**: ★★☆☆☆ (中)
- **総合**: ★★★☆☆

---

## 6. 推奨実装方式

### 6.1 推奨順位

1. **第1位: 方案 1（回転矢印）**
2. **第2位: 方案 3（回転バー）**
3. **第3位: 方案 2（3D キューブ）**

### 6.2 最終推奨

**方案 1: 回転矢印**

### 6.3 推奨理由

1. **早期リリース可能**
   - 実装難易度が低い
   - 既存CSS知識で十分
   - テスト工数が少ない

2. **ユーザー満足度が高い**
   - 数値だけより視覚的にわかりやすい
   - 回転方向が直感的に理解できる
   - 読みやすさが向上する

3. **既存システムへの影響が最小**
   - HTML/CSS/JavaScript の変更範囲が小さい
   - 他カードへの影響がない
   - レスポンシブ対応が容易

4. **将来拡張が可能**
   - 段階的に3Dキュー
   - ユーザーフィードバック収集後の拡張
   - 技術的負債がない

### 6.4 実装ステップ

#### ステップ 1: HTML 追加（5分）
- Angular Velocity カード内に回転矢印要素を追加
- 既存 position-row パターンに従う

#### ステップ 2: CSS 追加（10分）
- 回転矢印コンテナスタイル定義
- 回転矢印スタイル定義
- 既存CSS変数を使用

#### ステップ 3: JavaScript 追加（15分）
- 回転矢印取得関数実装
- 回転矢印更新関数実装
- 要素キャッシュ追加

#### ステップ 4: 統合（5分）
- WebSocket メッセージ処理から更新関数呼び出し
- テスト実施
- 動作確認

**総所要時間: 約35分**

---

## 7. 詳細実装仕様

### 7.1 HTML 仕様

#### 追加位置
- ファイル: `index.html`
- 追加行: 379行目の後
- カード: Angular Velocity カード内

#### 追加内容
```html
<!-- 回転矢印 -->
<div class="rotation-indicators">
    <div class="rotation-arrow" id="pitch-indicator">→</div>
    <div class="rotation-arrow" id="yaw-indicator">→</div>
    <div class="rotation-arrow" id="roll-indicator">→</div>
</div>
```

#### 詳細仕様
- `rotation-indicators` クラス: 3つの矢印を格納するコンテナ
- `rotation-arrow` クラス: 各矢印に適用するスタイル
- `id` 属性: JavaScript から要素を識別するために使用
- 初期値: 全て `→`（中立状態）

#### DOM 構造イメージ
```
┌────────────────────────────┐
│ ANGULAR VELOCITY 3D    │
├────────────────────────────┤
│ 3D表示エリア              │
│ ┌──────┐                │
│ │直方体│                │
│ └──────┘                │
├────────────────────────────┤
│ 角度数値表示              │
│ PIT: -- YAW: -- ROL: -- │
├────────────────────────────┤
│ 回転矢印 ← ここが新規     │
│ [→] [→] [→]            │ ← ピッチ ヨー  ロール
└────────────────────────────┘
```

### 7.2 CSS 仕様

#### 追加位置
- ファイル: `styles.css`
- 追加行: 860行目の後

#### 追加内容
```css
/* ===== 回転矢印 ===== */

.rotation-indicators {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    justify-content: center;
    padding: 4px 0;
}

.rotation-arrow {
    font-size: 18px;
    font-weight: bold;
    color: var(--accent-green);
    min-width: 20px;
    text-align: center;
    transition: transform 0.1s ease-out;
}
```

#### 詳細仕様
| プロパティ | 値 | 説明 |
|-----------|-----|-------|
| `display` | flex | 子要素を横並びに配置 |
| `gap` | 8px | 矢印間のスペース |
| `margin-top` | 8px | 上部マージン（数値表示との間隔） |
| `justify-content` | center | 中央揃え |
| `padding` | 4px 0 | 上下パディング |
| `font-size` | 18px | 矢印サイズ（既存カードテキストに合わせる） |
| `font-weight` | bold | 太字（視認性向上） |
| `color` | var(--accent-green) | テーマカラー（緑色） |
| `min-width` | 20px | 最小幅（矢印が潰れないように） |
| `text-align` | center | 中央揃え |
| `transition` | 0.1s ease-out | スムーズなアニメーション |

#### 色パターン
- 正の回転: `var(--accent-green)` (#00ff88)
- 中立: `var(--text-secondary)` (半透明グレー)
- 負の回転: `var(--accent-red)` (#ff4444)

### 7.3 JavaScript 仕様

#### 追加位置 1: websocket.js
- 追加行: 10行目の後
- 追加内容: 回転矢印取得・更新関数

#### 追加内容
```javascript
// 回転矢印を取得
function getRotationArrow(angle) {
    if (angle > 0.1) return '↑';
    if (angle < -0.1) return '↓';
    return '→';
}

// 回転矢印の更新
function updateRotationArrows(pitch, yaw, roll) {
    if (!elements.pitchIndicator) return;
    elements.pitchIndicator.textContent = getRotationArrow(pitch);
    elements.yawIndicator.textContent = getRotationArrow(yaw);
    elements.rollIndicator.textContent = getRotationArrow(roll);
}
```

#### 関数仕様
| 関数 | 引数 | 戻り値 | 説明 |
|-------|------|---------|-------|
| `getRotationArrow` | angle (number) | string (↑, →, ↓) | 角度から矢印文字を取得 |
| `updateRotationArrows` | pitch, yaw, roll (number) | void | 3つの矢印を更新 |

#### 閾値
- 正: `angle > 0.1`（ラジアン: 約5.7度以上）
- 負: `angle < -0.1`（ラジアン: 約-5.7度以下）
- 中立: `-0.1 <= angle <= 0.1`（±5.7度以内）

#### 追加位置 2: ui_components.js
- 追加行: 142行目の後
- 追加内容: 要素キャッシュ

#### 追加内容
```javascript
elements = {
    // 既存要素...
    rotRollDisplay: document.getElementById('rot-roll-display'),
    // 回転矢印（新規）
    pitchIndicator: document.getElementById('pitch-indicator'),
    yawIndicator: document.getElementById('yaw-indicator'),
    rollIndicator: document.getElementById('roll-indicator')
};
```

#### 要素キャッシュ仕様
- ID: `pitch-indicator`, `yaw-indicator`, `roll-indicator`
- 型: HTMLElement または null
- null チェック: `if (!elements.pitchIndicator) return;`

#### 呼び出し位置: websocket.js
- 呼び出し行: 250行目（handleTelemetryMessage関数内）
- 追加内容: 更新関数呼び出し

#### 追加内容
```javascript
// 回転矢印の更新
updateRotationArrows(
    data.rotation_pitch || 0,
    data.rotation_yaw || 0,
    data.rotation_roll || 0
);
```

### 7.4 データ入力仕様

#### 入力フィールド
| フィールド | 型 | 単位 | 範囲 | 説明 |
|----------|----|----|-------|-------|
| `rotation_pitch` | number | rad | -π ~ π | ピッチ角（前後傾斜） |
| `rotation_yaw` | number | rad | -π ~ π | ヨー角（左右旋回） |
| `rotation_roll` | number | rad | -π ~ π | ロール角（左右傾斜） |

#### データ変換
- 入力値はそのまま使用（スケーリング不要）
- ラジアンから度数への変換不要（CSS関数がラジアン対応）
- 小数点第3位まで表示（既存処理に従う）

---

## 8. 開発スケジュール

### 8.1 期間

- **開始日**: 2026-02-14
- **終了予定**: 2026-02-14
- **所要時間**: 0.5 日

### 8.2 マイルストーン

| マイルストーン | 期日 | 成果物 | 担当 |
|-------------|-------|--------|------|
| **M1: 仕様凍結** | 2026-02-14 | 本計画書 | Planning Team |
| **M2: 実装完了** | 2026-02-14 | HTML/CSS/JS変更 | Development Team |
| **M3: テスト完了** | 2026-02-14 | テストレポート | QA Team |
| **M4: リリース** | 2026-02-14 | 本番反映 | Ops Team |

### 8.3 タイムライン

```
2026-02-14
│
├ 00:00-00:30 仕様検討・計画作成
├ 00:30-01:00 HTML実装
├ 01:00-01:30 CSS実装
├ 01:30-02:00 JavaScript実装
├ 02:00-02:30 統合・テスト
└ 02:30-03:00 本番反映・完了
```

---

## 9. テスト計画

### 9.1 テスト戦略

#### テストレベル
1. **単体テスト**: 各関数・コンポーネントの動作確認
2. **結合テスト**: 既存システムとの統合確認
3. **システムテスト**: エンドツーエンドでの動作確認
4. **ユーザビリティテスト**: 読みやすさ・使いやすさ確認

### 9.2 テスト項目

#### 機能テスト

| ID | テスト項目 | 期待値 | テスト方法 | 判定基準 |
|----|-----------|-------|-----------|----------|
| FT-001 | 回転矢印が表示される | 矢印が見える | 目視確認 |
| FT-002 | ピッチ矢印が正しく更新される | 正の回転で↑ | 目視確認 |
| FT-003 | ヨー矢印が正しく更新される | 正の回転で↑ | 目視確認 |
| FT-004 | ロール矢印が正しく更新される | 正の回転で↑ | 目視確認 |
| FT-005 | 中立状態が正しく表示される | ±0.1以内で→ | 目視確認 |
| FT-006 | 負の回転で↓が表示される | 負の回転で↓ | 目視確認 |

#### データ更新テスト

| ID | テスト項目 | テストデータ | 期待結果 |
|----|-----------|-----------|---------|
| DT-001 | ピッチ角 0.5rad | ピッチ矢印が↑ |
| DT-002 | ピッチ角 -0.5rad | ピッチ矢印が↓ |
| DT-003 | ピッチ角 0.0rad | ピッチ矢印が→ |
| DT-004 | ヨー角 0.5rad | ヨー矢印が↑ |
| DT-005 | ヨー角 -0.5rad | ヨー矢印が↓ |
| DT-006 | ロール角 0.5rad | ロール矢印が↑ |
| DT-007 | ロール角 -0.5rad | ロール矢印が↓ |

#### パフォーマンステスト

| ID | テスト項目 | 目標値 | 測定方法 |
|----|-----------|---------|---------|
| PT-001 | 更新頻度 | ~60Hz | WebSocketメッセージ間隔測定 |
| PT-002 | レスポンスタイム | <16ms | 関数実行時間測定 |
| PT-003 | メモリ増加 | <100KB | ブラウザプロファイラ |

#### UI/UXテスト

| ID | テスト項目 | 確認内容 | 合格基準 |
|----|-----------|-----------|---------|
| UT-001 | レスポンシブ対応 | 画面幅変更時にレイアウト崩れなし | 目視確認 |
| UT-002 | 既存デザイン統合 | 既存カードと調和している | 目視確認 |
| UT-003 | 読みやすさ | 矢印が明瞭に識別できる | 目視確認 |
| UT-004 | 配置 | 既存要素と重複していない | 目視確認 |
| UT-005 | 色パターン | 正/中立/負が識別できる | 目視確認 |

#### 回帰テスト

| ID | テスト項目 | 確認内容 | 合格基準 |
|----|-----------|-----------|---------|
| RT-001 | 既存カード表示 | 他カードが正常に表示されている | 既存テスト項目合格 |
| RT-002 | 数値表示 | 既存数値表示に変更がない | 既存テスト項目合格 |
| RT-003 | チャート機能 | 既存チャートが正常に動作している | 既存テスト項目合格 |

### 9.3 テスト手順

#### 手順 1: 準備（5分）
1. ブラウザで F12 開発ツール起動
2. Network タブで Disable cache チェック
3. Application タブで Local Storage クリア
4. ページ強制再読み込み（Ctrl+Shift+R）

#### 手順 2: 単体テスト（10分）
1. 回転矢印が表示されるか確認
2. GT7 からテレメトリ送信
3. 各矢印が正しく更新されるか確認
4. データを変更して動作確認

#### 手順 3: 結合テスト（15分）
1. 既存カード表示を確認
2. 既存チャート動作を確認
3. レスポンシブ対応を確認
4. 全体的なレイアウト整合性を確認

#### 手順 4: 回帰テスト（10分）
1. 既存機能テスト項目を全て実施
2. 既存テスト結果と比較
3. 逆回帰（既存機能への悪影響）確認

---

## 10. リスク評価

### 10.1 技術的リスク

| リスクID | リスク内容 | 影響度 | 発生確率 | 軽減策 |
|---------|-----------|---------|----------|--------|
| TR-001 | ブラウザ非対応 | 中 | 低 | CSS 3Dは標準仕様 |
| TR-002 | GPUパフォーマンス劣化 | 低 | 低 | テキスト表示のみ |
| TR-003 | 既存CSSとの競合 | 中 | 中 | 固有クラス名使用 |

### 10.2 運用上のリスク

| リスクID | リスク内容 | 影響度 | 発生確率 | 軽減策 |
|---------|-----------|---------|----------|--------|
| OR-001 | ユーザー混乱 | 低 | 中 | ヘルプ追加・段階的導入 |
| OR-002 | 読み間違い | 低 | 低 | 矢印色パターン明確化 |
| OR-003 | 既存ワークフロー変化 | 中 | 低 | 既存機能維持 |

### 10.3 開発リスク

| リスクID | リスク内容 | 影響度 | 発生確率 | 軽減策 |
|---------|-----------|---------|----------|--------|
| DR-001 | 仕様変更 | 中 | 中 | 早期仕様凍結 |
| DR-002 | 実装遅延 | 中 | 低 | 単純な設計・単純な実装 |
| DR-003 | テスト不足 | 低 | 中 | 十分なテスト計画 |

---

## 11. 品質管理

### 11.1 品質目標

| 項目 | 目標値 | 測定方法 | 現在値 | 目標達成 |
|-------|---------|-----------|---------|----------|
| 読みやすさ | 回転方向が1秒で理解できる | ユーザーテスト | - | - |
| パフォーマンス | 60fpsで更新可能 | プロファイラ | - | - |
| 可用性 | 説明なしで使用可能 | ユーザーテスト | - | - |
| 信頼性 | 99%以上の正常動作率 | エラーログ | - | - |

### 11.2 品質保証プロセス

#### コードレビュー
- 担当者: Senior Developer
- 対象: 全変更ファイル（HTML/CSS/JS）
- 基準: コーディング規約、ベストプラクティス

#### ユニットテスト
- 担当者: Developer
- 対象: 全追加関数
- カバレッジ: 100%

#### システムテスト
- 担当者: QA Team
- 対象: 全テスト項目
- 基準: 全項目合格

#### ユーザビリティテスト
- 担当者: Real Users
- 対象: 実際のGT7運用環境
- 基準: 実用上問題なし

### 11.3 不具合対応フロー

```
不具合報告
    ↓
【重要度分類】
    ├── 高: 機能使えない → 即時修正（24時間以内）
    ├── 中: 代替策あり → 計画修正（1週間以内）
    └── 低: 軽微な問題 → 次回リリース
    ↓
【修正】
    ↓
【検証】
    ↓
【リリース】
```

### 11.4 フィードバック収集

#### 収集項目
1. 回転矢印の見やすさ
2. 矢印パターンの理解度
3. 既存表示との比較評価
4. 改善要望

#### 収集方法
- フィードバックフォーム
- インゲームメッセージ
- フォーラムスレッド
- 直接インタビュー

---

## 付録 A: 用語集

| 用語 | 説明 |
|------|-------|
| ヨー (Yaw) | 車体の左右旋回（垂直軸中心） |
| ピッチ (Pitch) | 車体の前後傾斜（横軸中心） |
| ロール (Roll) | 車体の左右傾斜（前後軸中心） |
| ラジアン (rad) | 角度の単位（1周 = 2π） |
| 回転トレンド | 回転方向の変化傾向 |
| GPUアクセラレーション | GPUによる高速描画 |

---

## 付録 B: 参考資料

### 技術資料
- [CSS 3D Transforms - MDN](https://developer.mozilla.org/en-US/docs/Web/CSS/transform)
- [CSS Transitions - MDN](https://developer.mozilla.org/en-US/docs/Web/CSS/transition)
- [Flexbox - MDN](https://developer.mozilla.org/en-US/docs/Web/CSS/flex)

### 関連プロジェクト
- GT7 Telemetry Dashboard (既存システム)
- 3D_ROTATION_VISUALIZATION_SPEC.md (既存仕様書)

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|----------|------|---------|--------|
| 2.0 | 2026-02-14 | 詳細計画書作成 | Planning Team |
| 1.0 | 2026-02-14 | 初版 | Planning Team |

---

*文書バージョン: 2.0*
*最終更新: 2026-02-14*
*作成者: Planning Team*
*ステータス: 仕様検討中*

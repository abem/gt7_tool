# TEST MODE ガイド

## 概要

TEST MODEは、PS5がなくてもダッシュボードの動作を確認できる機能です。デモデータが自動生成され、コースマップと各種表示がシミュレートされます。

## 使用方法

### 1. ダッシュボードを起動

```bash
docker compose up --build
```

### 2. ブラウザでダッシュボードを開く

```
http://localhost:8080
```

### 3. TEST MODEを有効化

ダッシュボード右上にある「TEST MODE」ボタンをクリックします。

### 4. デモデータの表示を確認

以下のデータがシミュレートされます：
- 速度、RPM、ギア位置の変化
- スロットル、ブレーキ入力
- タイヤ温度の変化
- サスペンション高さの変化
- コースマップ上の走行軌跡（スズカサーキット）

### 5. TEST MODEを停止

「STOP TEST」ボタンをクリックすると、デモデータの生成が停止します。

## デモコース

TEST MODEでは「スズカ サーキット (Demo)」が表示されます。これは事前定義されたコース座標データに基づいて、車両が周回している様子をシミュレートします。

### スズカサーキット セクション構成

デモトラジェクトリは、実際のスズカサーキットのレイアウトに基づいています：

1. **Start/Finishストレート**: 高速セクション（最高280 km/h）
2. **Turn 1**: 最初のコーナー（減速セクション）
3. **Degner Curve**: S字カーブ（左右の連続コーナー）
4. **ヘアピン**: 急減速コーナー
5. **Spoon Curve**: ダブルアクセスの左コーナー
6. **130R**: 高速右コーナー（伝説のコーナー）
7. **Casio Triangle**: 最終シケイン

## デモデータ仕様

### 生成されるデータ

| フィールド | 値の範囲 | 説明 |
|-----------|---------|------|
| position_x | -300～300 | コース上のX座標（スズカ） |
| position_z | -300～250 | コース上のZ座標（スズカ） |
| speed_kmh | 50～285 | コーナーごとに変化 |
| rpm | 2000～9500 | ギアに応じて変化 |
| gear | 1～6 | コーナーに応じて適切に変化 |
| throttle_pct | 0～100 | コーナーに応じて変化 |
| brake_pct | 0～80 | コーナー進入時に増加 |
| tyre_temp | 60～110 | 速度・負荷・ラップ数で変化 |
| susp_height | 60～95mm | ブレーキ・加速・空力で変化 |

### 更新頻度

デモデータは**10Hz**（100ms間隔）で更新されます。スムーズなアニメーションを実現しつつ、ブラウザのパフォーマンスを維持します。

### 物理シミュレーション

デモデータには以下の物理法則が組み込まれています：

1. **タイヤ温度**: 速度、横G、ラップ数に応じて変化
2. **サスペンション**: ブレーキ時のダイブ、加速時のスクワット、空力ダウンフォースを考慮
3. **タイヤ空気圧**: 温度上昇に伴う圧力増加（理想気体の法則）
4. **ラップタイム**: リアルな変動（1:34.000～1:37.000）

## TEST MODEの用途

### 開発時

- UI変更の視覚確認
- レスポンシブレイアウトのテスト
- 新機能の動作確認

### デモ・プレゼンテーション

- ダッシュボードの機能紹介
- UIデザインの共有
- スクリーンショット撮影

### トラブルシューティング

- PS5接続問題の切り分け
- ダッシュボード単体の動作確認

## エラーハンドリング

TEST MODEには以下のエラーハンドリングが実装されています：

- **トラジェクトリ検証**: デモトラジェクトリの妥当性チェック
- **要素存在確認**: DOM要素の存在確認
- **チャート検証**: チャートデータの整合性チェック
- **安全な実行**: すべての操作をtry-catchで保護

エラーが発生してもTEST MODEは継続され、コンソールに詳細なログが出力されます。

## TEST MODEの制限

- 実際の車両データとは異なります
- ラップタイムの記録はされません
- コース推定機能は使用されません（固定コース）
- データ保存機能は動作しません

## PS5接続との切り替え

TEST MODE中にPS5からテレメトリデータを受信すると、自動的に実データに切り替わります。

## 関連ファイル

- `index.html`: TEST MODEボタンのHTML構造
- `test-mode.js`: テストモードのロジック（デモデータ生成・開始・停止）
- `ui_components.js`: DOM要素キャッシュ（テストモードが使用）
- `course-map.js`: コースマップ描画（テストモードから呼び出し）
- `course_database.json`: コース情報とTEST MODE設定

## トラブルシューティング

### TEST MODEボタンが反応しない

- ブラウザをリロード (F5)
- JavaScriptコンソールでエラーを確認 (F12)
- WebSocket接続が確立されているか確認

### デモデータが表示されない

- WebSocket接続が確立されているか確認
- コンソールログでエラーを確認
- ブラウザのコンソールで`[TEST_MODE]`タグのログを確認

### チャートが更新されない

- uPlotライブラリが正しく読み込まれているか確認
- ブラウザをリロード

---

**最終更新**: 2026-02-13
**バージョン**: 2.1.0（フロントエンドモジュール分割）

# GT7 Telemetry Dashboard

グランツーリスモ7 (GT7) 用のリアルタイム・テレメトリーダッシュボードです。

## 概要

PS5/PS4から送信されるテレメトリーパケットを受信・復号し、WebSocket経由でウェブブラウザ上のダッシュボードに表示します。

### 特徴
- **リアルタイム表示**: 速度、回転数 (RPM)、ギア、アクセル開度、ブレーキ開度
- **タイヤ詳細**: 4つのタイヤの温度、サスペンション高さ、ホイール回転数、タイヤ半径
- **Webダッシュボード**: HTML/JS製のシンプルなフロントエンド（カスタマイズ容易）
- **Docker対応**: Docker Compose で環境構築が不要
- **設定分離**: パケット定義やネットワーク設定をJSONで外出し

## 必須環境

- **グランツーリスモ7** (PS5/PS4)
- **Docker** (version 20.10+)
- **Docker Compose** (version 2.0+)

## インストールとセットアップ手順

### 手順1: PS5とPCを同じネットワークに接続

重要: PS5とPCは同じWi-Fiまたは有線LANで接続されている必要があります。

#### PS5でIPアドレスを確認する方法:

1. PS5で **設定 (⚙️)** → **ネットワーク (ネットワーク設定)** → **Wi-Fi** または **LANケーブル**
2. 接続中のネットワークの詳細を確認
3. **IPアドレス (IPアドレス)** をメモします

例: `192.168.1.10`

### 手順2: リポジトリをクローンまたはダウンロード

```bash
# クローンの場合
git clone <リポジトリURL>
cd gt7_tool

# ダウンロードした場合
cd gt7_tool
```

### 手順3: config.jsonを編集

```bash
# エディタで開く
nano config.json
# または
vim config.json
```

PS5のIPアドレスを設定します:

```json
{
    "ps5_ip": "192.168.1.10",   <-- ここをPS5のIPアドレスに変更
    "gt7_port": 33739,
    "ws_port": 8080,
    "heartbeat_interval": 10
}
```

**重要:** `ps5_ip` をPS5の実際のIPアドレスに変更してください。

### 手順4: Dockerを起動

```bash
docker compose up --build
```

以下のメッセージが表示されれば成功です:

```
Starting GT7 Dashboard Server on port 8080...
Sending heartbeat to 192.168.1.10:33739
Client connected. Starting stream...
```

### 手順5: ダッシュボードを開く

ブラウザで以下のURLを開きます:

```
http://localhost:8080
```

または、PCとPS5が同じLAN内であれば:

```
http://<PS5のIPアドレス>:8080
```

## ダッシュボードの表示項目

### 基本情報
- **GEAR**: 現在のギア (R, N, 1-6)
- **speed**: 速度 (km/h)
- **RPM**: エンジン回転数
- **ブレーキ/アクセル**: パドルの入力値

### タイヤ詳細情報
4つのタイヤ（FL/FR/RL/RR）ごとに以下を表示:

1. **温度 (温度)**
   - タイヤの温度（°C）
   - 色で視覚化: 青→緑→赤 (低温→最適→高温)
   - 適切な温度: 約60-80°C

2. **サスペンション高さ (サスペンション)**
   - 各タイヤのサスペンション位置
   - タイヤの接地状況を監視

3. **ホイール回転数 (回転数)**
   - タイヤの回転速度
   - タイヤスリップの有無を推測

4. **タイヤ半径 (タイヤ半径)**
   - タイヤの半径 (m)
   - 車種ごとの情報

## 動作確認の方法

### 確認手順:

1. PS5を起動し、GT7を開く
2. **コントローラー (コントローラー接続)** をONにする
3. **ネットワーク (通信設定)** → **テレメトリーデータ送信 (通信設定)** → **ON** に設定
4. Dockerコンテナが起動していることを確認
5. ブラウザでダッシュボードを開く
6. レースまたはタイムアタックで走行開始
7. ダッシュボードがリアルタイムに更新されることを確認

### 停止方法:

```bash
# Ctrl+C で停止
# または
docker compose down
```

### 再起動:

```bash
docker compose restart
```

## アプリの停止（PS5側）

ダッシュボードは必要なくなったら、PS5側でも停止できます:

1. GT7で **ネットワーク (通信設定)** → **テレメトリーデータ送信 (通信設定)**
2. **OFF** に設定

これでテレメトリーパケットが送信されなくなり、コンソールの負荷が軽減されます。

## 故障時のトラブルシューティング

### 問題1: "Client connected" が表示されない

**原因:**
- PS5のIPアドレスが間違っている
- PS5とPCが同じネットワークに接続されていない
- PS5のテレメトリーデータ送信がOFFになっている

**解決方法:**
1. `config.json` の `ps5_ip` が正しいか確認
2. PS5の設定で「テレメトリーデータ送信」がONになっているか確認
3. `docker compose logs` でログを確認

### 問題2: データが表示されない

**原因:**
- GT7が起動していない
- レース画面が表示されていない

**解決方法:**
1. GT7を起動する
2. 「タイムアタック」または「レース」画面で走行を開始

### 問題3: ネットワークエラーが発生する

**解決方法:**
1. `docker compose down` でコンテナを停止
2. `docker compose up --build` で再起動

## 構成

- **`main.py`**: エントリーポイント。WebSocketサーバー (`asyncio` + `websockets`) を実行します。
- **`telemetry.py`**: PS5とのUDP通信（ハートビート `A` パケット送信など）を管理します。
- **`decoder.py`**: Salsa20で暗号化されたパケットを復号し、`packet_def.json` に基づいてデータを解析します。
- **`packet_def.json`**: テレメトリーデータのメモリオフセットとデータ型を定義しています。
- **`config.json`**: ネットワーク設定ファイル。
- **`index.html`**: ウェブブラウザ上のダッシュボード（CSS/JavaScript）。
- **`Dockerfile`**: Python環境のDockerイメージ。
- **`docker-compose.yml`**: Docker Compose設定ファイル。

## カスタマイズ方法

### 新しいデータ項目を追加する場合:

1. GT7テレメトリーの仕様（コミュニティ等のドキュメント）でオフセットを探します。
2. `packet_def.json` にフィールドを追加します:
   ```json
   "boost_pressure": {"offset": "0x50", "type": "float"}
   ```
3. `index.html` を編集して、新しいデータを表示するようにします。
4. `docker compose restart` で再起動します。

### UIの変更:

`index.html` 内の `<style>` セクションを編集することで、色やレイアウトを自由に変更できます。

## セキュリティ

- **デフォルトで公開されません**: Dockerポート 8080 はローカルホスト (`localhost`) でのみアクセス可能です。
- **外部アクセス**: 本番環境では、ポートマッピングを避けるか、ファイアウォールで制限してください。

## ライセンス

MIT License

## クレジット

このツールは、GT7/GT Sportのテレメトリーに必要なSalsa20復号ロジックを使用しています。

**暗号化キー:** `Simulator Interface Packet GT7 ver 0.0`

## 更新履歴

- **2026-02-09**: タイヤ詳細表示機能を追加
  - タイヤ温度、サスペンション高さ、ホイール回転数、タイヤ半径を表示
  - タイヤ温度を色で視覚化
  - decoder.pyの配列型処理のバグを修正

---

*My shape is designed to be trusted by you.*

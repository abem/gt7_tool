# GT7 Telemetry Dashboard

グランツーリスモ7 (GT7) 用のリアルタイム・テレメトリダッシュボードです。

## 概要

PS5/PS4から送信されるテレメトリパケットを受信・復号し、WebSocket経由でウェブブラウザ上のダッシュボードに表示します。

### 特徴
- **リアルタイム表示**: 速度、RPM、ギア（推奨ギア含む）、ステアリング角度
- **ペダル入力**: アクセル/ブレーキ/クラッチの生値 + TCS/ABS補正後の値
- **タイヤ詳細**: 4輪の温度、サスペンション高さ、ホイール回転速度、タイヤ半径
- **車体情報**: 加速度G、車体加速度（sway/heave/surge）、路面法線ベクトル
- **駆動系**: ギア比表示、トルクベクタリング、回生エネルギー（EV/ハイブリッド）
- **燃料管理**: 残量、タンク容量、1周あたり消費量、残り周回予測
- **コース推定機能**: 位置座標から走行中のコースを自動判定
- **コースマップ表示**: リアルタイムの走行軌跡を速度別色分け表示
- **ラップ管理**: ラップタイム記録、ベストラップ、速度デルタ
- **Webダッシュボード**: HTML/JS製のシンプルなフロントエンド（カスタマイズ容易）
- **Docker対応**: Docker Compose で環境構築が不要
- **テストモード**: PS5がなくてもデモデータで動作確認可能
- **全パケット対応**: Packet A/B/~ の3種類に対応し、GT7が送信可能な全テレメトリを取得

## 必須環境

- **グランツーリスモ7** (PS5/PS4)
- **Docker** (version 20.10+)
- **Docker Compose** (version 2.0+)

## インストールとセットアップ手順

### 手順1: PS5とPCを同じネットワークに接続

重要: PS5とPCは同じWi-Fiまたは有線LANで接続されている必要があります。

#### PS5でIPアドレスを確認する方法:

1. PS5で **設定 (⚙️)** → **ネットワーク (ネットワーク設定)** → **Wi-Fi** または **LANケーブル**
2. 接続中のネットワークの詳細を確認
3. **IPアドレス (IPアドレス)** をメモします

例: `192.168.1.10`

### 手順2: リポジトリをクローンまたはダウンロード

```bash
# クローンの場合
git clone <リポジトリURL>
cd gt7_tool

# ダウンロードした場合
cd gt7_tool
```

### 手順3: config.jsonを編集

```bash
# エディタで開く
nano config.json
# または
vim config.json
```

PS5のIPアドレスを設定します:

```json
{
    "ps5_ip": "192.168.1.10",   <-- ここをPS5のIPアドレスに変更
    "gt7_port": 33739,
    "ws_port": 8080,
    "heartbeat_interval": 10
}
```

**重要:** `ps5_ip` をPS5の実際のIPアドレスに変更してください。

### 手順4: Dockerを起動

```bash
docker compose up --build
```

以下のメッセージが表示されれば成功です:

```
Starting GT7 Dashboard Server on port 8080...
Sending heartbeat to 192.168.1.10:33739
Client connected. Starting stream...
```

### 手順5: ダッシュボードを開く

ブラウザで以下のURLを開きます:

```
http://localhost:8080
```

または、PCとPS5が同じLAN内であれば:

```
http://<PS5のIPアドレス>:8080
```

## ダッシュボードの表示項目

### 速度・ギア
- **速度**: 現在速度 (km/h) + 最高速度記録
- **ギア**: 現在のギア (R, 1-8) + 推奨ギア
- **ステアリング角度**: ハンドルの回転角度 (°)
- **RPM**: エンジン回転数バー（レブリミッター・シフトポイント表示）

### ペダル入力
- **THR (スロットル)**: 入力値% + TCS補正後の値（オーバーレイ表示）
- **BRK (ブレーキ)**: 入力値% + ABS補正後の値（オーバーレイ表示）
- **CLT (クラッチ)**: クラッチペダル位置%

### タイヤ・サスペンション
4輪（FL/FR/RL/RR）ごとに:
- **温度**: 色分け表示（シアン→緑→黄→赤）
- **サスペンション高さ**: mm単位
- **ホイール回転速度**: rad/s
- **タイヤ半径**: m

### 車体・路面
- **加速度G**: 横G / 縦G + 加速度チャート
- **車体加速度**: sway(横)/heave(上下)/surge(前後)
- **路面法線**: NRM (x/y/z) + 路面距離

### 駆動系
- **ギア比**: 各ギアの変速比（現在ギアをハイライト表示）
- **トルクベクタリング**: 4輪のトルク配分
- **回生エネルギー**: EV/ハイブリッド車の回生量
- **ブースト圧 / 油圧**

### 燃料
- **残量 / タンク容量**
- **1周あたり消費量**
- **残り周回予測**

### コース情報
- **コース推定**: 位置座標から自動判定
- **コースマップ**: 走行軌跡を速度別に色分け表示
- **座標 / 速度ベクトル / 回転**: X/Y/Z各値

### ラップ情報
- **現在のラップ / 総ラップ**
- **経過ラップタイム**: リアルタイム表示
- **前回 / ベストラップタイム**
- **ラップ履歴**: タイム + ベスト差分デルタ
- **速度デルタ**: ベストラップとの同地点速度差

### レース・フラグ
- **スタート順位**: レース前のグリッドポジション
- **フラグ表示**: TCS / ASM / REV / P-BRK / LIGHT / TURBO

## 動作確認の方法

### 確認手順:

1. PS5を起動し、GT7を開く
2. **コントローラー (コントローラー接続)** をONにする
3. **ネットワーク (通信設定)** → **テレメトリデータ送信 (通信設定)** → **ON** に設定
4. Dockerコンテナが起動していることを確認
5. ブラウザでダッシュボードを開く
6. レースまたはタイムアタックで走行開始
7. ダッシュボードがリアルタイムに更新されることを確認

### 停止方法:

```bash
# Ctrl+C で停止
# または
docker compose down
```

### 再起動:

```bash
docker compose restart
```

## アプリの停止（PS5側）

ダッシュボードは必要なくなったら、PS5側でも停止できます:

1. GT7で **ネットワーク (通信設定)** → **テレメトリデータ送信 (通信設定)**
2. **OFF** に設定

これでテレメトリパケットが送信されなくなり、コンソールの負荷が軽減されます。

## 故障時のトラブルシューティング

### 問題1: "Client connected" が表示されない

**原因:**
- PS5のIPアドレスが間違っている
- PS5とPCが同じネットワークに接続されていない
- PS5のテレメトリデータ送信がOFFになっている

**解決方法:**
1. `config.json` の `ps5_ip` が正しいか確認
2. PS5の設定で「テレメトリデータ送信」がONになっているか確認
3. `docker compose logs` でログを確認

### 問題2: データが表示されない

**原因:**
- GT7が起動していない
- レース画面が表示されていない

**解決方法:**
1. GT7を起動する
2. 「タイムアタック」または「レース」画面で走行を開始

### 問題3: ネットワークエラーが発生する

**解決方法:**
1. `docker compose down` でコンテナを停止
2. `docker compose up --build` で再起動

## 構成

### バックエンド (Python)
- **`main.py`**: エントリーポイント。WebSocketサーバー (`asyncio` + `aiohttp`) を実行します。
- **`telemetry.py`**: PS5とのUDP通信（ハートビート送信など）を管理します。デフォルトでハートビート `~` を送信し、全フィールド（344 bytes）を取得します。
- **`decoder.py`**: Salsa20で暗号化されたパケットを復号・解析します。Packet A/B/~ の3種類に対応し、XOR自動フォールバック機能を持ちます。コース推定機能も含みます。

### フロントエンド (HTML/CSS/JS)
- **`index.html`**: ダッシュボードのHTML構造のみ。
- **`styles.css`**: 全スタイル定義（レスポンシブ対応）。
- **`ui_components.js`**: 定数・設定・ユーティリティ関数・DOM要素キャッシュ。
- **`charts.js`**: uPlotチャート初期化・加速度チャート管理。
- **`course-map.js`**: コースマップCanvas描画ロジック。
- **`websocket.js`**: WebSocket接続・テレメトリデータ処理・ラップ管理。
- **`test-mode.js`**: テストモード（デモデータ生成）。
- **`app.js`**: エントリーポイント（各モジュール初期化）。

### 設定・データ
- **`config.json`**: ネットワーク設定ファイル。
- **`packet_def.json`**: テレメトリデータのメモリオフセットとデータ型の参照用定義。デコーダはこのファイルを使用せず、`decoder.py` にハードコードされたオフセットが正となる。Packet A (296 bytes) の基本フィールドのみ記載。
- **`course_database.json`**: コースの座標範囲データベース。コース推定に使用されます。

### インフラ
- **`Dockerfile`**: Python環境のDockerイメージ。
- **`docker-compose.yml`**: Docker Compose設定ファイル。
- **`test_course_detection.py`**: コース検出機能のテストスクリプト。

## ドキュメント

### ユーザー向け

- **[ドキュメントトップ](docs/index.md)**: ドキュメントの目次
- **[ユーザーガイド](docs/USER_GUIDE.md)**: 詳細な使い方、トラブルシューティング、FAQ
- **[一般的な問題](docs/common-issues.md)**: トラブルシューティング
- **[TEST MODEガイド](docs/test-mode.md)**: テストモードの使い方

### 技術者向け

- **[APIドキュメント](docs/API.md)**: HTTP/WebSocket API、Pythonモジュールの詳細
- **[システムアーキテクチャ](docs/architecture.md)**: システム構成とデータフロー

## カスタマイズ方法

### 新しいデータ項目を追加する場合:

1. GT7テレメトリの仕様（コミュニティ等のドキュメント）でオフセットを探します。
2. `decoder.py` の `_extract_fields()` メソッドにフィールドを追加します。
3. `index.html` にHTML要素を追加し、`websocket.js` でデータ表示処理を追加します。
5. `docker compose restart` で再起動します。

### UIの変更:

`styles.css` を編集することで、色やレイアウトを自由に変更できます。JavaScript の機能追加は対応するモジュールファイル（`charts.js`, `course-map.js` 等）を編集してください。

### コースデータベースの更新:

実際のテレメトリデータから新しいコースを学習させるには:

```bash
python3 test_course_detection.py --data-dir gt7data
```

または手動で `course_database.json` にコース情報を追加します。

## セキュリティ

- **デフォルトで公開されません**: Dockerポート 8080 はローカルホスト (`localhost`) でのみアクセス可能です。
- **外部アクセス**: 本番環境では、ポートマッピングを避けるか、ファイアウォールで制限してください。

## ライセンス

MIT License

## クレジット

このツールは、GT7/GT Sportのテレメトリに必要なSalsa20復号ロジックを使用しています。

**暗号化キー:** `Simulator Interface Packet GT7 ver 0.0`

## バックエンド品質評価 (リファクタリング前: 38点/100点)

2026-02-13のリファクタリング前のバックエンドPythonコードに対する品質評価です。

### 正確性 (15 / 35点)

ハッピーパスは動作するが、複数の実バグが潜在していた。

| バグ | 深刻度 | 内容 |
|------|--------|------|
| `import aiohttp` 欠落 | クラッシュ | WebSocketエラー処理で `NameError` が発生 |
| `fuel_consumed` 未初期化 | クラッシュ | 条件分岐外で参照 → `UnboundLocalError` |
| 二重保存 | データ破損 | `except` + `finally` 両方でラップデータを保存 |
| メモリリーク | 長時間稼働で問題 | `all_laps.extend()` のみで参照・クリアなし |
| コース推定が死機能 | 機能欠落 | `estimate_course()` を初期化だけして未呼び出し |

### セキュリティ (3 / 10点)

- `static_handler` にパストラバーサル防止なし
- `/{filename}` が `/ws`, `/debug` より先にルート登録 → ルート衝突の可能性

### コード品質 (10 / 30点)

| 問題 | 内容 |
|------|------|
| グローバル変数14以上 | `last_fuel`, `total_consumed`, `all_laps` 等がモジュールレベルに散乱 |
| `print()` のみ | decoder.py, telemetry.py で `logging` 未使用 |
| bare `except:` | `KeyboardInterrupt`, `SystemExit` まで握りつぶす |
| デッドコード | `math_utils.py` (172行) がどこからもインポートされず |
| 未使用データ読み込み | `packet_def.json` をロードするが解析に一切使わない |

### 設計・構造 (10 / 25点)

ファイル分割（telemetry / decoder / main）やSalsa20復号の実装は妥当。ただし状態管理がグローバル変数の散乱でテスト不能、`CourseEstimator` を初期化するが使わない等、統合不足が目立つ。

### 総括

「動いているように見えるが、エッジケースで壊れる」典型的なLLM生成コード。ハッピーパスのプロトタイプとしては機能するが、長時間稼働するサーバーとしてはメモリリーク・クラッシュバグ・セキュリティホールがあり、そのまま運用するのは危険な状態だった。

## 更新履歴

- **2026-02-13**: 全テレメトリフィールド対応
  - ハートビートを `A` → `~` に変更し、Packet ~ (344 bytes) の全フィールドを取得
  - **バグ修正**: 0x94のタイヤ圧表示は誤り → 路面法線ベクトル (road_plane) に修正
  - **バグ修正**: 0x84のレース順位は誤り → スタート順位 (pre_race_position) + 参加台数 (num_cars_pre_race) の2つのint16に修正
  - ギア比表示 (0x104-0x120)、ステアリング角度、TCS/ABS補正後ペダル入力を追加
  - 車体加速度 (sway/heave/surge)、トルクベクタリング、回生エネルギーを追加
  - XOR自動フォールバック機能で全パケットタイプ (A/B/~) に対応
  - ドキュメントを全面更新

- **2026-02-13**: バックエンドPythonコードをリファクタリング
  - **改善前の品質評価: 38点/100点** (詳細は下記)
  - `main.py`: バグ修正5件、グローバル変数排除、FuelTrackerクラス導入 (464→297行)
  - `decoder.py`: logging導入、bare except修正、コース推定の実呼び出し追加 (351→243行)
  - `telemetry.py`: print()をloggingに統一
  - `math_utils.py`: 未使用デッドコード(172行)を削除
  - 合計 -447行の削減

- **2026-02-13**: フロントエンドをリファクタリング
  - モノリシックな `index.html` (1825行) を機能別ファイルに分割
  - CSS を `styles.css` に分離
  - JavaScript を `ui_components.js`, `charts.js`, `course-map.js`, `websocket.js`, `test-mode.js`, `app.js` に分割
  - 加速度チャートの表示を改善（専用カード化、ResizeObserver対応）
  - 旧コードの未使用ファイルを整理

- **2026-02-11**: ドキュメントを整備・実機テスト完了
  - APIドキュメント (docs/API.md) を追加
  - ユーザーガイド (docs/USER_GUIDE.md) を追加
  - コース推定機能、テストモードの説明を追加
  - 実機テストにより全機能動作確認 (10/10 PASS)
    - ページ表示、DOM要素、チャート表示、WebSocket接続、データ更新、タイヤ表示、サスペンション表示、レスポンシブレイアウト

- **2026-02-09**: コース推定・マップ表示機能を追加
  - 位置座標からの自動コース判定
  - リアルタイムコースマップ表示
  - テストモード (PS5なしで動作確認可能)
  - タイヤ詳細表示機能を追加
    - タイヤ温度、サスペンション高さ、ホイール回転数、タイヤ半径を表示
    - タイヤ温度を色で視覚化

## ブランチ構成

このプロジェクトはGit Flowのベストプラクティスに従って管理されています：

### ブランチタイプ

| ブランチ名 | 用途 | 更新頻度 |
|-----------|------|---------|
| **main** | メインブランチ（デフォルト） | バグ修正、ドキュメント更新のみ |
| **dev** | 開発ブランチ | 新機能開発、テスト |
| **feature-xxx** | 新しい機能を個別に開発 | 機能が完成するまで |

### 作業フロー

1. **機能を追加する場合:**
   ```bash
   git checkout dev
   git checkout -b feature-タイヤ温度表示拡張
   # 変更をコミット
   git checkout dev
   git merge feature-タイヤ温度表示拡張
   ```

2. **バグ修正やドキュメント更新:**
   ```bash
   git checkout main
   # 変更をコミット
   git push origin main
   ```

3. **パッチ適用:**
   ```bash
   git checkout main
   git pull origin main
   # バグ修正をコミット
   git push origin main
   ```

**注意:** masterブランチは廃止され、代わりにmainブランチを使用しています。

---

**最終更新**: 2026-02-13

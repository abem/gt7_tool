<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>GT7 WebSocket Capture</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0e1a; color: #e0e0e0; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; }
        .header { padding: 10px 16px; background: #121829; border-bottom: 1px solid #2a2a3a; display: flex; align-items: center; gap: 12px; }
        .header h1 { font-size: 14px; color: #00ff88; }
        #status { padding: 3px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        #status.connected { background: #00ff88; color: #000; }
        #status.disconnected { background: #ff4444; color: #fff; }
        #status.connecting { background: #ffd700; color: #000; }
        .controls { padding: 8px 16px; background: #0f1322; border-bottom: 1px solid #2a2a3a; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        button { padding: 4px 12px; border: 1px solid #444; border-radius: 4px; background: #1a1f33; color: #e0e0e0; cursor: pointer; font-size: 12px; }
        button:hover { background: #2a3050; }
        button.active { background: #00ff88; color: #000; border-color: #00ff88; }
        .stats { color: #6b7280; font-size: 11px; margin-left: auto; }
        .main { display: grid; grid-template-columns: 1fr 1fr; height: calc(100vh - 80px); }
        .panel { display: flex; flex-direction: column; border-right: 1px solid #2a2a3a; overflow: hidden; }
        .panel-title { padding: 6px 12px; background: #121829; font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #2a2a3a; }
        .values-grid { padding: 8px 12px; overflow-y: auto; flex: 1; }
        .field-row { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .field-name { color: #6b7280; }
        .field-value { color: #00ff88; font-weight: 600; text-align: right; }
        .field-value.zero { color: #ff4444; }
        .field-value.nested { color: #44ffff; }
        .raw-log { flex: 1; overflow-y: auto; padding: 8px 12px; font-size: 11px; line-height: 1.6; }
        .log-entry { border-bottom: 1px solid rgba(255,255,255,0.03); padding: 2px 0; white-space: pre-wrap; word-break: break-all; }
        .log-entry .ts { color: #6b7280; }
        .log-entry .pkt { color: #ffd700; }
    </style>
</head>
<body>
    <div class="header">
        <h1>GT7 WebSocket Capture</h1>
        <span id="status" class="disconnected">Disconnected</span>
        <span class="stats">Packets: <span id="pkt-count">0</span> | Last: <span id="last-time">--</span></span>
    </div>
    <div class="controls">
        <button id="btn-connect" onclick="toggleConnection()">Connect</button>
        <button id="btn-pause" onclick="togglePause()">Pause</button>
        <button onclick="clearLog()">Clear Log</button>
        <label style="color:#6b7280;font-size:11px;"><input type="checkbox" id="chk-raw" checked> Show Raw JSON</label>
    </div>
    <div class="main">
        <div class="panel">
            <div class="panel-title">Latest Parsed Values</div>
            <div class="values-grid" id="values"></div>
        </div>
        <div class="panel">
            <div class="panel-title">Raw WebSocket Log</div>
            <div class="raw-log" id="log"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let packetCount = 0;
        let paused = false;
        let lastData = null;

        function getWsUrl() {
            const host = location.hostname || 'localhost';
            const port = location.port || '8080';
            return `ws://${host}:${port}/ws`;
        }

        function toggleConnection() {
            if (ws && ws.readyState <= 1) {
                ws.close();
            } else {
                connect();
            }
        }

        function togglePause() {
            paused = !paused;
            document.getElementById('btn-pause').classList.toggle('active', paused);
            document.getElementById('btn-pause').textContent = paused ? 'Resume' : 'Pause';
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function connect() {
            const url = getWsUrl();
            const statusEl = document.getElementById('status');
            const btnEl = document.getElementById('btn-connect');

            statusEl.textContent = 'Connecting...';
            statusEl.className = 'connecting';

            try {
                ws = new WebSocket(url);
            } catch (e) {
                statusEl.textContent = 'Failed';
                statusEl.className = 'disconnected';
                addLog('ERROR', 'WebSocket creation failed: ' + e.message);
                return;
            }

            ws.onopen = () => {
                statusEl.textContent = 'Connected';
                statusEl.className = 'connected';
                btnEl.textContent = 'Disconnect';
                addLog('INFO', 'Connected to ' + url);
            };

            ws.onclose = (e) => {
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'disconnected';
                btnEl.textContent = 'Connect';
                addLog('INFO', `Disconnected (code: ${e.code}, reason: ${e.reason || 'none'})`);
            };

            ws.onerror = (e) => {
                addLog('ERROR', 'WebSocket error');
            };

            ws.onmessage = (event) => {
                packetCount++;
                document.getElementById('pkt-count').textContent = packetCount;
                document.getElementById('last-time').textContent = new Date().toLocaleTimeString();

                if (paused) return;

                try {
                    const data = JSON.parse(event.data);
                    lastData = data;
                    renderValues(data);

                    if (document.getElementById('chk-raw').checked) {
                        addLog('PKT#' + packetCount, JSON.stringify(data, null, 1));
                    }
                } catch (e) {
                    addLog('PARSE_ERROR', event.data.substring(0, 200));
                }
            };
        }

        function renderValues(data) {
            const container = document.getElementById('values');
            let html = '';

            function addField(name, value, indent) {
                const prefix = indent ? '&nbsp;&nbsp;' : '';
                let cls = 'field-value';
                let display = value;

                if (typeof value === 'number') {
                    display = Number.isInteger(value) ? value : value.toFixed(4);
                    if (value === 0) cls += ' zero';
                } else if (typeof value === 'object' && value !== null) {
                    cls += ' nested';
                    display = JSON.stringify(value);
                } else if (value === undefined || value === null) {
                    cls += ' zero';
                    display = 'null';
                }

                html += `<div class="field-row"><span class="field-name">${prefix}${name}</span><span class="${cls}">${display}</span></div>`;
            }

            const keys = Object.keys(data).sort();
            for (const key of keys) {
                const val = data[key];
                if (Array.isArray(val)) {
                    addField(key, '', false);
                    val.forEach((v, i) => addField(`[${i}]`, v, true));
                } else if (typeof val === 'object' && val !== null) {
                    addField(key, '', false);
                    for (const [k, v] of Object.entries(val)) {
                        addField(k, v, true);
                    }
                } else {
                    addField(key, val, false);
                }
            }

            container.innerHTML = html;
        }

        function addLog(tag, msg) {
            const logEl = document.getElementById('log');
            const ts = new Date().toLocaleTimeString('ja-JP', { hour12: false, fractionalSecondDigits: 3 });
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="ts">${ts}</span> <span class="pkt">[${tag}]</span> ${escapeHtml(msg)}`;
            logEl.appendChild(entry);

            // Keep max 500 entries
            while (logEl.children.length > 500) {
                logEl.removeChild(logEl.firstChild);
            }

            logEl.scrollTop = logEl.scrollHeight;
        }

        function escapeHtml(str) {
            return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }

        // Auto-connect on load
        connect();
    </script>
</body>
</html>

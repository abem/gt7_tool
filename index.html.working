<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GT7 Telemetry Dashboard</title>
    <script src="/uplot.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #121829;
            --bg-card: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 255, 255, 0.08);
            --text-primary: #ffffff;
            --text-secondary: #6b7280;
            --accent-green: #00ff88;
            --accent-yellow: #ffd700;
            --accent-red: #ff4444;
            --accent-cyan: #44ffff;
            --accent-orange: #ff8800;

            /* Responsive sizing with clamp() */
            --chart-height: clamp(80px, 11vh, 130px);
            --tyre-temp-size: clamp(16px, 2.2vw, 24px);
            --tyre-pressure-size: clamp(11px, 1.3vw, 14px);
            --speed-size: clamp(32px, 5vw, 48px);
            --gear-size: clamp(24px, 3.5vw, 36px);
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        .dashboard {
            display: grid;
            grid-template-columns: clamp(220px, 18vw, 260px) 1fr clamp(260px, 20vw, 300px);
            grid-template-rows: auto 1fr;
            gap: clamp(8px, 1vh, 12px);
            padding: clamp(8px, 1vh, 12px);
            height: 100vh;
            max-width: 1920px;
            margin: 0 auto;
            overflow: hidden;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 14px;
            background: var(--bg-card);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .header-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: 1px;
        }

        #connection-status {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
        #connection-status.connected {
            background: var(--accent-green);
            color: #000;
        }
        #connection-status.disconnected {
            background: var(--accent-red);
            color: #fff;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            padding: clamp(6px, 1vh, 10px);
            contain: layout style;
        }

        .card-title {
            font-size: 9px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        /* Left Panel */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            overflow-x: hidden;
            contain: content;
        }

        /* Speed */
        .speed-card {
            text-align: center;
            padding: 12px 10px;
        }

        .speed-value {
            font-size: var(--speed-size);
            font-weight: 700;
            color: var(--accent-green);
            line-height: 1;
        }

        .speed-unit {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Gear & RPM */
        .gear-rpm-card {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gear-display {
            text-align: center;
            min-width: 50px;
        }

        .gear-value {
            font-size: var(--gear-size);
            font-weight: 700;
            color: var(--accent-yellow);
            line-height: 1;
        }

        .gear-label {
            font-size: 9px;
            color: var(--text-secondary);
        }

        .rpm-display {
            flex: 1;
        }

        .rpm-bar-bg {
            height: 16px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            overflow: hidden;
        }

        .rpm-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #ffff00, #ff4444);
            border-radius: 8px;
            transition: width 0.05s;
        }

        .rpm-text {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 3px;
        }

        /* Pedals */
        .pedals-card {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .pedal-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pedal-label {
            font-size: 9px;
            color: var(--text-secondary);
            min-width: 45px;
        }

        .pedal-bar-bg {
            flex: 1;
            height: 12px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            overflow: hidden;
        }

        .throttle-bar {
            height: 100%;
            background: linear-gradient(90deg, #00aa44, #00ff88);
            border-radius: 6px;
            transition: width 0.05s;
        }

        .brake-bar {
            height: 100%;
            background: linear-gradient(90deg, #aa0000, #ff4444);
            border-radius: 6px;
            transition: width 0.05s;
        }

        .pedal-value {
            font-size: 10px;
            color: var(--text-primary);
            min-width: 30px;
            text-align: right;
        }

        /* Fuel & Boost */
        .fuel-boost-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .fuel-boost-item {
            text-align: center;
        }

        .fuel-boost-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-green);
        }

        .fuel-boost-value.boost {
            color: var(--accent-orange);
        }

        .fuel-boost-label {
            font-size: 9px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Stat Card */
        .stat-card {
            text-align: center;
            padding: 8px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 8px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Center Panel */
        .center-panel {
            display: flex;
            flex-direction: column;
            gap: clamp(10px, 1.5vh, 16px);
            overflow: hidden;
            min-height: 0;
        }

        /* Course Map */
        .course-map-card {
            flex: 0.8;
            display: flex;
            flex-direction: column;
            min-height: clamp(120px, 25vh, 200px);
            overflow: hidden;
        }

        .course-map-container {
            flex: 1;
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        #course-map {
            width: 100%;
            height: 100%;
            display: block;
        }

        .course-map-info {
            position: absolute;
            top: 6px;
            left: 6px;
            font-size: 9px;
            color: var(--text-secondary);
            background: rgba(0, 0, 0, 0.6);
            padding: 3px 6px;
            border-radius: 3px;
            font-family: 'Segoe UI Mono', monospace;
        }

        .course-map-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 6px;
        }

        .test-mode-btn {
            font-size: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .test-mode-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            color: var(--accent-yellow);
            border-color: var(--accent-yellow);
        }

        .test-mode-btn.active {
            background: var(--accent-yellow);
            color: #000;
            border-color: var(--accent-yellow);
        }

        .test-mode-indicator {
            font-size: 8px;
            color: var(--accent-yellow);
            background: rgba(255, 215, 0, 0.1);
            padding: 2px 4px;
            border-radius: 2px;
            margin-left: 4px;
        }

        /* Charts */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: clamp(4px, 0.8vw, 8px);
            height: var(--chart-height);
            min-height: 100px;
            max-height: 140px;
            flex-shrink: 0;
        }

        .chart-wrapper {
            background: var(--bg-card);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            padding: 4px 4px 2px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chart-title {
            font-size: clamp(7px, 0.8vw, 9px);
            color: var(--text-secondary);
            margin-bottom: 1px;
            white-space: nowrap;
        }

        .chart {
            flex: 1;
            min-height: 0;
            width: 100%;
        }

        /* Tyres */
        .tyres-card {
            flex: 0.8;
            display: flex;
            flex-direction: column;
            min-height: 120px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .tyres-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: clamp(8px, 1.5vw, 14px);
            margin-bottom: 12px;
        }

        .tyre-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 6px;
            text-align: center;
            min-width: 0;
        }

        .tyre-pos {
            font-size: clamp(9px, 1.2vw, 13px);
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .tyre-temp-row, .tyre-pressure-row, .tyre-rps-row {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 2px;
            margin-bottom: 2px;
            flex-wrap: wrap;
        }

        .tyre-data-row {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 4px;
            margin-bottom: 4px;
            flex-wrap: wrap;
        }

        .tyre-temp {
            font-size: var(--tyre-temp-size);
            font-weight: 700;
            color: var(--accent-green);
        }

        .tyre-temp-unit {
            font-size: clamp(8px, 1vw, 12px);
            color: var(--text-secondary);
        }

        .tyre-pressure {
            font-size: var(--tyre-pressure-size);
            font-weight: 600;
            color: var(--accent-cyan);
        }

        .tyre-rps-row {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 2px;
        }

        .tyre-rps {
            font-size: 9px;
            font-weight: 600;
            color: #ff9800;
        }

        .tyre-rps-unit {
            font-size: 8px;
            color: var(--text-secondary);
        }

        .tyre-pressure-unit {
            font-size: clamp(8px, 0.9vw, 10px);
            color: var(--text-secondary);
        }

        .tyre-label {
            font-size: clamp(7px, 0.8vw, 9px);
            color: var(--text-secondary);
        }

        /* Suspension */
        .suspension-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: clamp(8px, 1.5vw, 14px);
        }

        .susp-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            padding: 6px 4px;
            text-align: center;
        }

        .susp-pos {
            font-size: 9px;
            color: var(--text-secondary);
        }

        .susp-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .susp-unit {
            font-size: 8px;
            color: var(--text-secondary);
        }

        /* Right Panel */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .right-panel::-webkit-scrollbar {
            width: 4px;
        }

        /* Lap Times */
        .lap-times-card {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .lap-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .lap-row:last-child {
            border-bottom: none;
        }

        .lap-label {
            font-size: 9px;
            color: var(--text-secondary);
        }

        .lap-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-green);
            font-family: 'Segoe UI Mono', monospace;
        }

        /* Delta */
        .delta-card {
            text-align: center;
            padding: 8px;
        }

        .delta-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-green);
        }

        .delta-value.negative {
            color: var(--accent-red);
        }

        .delta-label {
            font-size: 9px;
            color: var(--text-secondary);
        }

        /* Lap History */
        .lap-history-card {
            max-height: clamp(120px, 20vh, 180px);
            overflow-y: auto;
            min-height: 80px;
        }

        .lap-history-list {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .lap-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 6px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            font-size: 10px;
        }

        .lap-history-item.best {
            background: rgba(0, 255, 136, 0.15);
            border: 1px solid var(--accent-green);
        }

        .lap-hist-num {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .lap-hist-time {
            color: var(--accent-green);
            font-weight: 600;
            font-family: 'Segoe UI Mono', monospace;
        }

        .lap-hist-delta {
            font-size: 9px;
        }

        .lap-hist-delta.positive {
            color: var(--accent-red);
        }

        .lap-hist-delta.negative {
            color: var(--accent-green);
        }

        /* Position */
        .position-card {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .position-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
        }

        .position-label {
            color: var(--text-secondary);
        }

        .position-value {
            color: var(--text-primary);
            font-family: 'Segoe UI Mono', monospace;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* uPlot overrides */
        .u-tooltip {
            display: none !important;
        }

        .u-over {
            display: none !important;
        }

        /* Responsive breakpoints */
        /* 1080p optimization (1920x1080) */
        @media (min-width: 1900px) and (max-width: 1950px) and (min-height: 1050px) and (max-height: 1100px) {
            :root {
                --chart-height: 100px;
                --tyre-temp-size: 18px;
                --tyre-pressure-size: 12px;
            }

            .dashboard {
                gap: 8px;
                padding: 8px;
            }
        }

        @media (max-width: 1400px) {
            .dashboard {
                grid-template-columns: 220px 1fr 260px;
                gap: 8px;
                padding: 8px;
            }

            .charts-container {
                gap: 4px;
            }
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 200px 1fr 240px;
            }

            .tyres-grid {
                gap: 4px;
            }
        }

        @media (max-height: 800px) {
            :root {
                --chart-height: 85px;
            }

            .lap-history-card {
                max-height: 110px;
            }

            .tyre-item {
                padding: 6px 4px;
            }

            .card {
                padding: 6px 8px;
            }

            .dashboard {
                gap: 6px;
                padding: 6px;
            }
        }

        /* Extra small height (laptops, small windows) */
        @media (max-height: 700px) {
            :root {
                --chart-height: 70px;
                --tyre-temp-size: 14px;
                --tyre-pressure-size: 10px;
            }

            .charts-container {
                gap: 4px;
            }

            .lap-history-card {
                max-height: 90px;
            }
        }
    </style>
    <link rel="stylesheet" href="/uplot.min.css">
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <span class="header-title">GT7 TELEMETRY DASHBOARD</span>
            <div id="connection-status" class="disconnected">Disconnected</div>
        </div>

        <!-- Left Panel -->
        <div class="left-panel">
            <div class="card speed-card">
                <div class="speed-value" id="speed">0</div>
                <div class="speed-unit">km/h</div>
            </div>

            <div class="card gear-rpm-card">
                <div class="gear-display">
                    <div class="gear-value" id="gear">N</div>
                    <div class="gear-label">GEAR</div>
                </div>
                <div class="rpm-display">
                    <div class="rpm-bar-bg">
                        <div class="rpm-bar" id="rpm-bar"></div>
                    </div>
                    <div class="rpm-text" id="rpm-text">0 RPM</div>
                </div>
            </div>

            <div class="card pedals-card">
                <div class="pedal-row">
                    <span class="pedal-label">THROTTLE</span>
                    <div class="pedal-bar-bg">
                        <div class="throttle-bar" id="throttle-bar"></div>
                    </div>
                    <span class="pedal-value" id="throttle-value">0%</span>
                </div>
                <div class="pedal-row">
                    <span class="pedal-label">BRAKE</span>
                    <div class="pedal-bar-bg">
                        <div class="brake-bar" id="brake-bar"></div>
                    </div>
                    <span class="pedal-value" id="brake-value">0%</span>
                </div>
            </div>

            <div class="card fuel-boost-grid">
                <div class="fuel-boost-item">
                    <div class="fuel-boost-value" id="fuel">--</div>
                    <div class="fuel-boost-label">FUEL (L)</div>
                </div>
                <div class="fuel-boost-item">
                    <div class="fuel-boost-value boost" id="boost">--</div>
                    <div class="fuel-boost-label">BOOST (%)</div>
                </div>
            </div>

            <div class="card stat-card">
                <div class="stat-value" id="max-speed">--</div>
                <div class="stat-label">MAX SPEED (km/h)</div>
            </div>
        </div>

        <!-- Center Panel -->
        <div class="center-panel">
            <div class="charts-container">
                <div class="chart-wrapper">
                    <div class="chart-title">SPEED</div>
                    <div id="speed-chart" class="chart"></div>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-title">RPM</div>
                    <div id="rpm-chart" class="chart"></div>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-title">THROTTLE</div>
                    <div id="throttle-chart" class="chart"></div>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-title">BRAKE</div>
                    <div id="brake-chart" class="chart"></div>
                </div>
            </div>

            <div class="card course-map-card">
                <div class="course-map-header">
                    <div class="card-title">COURSE MAP</div>
                    <button id="test-mode-btn" class="test-mode-btn">TEST MODE</button>
                </div>
                <div class="course-map-container">
                    <canvas id="course-map"></canvas>
                    <div class="course-map-info" id="course-map-info">Waiting for data...</div>
                </div>
            </div>

            <div class="card tyres-card">
                <div class="card-title">TYRES</div>
                <div class="tyres-grid">
                    <div class="tyre-item">
                        <div class="tyre-pos">FL</div>
                        <div class="tyre-data-row">
                            <div class="tyre-temp-row">
                                <span class="tyre-temp" id="fl-temp">--</span>
                                <span class="tyre-temp-unit">°C</span>
                            </div>
                            <div class="tyre-pressure-row">
                                <span class="tyre-pressure" id="fl-pressure">--</span>
                                <span class="tyre-pressure-unit">bar</span>
                            </div>
                            <div class="tyre-rps-row">
                                <span class="tyre-rps" id="fl-rps">--</span>
                                <span class="tyre-rps-unit">rps</span>
                            </div>
                        </div>
                    </div>
                    <div class="tyre-item">
                        <div class="tyre-pos">FR</div>
                        <div class="tyre-data-row">
                            <div class="tyre-temp-row">
                                <span class="tyre-temp" id="fr-temp">--</span>
                                <span class="tyre-temp-unit">°C</span>
                            </div>
                            <div class="tyre-pressure-row">
                                <span class="tyre-pressure" id="fr-pressure">--</span>
                                <span class="tyre-pressure-unit">bar</span>
                            </div>
                            <div class="tyre-rps-row">
                                <span class="tyre-rps" id="fr-rps">--</span>
                                <span class="tyre-rps-unit">rps</span>
                            </div>
                        </div>
                    </div>
                    <div class="tyre-item">
                        <div class="tyre-pos">RL</div>
                        <div class="tyre-data-row">
                            <div class="tyre-temp-row">
                                <span class="tyre-temp" id="rl-temp">--</span>
                                <span class="tyre-temp-unit">°C</span>
                            </div>
                            <div class="tyre-pressure-row">
                                <span class="tyre-pressure" id="rl-pressure">--</span>
                                <span class="tyre-pressure-unit">bar</span>
                            </div>
                            <div class="tyre-rps-row">
                                <span class="tyre-rps" id="rl-rps">--</span>
                                <span class="tyre-rps-unit">rps</span>
                            </div>
                        </div>
                    </div>
                    <div class="tyre-item">
                        <div class="tyre-pos">RR</div>
                        <div class="tyre-data-row">
                            <div class="tyre-temp-row">
                                <span class="tyre-temp" id="rr-temp">--</span>
                                <span class="tyre-temp-unit">°C</span>
                            </div>
                            <div class="tyre-pressure-row">
                                <span class="tyre-pressure" id="rr-pressure">--</span>
                                <span class="tyre-pressure-unit">bar</span>
                            </div>
                            <div class="tyre-rps-row">
                                <span class="tyre-rps" id="rr-rps">--</span>
                                <span class="tyre-rps-unit">rps</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-title" style="margin-top: 4px;">SUSPENSION</div>
                <div class="suspension-grid">
                    <div class="susp-item">
                        <div class="susp-pos">FL</div>
                        <div class="susp-value" id="fl-susp">--</div>
                        <div class="susp-unit">mm</div>
                    </div>
                    <div class="susp-item">
                        <div class="susp-pos">FR</div>
                        <div class="susp-value" id="fr-susp">--</div>
                        <div class="susp-unit">mm</div>
                    </div>
                    <div class="susp-item">
                        <div class="susp-pos">RL</div>
                        <div class="susp-value" id="rl-susp">--</div>
                        <div class="susp-unit">mm</div>
                    </div>
                    <div class="susp-item">
                        <div class="susp-pos">RR</div>
                        <div class="susp-value" id="rr-susp">--</div>
                        <div class="susp-unit">mm</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <div class="card lap-times-card">
                <div class="lap-row">
                    <span class="lap-label">LAP</span>
                    <span class="lap-value" id="current-lap">--</span>
                </div>
                <div class="lap-row">
                    <span class="lap-label">CURRENT</span>
                    <span class="lap-value" id="current-lap-time">--:--.---</span>
                </div>
                <div class="lap-row">
                    <span class="lap-label">BEST</span>
                    <span class="lap-value" id="best-lap-time">--:--.---</span>
                </div>
            </div>

            <div class="card delta-card">
                <div class="delta-value" id="lap-delta">--</div>
                <div class="delta-label">DELTA VS BEST</div>
            </div>

            <div class="card lap-history-card">
                <div class="card-title">LAP HISTORY</div>
                <div id="lap-list" class="lap-history-list"></div>
            </div>

            <div class="card position-card">
                <div class="card-title">POSITION</div>
                <div class="position-row">
                    <span class="position-label">X</span>
                    <span class="position-value" id="pos-x">--</span>
                </div>
                <div class="position-row">
                    <span class="position-label">Y</span>
                    <span class="position-value" id="pos-y">--</span>
                </div>
                <div class="position-row">
                    <span class="position-label">Z</span>
                    <span class="position-value" id="pos-z">--</span>
                </div>
            </div>

            <div class="stats-grid">
                <div class="card stat-card">
                    <div class="stat-value" id="car-id">--</div>
                    <div class="stat-label">CAR ID</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="packets">0</div>
                    <div class="stat-label">PACKETS</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="card stat-card">
                    <div class="stat-value" id="accel-g">--</div>
                    <div class="stat-label">ACCEL G</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="accel-decel">--</div>
                    <div class="stat-label">DECEL G</div>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-wrapper">
                    <div class="chart-title">ACCELERATION (G)</div>
                    <div class="chart">
                        <canvas id="accel-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <script>
        // チャート描画関数
        function drawAccelChart() {
            if (!accelCanvas || !accelCtx) return;

            const width = accelCanvas.width;
            const height = accelCanvas.height;
            const config = ACCEL_CHART_CONFIG;

            // 背景をクリア
            accelCtx.fillStyle = '#1a1a2e';
            accelCtx.fillRect(0, 0, width, height);

            // グリッドを描画
            accelCtx.strokeStyle = config.gridColor;
            accelCtx.lineWidth = 1;
            accelCtx.beginPath();

            const maxDataPoints = Math.max(accelData.accelG.length, accelData.accelDecel.length);
            const stepX = width / Math.max(maxDataPoints - 1, 1);

            // 基準線（0G）を描画
            accelCtx.strokeStyle = 'rgba(100, 100, 100, 0.3)';
            accelCtx.lineWidth = 2;
            accelCtx.beginPath();
            accelCtx.moveTo(0, height / 2);
            accelCtx.lineTo(width, height / 2);
            accelCtx.stroke();

            // 加速G（緑）を描画
            if (accelData.accelG.length > 0) {
                accelCtx.strokeStyle = config.lineColor;
                accelCtx.lineWidth = config.lineWidth;
                accelCtx.beginPath();

                for (let i = 0; i < accelData.accelG.length; i++) {
                    const x = i * stepX;
                    const y = height / 2 - (accelData.accelG[i] / 10) * (height / 2);
                    if (i === 0) {
                        accelCtx.moveTo(x, y);
                    } else {
                        accelCtx.lineTo(x, y);
                    }
                }
                accelCtx.stroke();
            }

            // 減速G（赤）を描画
            if (accelData.accelDecel.length > 0) {
                accelCtx.strokeStyle = '#ff4444';
                accelCtx.lineWidth = config.lineWidth;
                accelCtx.beginPath();

                for (let i = 0; i < accelData.accelDecel.length; i++) {
                    const x = i * stepX;
                    const y = height / 2 - (accelData.accelDecel[i] / 10) * (height / 2);
                    if (i === 0) {
                        accelCtx.moveTo(x, y);
                    } else {
                        accelCtx.lineTo(x, y);
                    }
                }
                accelCtx.stroke();
            }

            // テキストを描画
            accelCtx.fillStyle = '#ffffff';
            accelCtx.font = '12px sans-serif';
            // ACCEL G (緑) - 右上に表示
            accelCtx.textAlign = 'right';
            const lastAccelG = accelData.accelG[accelData.accelG.length - 1] || 0;
            accelCtx.fillStyle = '#00ff88';
            accelCtx.fillText('ACCEL: ' + lastAccelG.toFixed(2) + ' G', width - 10, 20);
            // DECEL G (赤) - 左上に表示
            accelCtx.textAlign = 'left';
            const lastAccelDecel = accelData.accelDecel[accelData.accelDecel.length - 1] || 0;
            accelCtx.fillStyle = '#ff4444';
            accelCtx.fillText('DECEL: ' + lastAccelDecel.toFixed(2) + ' G', 10, 20);
        }

        // WebSocketメッセージ処理（加速度データ更新）
        function updateAccelChart(accelG, accelDecel) {
            if (accelG !== undefined) {
                accelData.accelG.push(accelG);
                if (accelData.accelG.length > ACCEL_CHART_CONFIG.maxPoints) {
                    accelData.accelG.shift();
                }
            }
            if (accelDecel !== undefined) {
                accelData.accelDecel.push(accelDecel);
                if (accelData.accelDecel.length > ACCEL_CHART_CONFIG.maxPoints) {
                    accelData.accelDecel.shift();
                }
            }

            drawAccelChart();
        }

        function initCourseMap() {
            const canvas = document.getElementById('course-map');
            if (!canvas) {
                console.error('[COURSE_MAP] Canvas element not found');
                return;
            }

            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;

            courseMapState.canvas = canvas;
            courseMapState.ctx = canvas.getContext('2d');

            // Handle resize
            const resizeObserver = new ResizeObserver(() => {
                if (canvas && container) {
                    canvas.width = container.clientWidth;
                    canvas.height = container.clientHeight;
                }
            });
            resizeObserver.observe(container);

            debugLog('COURSE_MAP', 'Initialized', { width: canvas.width, height: canvas.height });
        }

        function updateCourseMapBounds(x, z) {
            if (!courseMapState.initialized) {
                courseMapState.bounds = {
                    minX: x - 50,
                    maxX: x + 50,
                    minZ: z - 50,
                    maxZ: z + 50
                };
                courseMapState.initialized = true;
            } else {
                const padding = 20;
                courseMapState.bounds.minX = Math.min(courseMapState.bounds.minX, x - padding);
                courseMapState.bounds.maxX = Math.max(courseMapState.bounds.maxX, x + padding);
                courseMapState.bounds.minZ = Math.min(courseMapState.bounds.minZ, z - padding);
                courseMapState.bounds.maxZ = Math.max(courseMapState.bounds.maxZ, z + padding);
            }
        }

        function gameToCanvas(x, z) {
            const bounds = courseMapState.bounds;
            const canvas = courseMapState.canvas;
            if (!canvas) return { x: 0, y: 0 };

            const rangeX = bounds.maxX - bounds.minX || 1;
            const rangeZ = bounds.maxZ - bounds.minZ || 1;

            // Calculate scale to fit canvas with padding
            const padding = 30;
            const availableWidth = canvas.width - 2 * padding;
            const availableHeight = canvas.height - 2 * padding;

            const scaleX = availableWidth / rangeX;
            const scaleZ = availableHeight / rangeZ;
            const scale = Math.min(scaleX, scaleZ);

            // Center the map
            const offsetX = padding + (availableWidth - rangeX * scale) / 2;
            const offsetY = padding + (availableHeight - rangeZ * scale) / 2;

            return {
                x: offsetX + (x - bounds.minX) * scale,
                y: offsetY + (z - bounds.minZ) * scale
            };
        }

        function getSpeedColor(speed) {
            if (speed < 60) return COURSE_MAP_CONFIG.colors.trajectoryLow;
            if (speed < 120) return COURSE_MAP_CONFIG.colors.trajectoryMid;
            return COURSE_MAP_CONFIG.colors.trajectoryHigh;
        }

        function drawCourseMap() {
            const ctx = courseMapState.ctx;
            const canvas = courseMapState.canvas;
            if (!ctx || !canvas) return;

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw grid
            ctx.strokeStyle = COURSE_MAP_CONFIG.colors.grid;
            ctx.lineWidth = 1;
            const gridSize = 50;
            for (let x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }

            if (!courseMapState.initialized) {
                ctx.fillStyle = COURSE_MAP_CONFIG.colors.text;
                ctx.font = '12px "Segoe UI Mono", monospace';
                ctx.textAlign = 'center';
                ctx.fillText('Waiting for position data...', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Draw trajectory
            if (courseMapState.trajectory.length > 1) {
                for (let i = 1; i < courseMapState.trajectory.length; i++) {
                    const prev = courseMapState.trajectory[i - 1];
                    const curr = courseMapState.trajectory[i];
                    const prevCanvas = gameToCanvas(prev.x, prev.z);
                    const currCanvas = gameToCanvas(curr.x, curr.z);

                    ctx.beginPath();
                    ctx.moveTo(prevCanvas.x, prevCanvas.y);
                    ctx.lineTo(currCanvas.x, currCanvas.y);
                    ctx.strokeStyle = getSpeedColor(curr.speed);
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }

            // Draw car position
            const carPos = gameToCanvas(
                courseMapState.currentPosition.x,
                courseMapState.currentPosition.z
            );

            // Car glow
            const gradient = ctx.createRadialGradient(carPos.x, carPos.y, 0, carPos.x, carPos.y, 15);
            gradient.addColorStop(0, 'rgba(0, 255, 136, 0.5)');
            gradient.addColorStop(1, 'rgba(0, 255, 136, 0)');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(carPos.x, carPos.y, 15, 0, Math.PI * 2);
            ctx.fill();

            // Car marker
            ctx.fillStyle = COURSE_MAP_CONFIG.colors.car;
            ctx.beginPath();
            ctx.arc(carPos.x, carPos.y, 6, 0, Math.PI * 2);
            ctx.fill();

            // Update info display
            const infoEl = document.getElementById('course-map-info');
            if (infoEl) {
                const rangeX = (courseMapState.bounds.maxX - courseMapState.bounds.minX).toFixed(0);
                const rangeZ = (courseMapState.bounds.maxZ - courseMapState.bounds.minZ).toFixed(0);
                infoEl.textContent = `X: ${courseMapState.currentPosition.x.toFixed(1)} Z: ${courseMapState.currentPosition.z.toFixed(1)} | Range: ${rangeX}m × ${rangeZ}m`;
            }
        }

        function updateCourseMap(positionX, positionY, positionZ, speed) {
            courseMapState.currentPosition = { x: positionX, y: positionY, z: positionZ };
            updateCourseMapBounds(positionX, positionZ);

            courseMapState.sampleCount++;
            if (courseMapState.sampleCount % COURSE_MAP_CONFIG.trajectorySampleInterval === 0) {
                courseMapState.trajectory.push({
                    x: positionX,
                    z: positionZ,
                    speed: speed,
                    timestamp: Date.now()
                });

                // Limit trajectory size
                if (courseMapState.trajectory.length > COURSE_MAP_CONFIG.maxTrajectoryPoints) {
                    courseMapState.trajectory.shift();
                }
            }

            drawCourseMap();
        }

        function debugLog(category, message, ...args) {
            if (DEBUG_MODE) {
                console.log(`[${category}]`, message, ...args);
            }
        }

        debugLog('INIT', 'GT7 Telemetry Dashboard loaded');

        if (typeof uPlot === 'undefined') {
            console.error('[CRITICAL] uPlot library not loaded!');
        }

        const CHART_POINTS = 1200;
        let timeCounter = 0;

        window.timeData = new Array(CHART_POINTS).fill(0);
        window.speedData = new Array(CHART_POINTS).fill(0);
        window.rpmData = new Array(CHART_POINTS).fill(0);
        window.throttleData = new Array(CHART_POINTS).fill(0);
        window.brakeData = new Array(CHART_POINTS).fill(0);

        const chartOptions = {
            width: 200,
            height: 100,
            pxAlign: 0,
            pxSnap: true,
            plugins: [],
            scales: {
                x: { time: false, min: 0, max: CHART_POINTS - 1 },
                y: { auto: true }
            },
            axes: [
                { show: false },
                { show: false }
            ],
            series: [{}, { stroke: '#00ff88', width: 1.5, fill: 'rgba(0, 255, 136, 0.1)' }],
            cursor: { show: false },
            legend: { show: false },
            padding: [0, 0, 0, 0],
            points: { show: false }
        };

        window.speedChart = null;
        window.rpmChart = null;
        window.throttleChart = null;
        window.brakeChart = null;

        // 加速度チャート用変数
        let accelCanvas = null;
        let accelCtx = null;
        const ACCEL_CHART_CONFIG = {
            maxPoints: 200,
            lineColor: '#00ff88',
            lineWidth: 2,
            gridColor: 'rgba(255, 255, 255, 0.1)'
        };
        const accelData = {
            times: new Array(ACCEL_CHART_CONFIG.maxPoints).fill(0),
            accelG: new Array(ACCEL_CHART_CONFIG.maxPoints).fill(0),
            accelDecel: new Array(ACCEL_CHART_CONFIG.maxPoints).fill(0)
        };

        function initCharts() {
            const chartElements = {
                'speed-chart': document.getElementById('speed-chart'),
                'rpm-chart': document.getElementById('rpm-chart'),
                'throttle-chart': document.getElementById('throttle-chart'),
                'brake-chart': document.getElementById('brake-chart')
            };

            // 加速度チャートを初期化
            const accelCanvasEl = document.getElementById('accel-chart');
            if (accelCanvasEl) {
                accelCanvas = accelCanvasEl;
                accelCanvas.width = accelCanvasEl.clientWidth;
                accelCanvas.height = accelCanvasEl.clientHeight;
                accelCtx = accelCanvas.getContext('2d');
            }

            try {
                window.speedChart = new uPlot(
                    { ...chartOptions, series: [{}, { stroke: '#00ff88', width: 1.5, fill: 'rgba(0, 255, 136, 0.1)' }] },
                    [window.timeData, window.speedData],
                    chartElements['speed-chart']
                );

                window.rpmChart = new uPlot(
                    { ...chartOptions, series: [{}, { stroke: '#ffd700', width: 1.5, fill: 'rgba(255, 215, 0, 0.1)' }] },
                    [window.timeData, window.rpmData],
                    chartElements['rpm-chart']
                );

                window.throttleChart = new uPlot(
                    { ...chartOptions, series: [{}, { stroke: '#00ff88', width: 1.5, fill: 'rgba(0, 255, 136, 0.15)', scales: { y: { min: 0, max: 100 } } }] },
                    [window.timeData, window.throttleData],
                    chartElements['throttle-chart']
                );

                window.brakeChart = new uPlot(
                    { ...chartOptions, series: [{}, { stroke: '#ff4444', width: 1.5, fill: 'rgba(255, 68, 68, 0.15)', scales: { y: { min: 0, max: 100 } } }] },
                    [window.timeData, window.brakeData],
                    chartElements['brake-chart']
                );

                // 加速度チャートの初期描画
                drawAccelChart();

                // Debounced resize handler for better performance
                let resizeTimeout;
                const resizeCharts = () => {
                    const ids = ['speed-chart', 'rpm-chart', 'throttle-chart', 'brake-chart'];
                    const charts = [window.speedChart, window.rpmChart, window.throttleChart, window.brakeChart];
                    ids.forEach((id, i) => {
                        const el = document.getElementById(id);
                        if (el && charts[i]) {
                            const rect = el.getBoundingClientRect();
                            charts[i].setSize({ width: rect.width, height: rect.height });
                        }
                    });
                };

                const debouncedResize = () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(resizeCharts, 100);
                };

                window.addEventListener('resize', debouncedResize);
                // Use ResizeObserver for more responsive chart sizing
                const resizeObserver = new ResizeObserver(debouncedResize);
                Object.values(chartElements).forEach(el => {
                    if (el) resizeObserver.observe(el);
                });

                setTimeout(resizeCharts, 50);
                setTimeout(resizeCharts, 200);

            } catch (e) {
                console.error('[CHART] Error:', e);
            }
        }

        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws`;

        const ws = new WebSocket(wsUrl);
        const statusEl = document.getElementById('connection-status');

        let packetCount = 0;
        let maxSpeed = 0;
        let currentLapNumber = 0;
        let lastLapNumber = 0;
        let bestLapTime = Infinity;
        let bestLapNumber = 0;
        let lapTimes = [];
        let currentLapData = [];
        let bestLapData = [];

        const elements = {
            speed: document.getElementById('speed'),
            gear: document.getElementById('gear'),
            rpmBar: document.getElementById('rpm-bar'),
            rpmText: document.getElementById('rpm-text'),
            throttleBar: document.getElementById('throttle-bar'),
            throttleValue: document.getElementById('throttle-value'),
            brakeBar: document.getElementById('brake-bar'),
            brakeValue: document.getElementById('brake-value'),
            fuel: document.getElementById('fuel'),
            boost: document.getElementById('boost'),
            maxX: document.getElementById('pos-x'),
            maxY: document.getElementById('pos-y'),
            maxZ: document.getElementById('pos-z'),
            flTemp: document.getElementById('fl-temp'),
            frTemp: document.getElementById('fr-temp'),
            rlTemp: document.getElementById('rl-temp'),
            rrTemp: document.getElementById('rr-temp'),
            flPressure: document.getElementById('fl-pressure'),
            frPressure: document.getElementById('fr-pressure'),
            rlPressure: document.getElementById('rl-pressure'),
            rrPressure: document.getElementById('rr-pressure'),
            flRps: document.getElementById('fl-rps'),
            frRps: document.getElementById('fr-rps'),
            rlRps: document.getElementById('rl-rps'),
            rrRps: document.getElementById('rr-rps'),
            flSusp: document.getElementById('fl-susp'),
            frSusp: document.getElementById('fr-susp'),
            rlSusp: document.getElementById('rl-susp'),
            rrSusp: document.getElementById('rr-susp'),
            maxSpeed: document.getElementById('max-speed'),
            carId: document.getElementById('car-id'),
            packets: document.getElementById('packets'),
            accelG: document.getElementById('accel-g'),
            accelDecel: document.getElementById('accel-decel'),
            currentLap: document.getElementById('current-lap'),
            currentLapTime: document.getElementById('current-lap-time'),
            bestLapTime: document.getElementById('best-lap-time'),
            lapDelta: document.getElementById('lap-delta'),
            lapList: document.getElementById('lap-list')
        };

        function formatLapTime(ms) {
            if (ms === -1 || ms === undefined || ms === null) return '--:--.---';
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            const millis = ms % 1000;
            return `${minutes}:${seconds.toString().padStart(2, '0')}.${millis.toString().padStart(3, '0')}`;
        }

        function getTyreTempColor(temp) {
            if (temp < 40) return '#44ffff';
            if (temp < 80) return '#00ff88';
            if (temp < 100) return '#ffff00';
            return '#ff4444';
        }

        function updateLapList() {
            elements.lapList.innerHTML = '';
            lapTimes.forEach(lap => {
                const item = document.createElement('div');
                item.className = 'lap-history-item' + (lap.number === bestLapNumber ? ' best' : '');
                const delta = lap.time - bestLapTime;
                const deltaSign = delta > 0 ? '+' : '';
                const deltaClass = delta < 0 ? 'negative' : 'positive';
                item.innerHTML = `
                    <span class="lap-hist-num">L${lap.number}</span>
                    <span class="lap-hist-time">${formatLapTime(lap.time)}</span>
                    <span class="lap-hist-delta ${deltaClass}">${deltaSign}${(delta / 1000).toFixed(3)}</span>
                `;
                elements.lapList.appendChild(item);
            });
        }

        function addLapData(lapNumber, lapTime) {
            const idx = lapTimes.findIndex(l => l.number === lapNumber);
            if (idx >= 0) {
                lapTimes[idx] = { number: lapNumber, time: lapTime };
            } else {
                lapTimes.push({ number: lapNumber, time: lapTime });
            }
            if (lapTime > 0 && lapTime < bestLapTime) {
                bestLapTime = lapTime;
                bestLapNumber = lapNumber;
                bestLapData = [...currentLapData];
            }
            updateLapList();
            elements.bestLapTime.textContent = formatLapTime(bestLapTime);
        }

        ws.onopen = () => {
            console.log('Connected to GT7 Bridge');
            statusEl.textContent = 'Connected';
            statusEl.className = 'connected';
            initCharts();
            initCourseMap();
        };

        // Test Mode - Demo data without PS5
        let testModeActive = false;
        let testModeInterval = null;
        let testTrajectoryIndex = 0;

        const demoTrajectory = [
            {x: 0, z: -300, speed: 80}, {x: 50, z: -280, speed: 120}, {x: 100, z: -240, speed: 160},
            {x: 150, z: -180, speed: 200}, {x: 200, z: -100, speed: 220}, {x: 240, z: -20, speed: 200},
            {x: 260, z: 60, speed: 180}, {x: 250, z: 140, speed: 150}, {x: 220, z: 200, speed: 120},
            {x: 170, z: 230, speed: 100}, {x: 110, z: 240, speed: 90}, {x: 50, z: 230, speed: 100},
            {x: -20, z: 200, speed: 130}, {x: -80, z: 150, speed: 170}, {x: -120, z: 80, speed: 200},
            {x: -140, z: 0, speed: 190}, {x: -130, z: -80, speed: 160}, {x: -90, z: -150, speed: 130},
            {x: -40, z: -220, speed: 110}, {x: 0, z: -280, speed: 90}
        ];

        const testModeBtn = document.getElementById('test-mode-btn');
        if (testModeBtn) {
            testModeBtn.addEventListener('click', () => {
                testModeActive = !testModeActive;
                testModeBtn.classList.toggle('active', testModeActive);
                testModeBtn.textContent = testModeActive ? 'STOP TEST' : 'TEST MODE';

                if (testModeActive) {
                    debugLog('TEST', 'Test mode enabled');
                    // Start demo data
                    testTrajectoryIndex = 0;
                    statusEl.textContent = 'TEST MODE';
                    statusEl.style.background = 'var(--accent-yellow)';
                    statusEl.style.color = '#000';
                    elements.courseName.textContent = 'スズカ サーキット (Demo)';

                    testModeInterval = setInterval(() => {
                        if (!testModeActive) {
                            clearInterval(testModeInterval);
                            return;
                        }

                        const point = demoTrajectory[testTrajectoryIndex % demoTrajectory.length];
                        testTrajectoryIndex++;

                        // Simulate telemetry data
                        const demoData = {
                            position_x: point.x,
                            position_y: 0,
                            position_z: point.z,
                            speed_kmh: point.speed,
                            speed_ms: point.speed / 3.6,
                            rpm: 3000 + Math.random() * 4000,
                            gear: Math.floor(Math.random() * 6) + 1,
                            throttle_pct: Math.random() * 100,
                            brake_pct: Math.random() * 30,
                            course: { name: 'スズカ サーキット (Demo)', confidence: 1.0 },
                            lap_count: 1,
                            total_laps: 3
                        };

                        // Update UI directly
                        elements.speed.textContent = Math.round(point.speed);
                        elements.gear.textContent = demoData.gear;
                        elements.rpmBar.style.width = (demoData.rpm / 9000 * 100) + '%';
                        elements.rpmText.textContent = Math.round(demoData.rpm) + ' RPM';
                        elements.throttleBar.style.width = demoData.throttle_pct + '%';
                        elements.throttleValue.textContent = Math.round(demoData.throttle_pct) + '%';
                        elements.brakeBar.style.width = demoData.brake_pct + '%';
                        elements.brakeValue.textContent = Math.round(demoData.brake_pct) + '%';
                        elements.maxX.textContent = point.x.toFixed(1);
                        elements.maxY.textContent = '0.0';
                        elements.maxZ.textContent = point.z.toFixed(1);

                        // Update course map
                        updateCourseMap(point.x, 0, point.z, point.speed);

                        packetCount++;
                        elements.packets.textContent = packetCount;

                    }, 200); // 5Hz demo update (slower, smoother)

                } else {
                    debugLog('TEST', 'Test mode disabled');
                    clearInterval(testModeInterval);
                    statusEl.textContent = 'Connected';
                    statusEl.style.background = '';
                    statusEl.style.color = '';
                    testTrajectoryIndex = 0;
                    // Clear trajectory when stopping test mode
                    if (typeof courseMapState !== 'undefined') {
                        courseMapState.trajectory = [];
                        courseMapState.currentPosition = { x: 0, y: 0, z: 0 };
                        drawCourseMap();
                    }
                }
            });
        }

        ws.onerror = (error) => {
            console.error('WebSocket Error:', error);
        };

        ws.onclose = () => {
            console.log('Disconnected');
            statusEl.textContent = 'Disconnected';
            statusEl.className = 'disconnected';
        };

        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                packetCount++;

                currentLapNumber = data.lap_count || 1;
                elements.currentLap.textContent = `${currentLapNumber}/${data.total_laps || '--'}`;

                if (currentLapNumber > lastLapNumber && lastLapNumber > 0) {
                    const lastTime = data.last_laptime;
                    if (lastTime > 0) {
                        addLapData(lastLapNumber, lastTime);
                        elements.currentLapTime.textContent = formatLapTime(lastTime);
                    }
                    currentLapData = [];
                }
                lastLapNumber = currentLapNumber;

                currentLapData.push({
                    time: timeCounter,
                    speed: data.speed_kmh || 0,
                    rpm: data.rpm || 0,
                    throttle: data.throttle_pct || 0,
                    brake: data.brake_pct || 0
                });

                if (bestLapData.length > 0 && currentLapData.length > 0) {
                    const idx = Math.min(currentLapData.length - 1, bestLapData.length - 1);
                    const delta = currentLapData[idx].speed - bestLapData[idx].speed;
                    elements.lapDelta.textContent = (delta >= 0 ? '+' : '') + delta.toFixed(1) + ' km/h';
                    elements.lapDelta.className = 'delta-value' + (delta < 0 ? ' negative' : '');
                }

                // 加速度データ更新 (常に更新)
                updateAccelChart(data.accel_g || 0, data.accel_decel || 0);

                // 加速度値をテキスト表示
                const accelG = (data.accel_g || 0).toFixed(2);
                const accelDecel = (data.accel_decel || 0).toFixed(2);
                elements.accelG.textContent = accelG;
                elements.accelDecel.textContent = accelDecel;

                window.timeData.shift();
                window.timeData.push(timeCounter++);

                const speed = Math.round(data.speed_kmh || 0);
                window.speedData.shift();
                window.speedData.push(speed);
                elements.speed.textContent = speed;
                if (speed > maxSpeed) {
                    maxSpeed = speed;
                    elements.maxSpeed.textContent = maxSpeed;
                }

                const gear = data.gear || 0;
                elements.gear.textContent = gear === 0 ? 'R' : gear;

                const rpm = Math.round(data.rpm || 0);
                const maxRpm = data.max_rpm || 9000;
                const rpmPct = Math.min((rpm / maxRpm) * 100, 100);
                window.rpmData.shift();
                window.rpmData.push(rpm);
                elements.rpmBar.style.width = rpmPct + '%';
                elements.rpmText.textContent = rpm + ' RPM';

                const throttle = Math.round(data.throttle_pct || 0);
                const brake = Math.round(data.brake_pct || 0);
                window.throttleData.shift();
                window.throttleData.push(throttle);
                window.brakeData.shift();
                window.brakeData.push(brake);
                elements.throttleBar.style.width = throttle + '%';
                elements.throttleValue.textContent = throttle + '%';
                elements.brakeBar.style.width = brake + '%';
                elements.brakeValue.textContent = brake + '%';

                elements.fuel.textContent = (data.current_fuel || 0).toFixed(1);
                elements.boost.textContent = ((data.boost || 0) * 100).toFixed(0);

                elements.maxX.textContent = (data.position_x || 0).toFixed(1);
                elements.maxY.textContent = (data.position_y || 0).toFixed(1);
                elements.maxZ.textContent = (data.position_z || 0).toFixed(1);

                // Update course map
                if (data.position_x !== undefined && data.position_z !== undefined) {
                    updateCourseMap(
                        data.position_x,
                        data.position_y || 0,
                        data.position_z,
                        data.speed_kmh || 0
                    );
                }

                if (data.susp_height) {
                    elements.flSusp.textContent = (data.susp_height[0] * 1000).toFixed(0);
                    elements.frSusp.textContent = (data.susp_height[1] * 1000).toFixed(0);
                    elements.rlSusp.textContent = (data.susp_height[2] * 1000).toFixed(0);
                    elements.rrSusp.textContent = (data.susp_height[3] * 1000).toFixed(0);
                }

                if (data.tyre_temp) {
                    const temps = data.tyre_temp;
                    elements.flTemp.textContent = Math.round(temps[0]);
                    elements.frTemp.textContent = Math.round(temps[1]);
                    elements.rlTemp.textContent = Math.round(temps[2]);
                    elements.rrTemp.textContent = Math.round(temps[3]);

                    elements.flTemp.style.color = getTyreTempColor(temps[0]);
                    elements.frTemp.style.color = getTyreTempColor(temps[1]);
                    elements.rlTemp.style.color = getTyreTempColor(temps[2]);
                    elements.rrTemp.style.color = getTyreTempColor(temps[3]);
                }

                if (data.tyre_pressure) {
                    const pressures = data.tyre_pressure;
                    elements.flPressure.textContent = (pressures[0] || 0).toFixed(1);
                    elements.frPressure.textContent = (pressures[1] || 0).toFixed(1);
                    elements.rlPressure.textContent = (pressures[2] || 0).toFixed(1);
                    elements.rrPressure.textContent = (pressures[3] || 0).toFixed(1);
                }

                if (data.wheel_rps) {
                    const rps = data.wheel_rps;
                    elements.flRps.textContent = Math.abs(rps[0] || 0).toFixed(1);
                    elements.frRps.textContent = Math.abs(rps[1] || 0).toFixed(1);
                    elements.rlRps.textContent = Math.abs(rps[2] || 0).toFixed(1);
                    elements.rrRps.textContent = Math.abs(rps[3] || 0).toFixed(1);
                }

                if (data.car_id) {
                    elements.carId.textContent = data.car_id;
                }

                elements.packets.textContent = packetCount;

                if (window.speedChart) window.speedChart.setData([window.timeData, window.speedData]);
                if (window.rpmChart) window.rpmChart.setData([window.timeData, window.rpmData]);
                if (window.throttleChart) window.throttleChart.setData([window.timeData, window.throttleData]);
                if (window.brakeChart) window.brakeChart.setData([window.timeData, window.brakeData]);

            } catch (e) {
                console.error('WebSocket message error:', e);
            }
        };
    </script>
</body>
</html>
